<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>mysql 锁机制 | 技术博客，知识分享，学习笔记，问题解决方案</title>
    <meta name="description" content="啊郭的博客">
    <link rel="stylesheet" href="/guo-notes/assets/style.5e0eda6f.css">
    <link rel="modulepreload" href="/guo-notes/assets/app.991e8579.js">
    <link rel="modulepreload" href="/guo-notes/assets/classify_mysql_mysql锁.md.5470bc41.lean.js">
    
    <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance"),a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-c6a644e1><!--[--><!--]--><!--[--><span tabindex="-1" data-v-151f2593></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-151f2593> Skip to content </a><!--]--><!----><header class="VPNav" data-v-c6a644e1 data-v-a71a30f1><div class="VPNavBar has-sidebar" data-v-a71a30f1 data-v-6f1d18b5><div class="container" data-v-6f1d18b5><div class="VPNavBarTitle has-sidebar" data-v-6f1d18b5 data-v-d5925166><a class="title" href="/guo-notes/" data-v-d5925166><!--[--><!--]--><!----><!--[-->啊郭的博客<!--]--><!--[--><!--]--></a></div><div class="content" data-v-6f1d18b5><!--[--><!--]--><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-6f1d18b5 data-v-f83db6ba><span id="main-nav-aria-label" class="visually-hidden" data-v-f83db6ba>Main Navigation</span><!--[--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-f83db6ba data-v-6ffb57d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-6ffb57d3><span class="text" data-v-6ffb57d3><!----> 后端技术 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-6ffb57d3><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-6ffb57d3><div class="VPMenu" data-v-6ffb57d3 data-v-1c5d0cfc><div class="items" data-v-1c5d0cfc><!--[--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/redis/redis%E4%BB%8B%E7%BB%8D.html" data-v-e8e0fb1d data-v-3c355974><!--[-->Redis<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/mysql/mysql%E4%BB%8B%E7%BB%8D.html" data-v-e8e0fb1d data-v-3c355974><!--[-->Mysql<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/RabbitMq/MQ%E7%9A%84%E6%A6%82%E5%BF%B5.html" data-v-e8e0fb1d data-v-3c355974><!--[-->RabbitMq<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-f83db6ba data-v-6ffb57d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-6ffb57d3><span class="text" data-v-6ffb57d3><!----> 计算机基础 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-6ffb57d3><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-6ffb57d3><div class="VPMenu" data-v-6ffb57d3 data-v-1c5d0cfc><div class="items" data-v-1c5d0cfc><!--[--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/计算机基础/计算机网络/" data-v-e8e0fb1d data-v-3c355974><!--[-->计算机网络<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/guo-notes/classify/algorithm/" data-v-f83db6ba data-v-47a2263e data-v-3c355974><!--[-->算法<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-6f1d18b5 data-v-a3e7452b><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-a3e7452b data-v-1899cd41 data-v-086e8519><span class="check" data-v-086e8519><span class="icon" data-v-086e8519><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-1899cd41><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-1899cd41><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-6f1d18b5 data-v-738bef5a data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/gyh-up?tab=repositories" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink" href="https://blog.csdn.net/weixin_42258523?spm=1000.2115.3001.5343" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><embed src="https://g.csdnimg.cn/static/logo/favicon32.ico" style="border-radius: 100%;width: 20px;height: 20px;" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-6f1d18b5 data-v-e4361c82 data-v-6ffb57d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-6ffb57d3><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-6ffb57d3><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-6ffb57d3><div class="VPMenu" data-v-6ffb57d3 data-v-1c5d0cfc><!----><!--[--><!--[--><!----><div class="group" data-v-e4361c82><div class="item appearance" data-v-e4361c82><p class="label" data-v-e4361c82>Appearance</p><div class="appearance-action" data-v-e4361c82><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-e4361c82 data-v-1899cd41 data-v-086e8519><span class="check" data-v-086e8519><span class="icon" data-v-086e8519><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-1899cd41><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-1899cd41><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-e4361c82><div class="item social-links" data-v-e4361c82><div class="VPSocialLinks social-links-list" data-v-e4361c82 data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/gyh-up?tab=repositories" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink" href="https://blog.csdn.net/weixin_42258523?spm=1000.2115.3001.5343" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><embed src="https://g.csdnimg.cn/static/logo/favicon32.ico" style="border-radius: 100%;width: 20px;height: 20px;" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6f1d18b5 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-c6a644e1 data-v-aac27d5e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-aac27d5e><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-aac27d5e><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-aac27d5e>Menu</span></button><a class="top-link" href="#" data-v-aac27d5e> Return to top </a></div><aside class="VPSidebar" data-v-c6a644e1 data-v-f332cb62><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-f332cb62><span class="visually-hidden" id="sidebar-aria-label" data-v-f332cb62> Sidebar Navigation </span><!--[--><div class="group" data-v-f332cb62><section class="VPSidebarGroup collapsible" data-v-f332cb62 data-v-35f99ef5><div class="title" role="button" data-v-35f99ef5><h2 class="title-text" data-v-35f99ef5>Mysql 学习笔记</h2><div class="action" data-v-35f99ef5><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-35f99ef5><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-35f99ef5><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-35f99ef5><!--[--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E4%BB%8B%E7%BB%8D.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>一、mysql介绍</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E8%AF%AD%E6%B3%95.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>二、mysql语法</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/%E7%AE%A1%E7%90%86%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>三、管理常用工具</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/%E7%89%A9%E7%90%86%E6%96%87%E4%BB%B6.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>四、物理文件</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>五、存储引擎</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/sql%E8%AF%AD%E5%8F%A5%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>六、sql语句执行流程</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/sql%E8%AF%AD%E5%8F%A5%E4%BC%98%E5%8C%96.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>七、sql语句优化</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>八、性能分析</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E7%B4%A2%E5%BC%95.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>九、索引</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link active" href="/guo-notes/classify/mysql/mysql%E9%94%81.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十、锁</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E4%BA%8B%E5%8A%A1.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十一、事务</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/MVCC%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十二、MVCC多版本并发控制</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E4%B8%89%E5%A4%A7%E6%97%A5%E5%BF%97.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十三、三大日志</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E5%88%86%E5%8C%BA.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十四、mysql分区</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十五、mysql分库分表</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十六、mysql主从复制</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十七、mysql读写分离</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十八、mysql负载均衡和高可用</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-c6a644e1 data-v-c95df128><div class="VPDoc has-sidebar has-aside" data-v-c95df128 data-v-37ebe389><div class="container" data-v-37ebe389><div class="aside" data-v-37ebe389><div class="aside-curtain" data-v-37ebe389></div><div class="aside-container" data-v-37ebe389><div class="aside-content" data-v-37ebe389><div class="VPDocAside" data-v-37ebe389 data-v-afc4c1a1><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-afc4c1a1 data-v-2865c0b0><div class="content" data-v-2865c0b0><div class="outline-marker" data-v-2865c0b0></div><div class="outline-title" data-v-2865c0b0>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-2865c0b0><span class="visually-hidden" id="doc-outline-aria-label" data-v-2865c0b0> Table of Contents for current page </span><ul class="root" data-v-2865c0b0 data-v-1188541a><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-afc4c1a1></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-37ebe389><div class="content-container" data-v-37ebe389><!--[--><!--]--><main class="main" data-v-37ebe389><div style="position:relative;" class="vp-doc _guo-notes_classify_mysql_mysql%E9%94%81" data-v-37ebe389><div><h1 id="mysql-锁机制" tabindex="-1">mysql 锁机制 <a class="header-anchor" href="#mysql-锁机制" aria-hidden="true">#</a></h1><h2 id="一、概念" tabindex="-1">一、概念 <a class="header-anchor" href="#一、概念" aria-hidden="true">#</a></h2><p>在开发多用户、数据库驱动的应用时，相当大的一个难点就是解决并发性的问题，目前比较常用的解决方案就是锁机制。</p><p>数据库锁定机制简单来说，就是<strong>数据库为了保证数据的一致性，而使各种共享资源在被并发访问变得有序所设计的一种规则</strong>。</p><p>MySQL数据库由于其自身架构的特点，存在多种数据存储引擎，每种存储引擎的锁定机制都是为各自所面对的特定场景而优化设计，所以各存储引擎的锁定机制也有较大区别。</p><h2 id="二、锁粒度" tabindex="-1">二、锁粒度 <a class="header-anchor" href="#二、锁粒度" aria-hidden="true">#</a></h2><h2 id="_1、全局锁" tabindex="-1">1、全局锁 <a class="header-anchor" href="#_1、全局锁" aria-hidden="true">#</a></h2><p>全局锁就是对整个数据库实例加锁，加锁后整个实例就处于只读状态，其典型的使用场景是做全库的逻辑被封，对所有的表进行锁定，从而获取一致性视图，保证数据的完整性。</p><p><img src="/guo-notes/mysql/image-20230308185751019.png" alt="image-20230308185751019"></p><p>特点：</p><p>数据库中加全局锁，是一个比较重的操作，存在一下问题：</p><p><strong>1、如果在主库上备份，那么在备份期间都不能执行更新，业务基本上就得停摆；</strong></p><p><strong>2、如果在从库上备份，那么在备份期间从库不能执行主库同步过来的二进制日志，会导致主从延迟；</strong></p><p>在 innodb 引擎中，我们可以在备份时加上参数 <code>--single-transaction</code> 参数来完成一份不加锁的一致性数据备份，实际就是通过快照读来实现的。</p><div class="language-sql line-numbers-mode"><button class="copy"></button><span class="lang">sql</span><pre><code><span class="line"><span style="color:#A6ACCD;">mysqldump </span><span style="color:#676E95;">--single-transaction -u root -p 123456 itcast &gt; itcast.sql</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_2、表级锁" tabindex="-1">2、表级锁 <a class="header-anchor" href="#_2、表级锁" aria-hidden="true">#</a></h2><p>直接锁住的是一个表，开销小，加锁快，不会出现死锁的情况，锁定粒度最大，发生锁冲突的概率更高，并发度最低。使用表级锁定的主要是MyISAM，MEMORY，CSV等一些非事务性存储引擎。</p><h2 id="_3、行级锁" tabindex="-1">3、行级锁 <a class="header-anchor" href="#_3、行级锁" aria-hidden="true">#</a></h2><p>行级锁定最大的特点就是<strong>锁定对象的颗粒度很小</strong>，它直接锁住的是一条记录，发生锁冲突的概率较低，能够给予应用程序尽可能大的并发处理能力而提高一些需要高并发应用系统的整体性能。</p><p><strong>由于锁定资源的颗粒度很小，所以每次获取锁和释放锁需要做的事情也更多，带来的消耗自然也就更大了。此外，行级锁定也最容易发生死锁</strong>。</p><p><strong>InnoDB 存储引擎既支持行级锁，也支持表级锁，默认情况下使用行级锁。</strong></p><h2 id="_4、页级锁" tabindex="-1">4、页级锁 <a class="header-anchor" href="#_4、页级锁" aria-hidden="true">#</a></h2><p>页级锁是 MySQL 中比较独特的一种锁定级别。它是锁住的一个页面，在 InnoDB 中一个页面为16KB，它的开销介于表级锁和行级锁中间，也可能会出现死锁，锁定粒度也介于表级锁和行级锁中间，并发度也介于表级锁和行级锁中间。</p><p><strong>BDB 引擎使用的是页级锁，也支持表级锁。由于 BDB 引擎基本已经成为历史，因此就不再介绍了。</strong></p><h2 id="_5、总结" tabindex="-1">5、总结 <a class="header-anchor" href="#_5、总结" aria-hidden="true">#</a></h2><p>仅仅从锁的角度来说，表级锁更加适合于以查询为主的应用，只有少量按照索引条件更新数据的应用，比如大多数的 web 应用。</p><p>行级锁更适合大量按照索引条件并发更新少量不同的数据，同时还有并发查询的应用，比如一些在线事务处理系统，即 OLTP。</p><h2 id="三、表级锁" tabindex="-1">三、表级锁 <a class="header-anchor" href="#三、表级锁" aria-hidden="true">#</a></h2><h2 id="_1、表锁" tabindex="-1">1、表锁 <a class="header-anchor" href="#_1、表锁" aria-hidden="true">#</a></h2><p>对于表锁，分为两类：</p><ol><li><p>表共享读锁（read lock）</p><p>例：客户端 A 对表加表共享读锁，则客户端 A 可以对该表进行读操作，但是不能进行写操作，写操作会报错；其他客户端可以对该表进行读操作，不能进行写操作，写操作会阻塞。</p></li><li><p>表独占写锁（write lock）</p><p>例：客户端 A 对表加表独占写锁，则客户端 A 可以对该表进行读和写操作；其他客户端不能对该表进行读和写操作，读和写操作会阻塞。</p></li></ol><p>语法：</p><ol><li>加锁：lock tables 表名... read/write</li><li>释放锁：unlock tables 或者 断开客户端连接</li></ol><blockquote><p>具体演示可参考 <a href="https://www.bilibili.com/video/BV1Kr4y1i7ru?p=124" target="_blank" rel="noreferrer">https://www.bilibili.com/video/BV1Kr4y1i7ru?p=124</a></p></blockquote><h2 id="_2、元数据锁（meta-data-lock，mdl）" tabindex="-1">2、元数据锁（meta data lock，MDL） <a class="header-anchor" href="#_2、元数据锁（meta-data-lock，mdl）" aria-hidden="true">#</a></h2><p>MDL 加锁过程是系统自动控制的，无需显式使用，在访问一张表的时候会自动加上。MDL 锁主要作用是维护表元数据的数据一致性，在表上有活动事务的时候，不可以对元数据进行写入操作。</p><p><strong>为了避免 DML 和 DDL 冲突，保证读写的正确性。</strong></p><p><strong>为了避免 DML 和 DDL 冲突，保证读写的正确性。</strong></p><p><strong>为了避免 DML 和 DDL 冲突，保证读写的正确性。</strong></p><p>在 MYSQL5.5 中引入了 MDL，当对一张表进行增删改查的时候，加 MDL 读锁（共享）；当对表结构进行表更操作的时候，加 MDL 写锁（排他）。</p><p><img src="/guo-notes/mysql/image-20230308235145911.png" alt="image-20230308235145911"></p><blockquote><p>具体演示可参考 <a href="https://www.bilibili.com/video/BV1Kr4y1i7ru?p=125" target="_blank" rel="noreferrer">https://www.bilibili.com/video/BV1Kr4y1i7ru?p=125</a></p></blockquote><div class="language-sql line-numbers-mode"><button class="copy"></button><span class="lang">sql</span><pre><code><span class="line"><span style="color:#676E95;">-- 查看元数据锁</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> object_type,object_schema,</span><span style="color:#82AAFF;">object_name</span><span style="color:#A6ACCD;">,lock_type.lock_duration </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> performance_schema.metadata_locks</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="_3、意向锁-intention-locks" tabindex="-1">3、意向锁(Intention Locks) <a class="header-anchor" href="#_3、意向锁-intention-locks" aria-hidden="true">#</a></h2><p>意向锁是由数据库自己维护的，一般来说，当给一行数据加上共享锁之前，数据库会自动在这张表上面加一个<code>意向共享锁(IS锁)</code>；当给一行数据加上排他锁之前，数据库会自动在这张表上面加一个<code>意向排他锁(IX锁)</code>。</p><p><strong>意向锁可以认为是 <code>S锁</code> 和 <code>X锁</code> 在数据表上的标识，通过意向锁可以快速判断表中是否有记录被上锁，从而避免通过遍历的方式来查看表中有没有记录被上锁，提升加锁效率，减少表锁的检查</strong>。</p><p>例如，我们要加表级别的<code>X锁</code>，这时候数据表里面如果存在行级别的<code>X锁</code>或者<code>S锁</code>的，加锁就会失败，此时直接根据意向锁就能知道这张表是否有行级别的<code>X锁</code>或者<code>S锁</code>。</p><p>意向锁是在 InnoDB 下存在的内部锁，对于MyISAM 而言 没有意向锁之说。</p><p>分为两类：</p><ol><li>意向共享锁（IS）：由语句 <code>select ... lock in share mode;</code> 添加</li><li>意向排它锁（IX）：由语句 <code>insert、update、delete、select ... for update</code> 添加</li></ol><p>兼容性：</p><ol><li><strong>意向共享锁（IS）：与表锁共享锁（read）兼容，与表锁排它锁（write）互斥。</strong></li><li><strong>意向排它锁（IX）：与表锁共享锁（read）兼容及表锁排它锁（write）互斥。意向锁之间不会互斥。</strong></li></ol><div class="language-sql line-numbers-mode"><button class="copy"></button><span class="lang">sql</span><pre><code><span class="line"><span style="color:#676E95;">-- 查看意向锁及行锁加锁情况</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> object_schema,</span><span style="color:#82AAFF;">object_name</span><span style="color:#A6ACCD;">,index_name,lock_type.lock_mode,lock_data </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> performance_schema.data_locks</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="四、行级锁" tabindex="-1">四、行级锁 <a class="header-anchor" href="#四、行级锁" aria-hidden="true">#</a></h2><p><strong><code>InnoDB</code>的行级锁，是通过锁住索引来实现的，如果加锁查询的时候没有使用过索引，会将整个聚簇索引都锁住，相当于锁表了</strong>。<strong>根据锁定范围的不同，行锁可以使用<code>记录锁(Record Locks)</code>、<code>间隙锁(Gap Locks)</code>和<code>临键锁(Next-Key Locks)</code>的方式实现。</strong></p><p>假设现在有一张表<code>t</code>，主键是<code>id</code>。我们插入了4行数据，主键值分别是 1、4、7、10。接下来我们就以聚簇索引为例，具体介绍三种形式的行锁。</p><table><thead><tr><th style="text-align:center;">id（唯一索引）</th><th style="text-align:center;">age（普通索引）</th><th style="text-align:center;">name（无索引）</th></tr></thead><tbody><tr><td style="text-align:center;">1</td><td style="text-align:center;">10</td><td style="text-align:center;">刘备</td></tr><tr><td style="text-align:center;">4</td><td style="text-align:center;">20</td><td style="text-align:center;">关羽</td></tr><tr><td style="text-align:center;">7</td><td style="text-align:center;">30</td><td style="text-align:center;">张飞</td></tr><tr><td style="text-align:center;">10</td><td style="text-align:center;">40</td><td style="text-align:center;">赵云</td></tr></tbody></table><h2 id="_1、行锁-记录锁（record-lock）" tabindex="-1">1、行锁/记录锁（Record Lock） <a class="header-anchor" href="#_1、行锁-记录锁（record-lock）" aria-hidden="true">#</a></h2><p>锁定单个行记录的锁，防止其他事务对此行进行 update 和 delete，在 RC 和 RR 隔离级别下支持。</p><p>innodb 实现了以下两种类型的行锁：</p><ol><li>共享锁（S）：允许一个事务去读一行，阻止其他事务获得相同数据集的排它锁。</li><li>排它锁（X）：允许获取排它锁的事务更新数据，阻止其他事务获得相同数据集的共享锁和排它锁。</li></ol><p><img src="/guo-notes/mysql/image-20230309105732334.png" alt="image-20230309105732334"></p><p><img src="/guo-notes/mysql/image-20230309105753733.png" alt="image-20230309105753733"></p><p>默认情况下，innodb 在 RR 事务隔离级别运行，innodb 使用 next-key 进行搜索和索引扫描，以防止幻读。</p><ol><li><strong>针对唯一索引进行检索时</strong>，对已经存在的数据进行等值匹配时，将会自动优化为行锁。</li><li>innodb 的行锁是针对于索引加的锁，不通过索引条件检索数据，那么 innodb 将对表中的所有记录加锁，此时 <strong>就会升级为表锁</strong>。</li></ol><div class="language-sql line-numbers-mode"><button class="copy"></button><span class="lang">sql</span><pre><code><span class="line"><span style="color:#676E95;">-- 加共享锁</span></span>
<span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> t </span><span style="color:#F78C6C;">where</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;"> lock </span><span style="color:#F78C6C;">in</span><span style="color:#A6ACCD;"> share mode; </span></span>
<span class="line"><span style="color:#676E95;">-- 加排它锁</span></span>
<span class="line"><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> age </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>id 列必须为唯一索引列或主键列</strong>，否则上述语句加的锁就会变成临键锁。</p><h2 id="_2、间隙锁-gap-locks" tabindex="-1">2、间隙锁(Gap Locks) <a class="header-anchor" href="#_2、间隙锁-gap-locks" aria-hidden="true">#</a></h2><p>锁定索引记录间隙（不含该记录），确保索引记录间隙不变，防止其他事务在这个间隙进行 insert，产生幻读，在 RR 隔离级别下支持。间隙锁可以共存，一个事务采用的间隙锁不会阻止另一个事务在同一间隙上采用间隙锁。</p><p>默认情况下，innodb 在 RR 事务隔离级别运行，innodb 使用 next-key 进行搜索和索引扫描，以防止幻读。</p><ol><li>索引上的等值查询（唯一索引），给不存在的记录加锁时，加间隙锁。</li><li>索引上的等值查询（普通索引），向右遍历时最后一个值不满足查询需求时，加间隙锁。</li><li>索引上的范围查询（唯一索引），会访问到不满足条件的第一个值为止，加间隙锁。</li></ol><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">-- 加间隙锁，锁住id（2,3）</span></span>
<span class="line"><span style="color:#A6ACCD;">select * from t where id = 2 lock in share mode; </span></span>
<span class="line"><span style="color:#A6ACCD;">-- 加间隙锁，锁住age（20,30）;加间隙锁，锁住age（10,20）;加行锁 age = 20；</span></span>
<span class="line"><span style="color:#A6ACCD;">-- 加一起实际上就是临键锁</span></span>
<span class="line"><span style="color:#A6ACCD;">UPDATE SET name = &quot;马超&quot; WHERE age = 20;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_3、临键锁-next-key-locks" tabindex="-1">3、临键锁(Next-Key Locks) <a class="header-anchor" href="#_3、临键锁-next-key-locks" aria-hidden="true">#</a></h2><p>记录锁和间隙锁的结合，同时锁住数据，还要再锁住索引之间的间隙，在 RR 隔离级别下支持。</p><p><strong>当我们使用范围查询，并且命中了部分记录，此时锁住的就是临键区间。</strong></p><p>mysql默认行锁类型就是 <code>临键锁(Next-Key Locks)</code>。当使用唯一性索引，等值查询匹配到一条记录的时候，临键锁(Next-Key Locks)会退化成记录锁；没有匹配到任何记录的时候，退化成间隙锁。</p><p><code>间隙锁(Gap Locks)</code>和<code>临键锁(Next-Key Locks)</code>都是用来解决幻读问题的，在<code>已提交读（READ COMMITTED）</code>隔离级别下，<code>间隙锁(Gap Locks)</code>和<code>临键锁(Next-Key Locks)</code>都会失效！</p><h2 id="_4、总结" tabindex="-1">4、总结 <a class="header-anchor" href="#_4、总结" aria-hidden="true">#</a></h2><p>1、当使用唯一索引来等值查询的语句时, 如果这行数据存在，不产生间隙锁，而是记录锁。</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">select * from t where id = 1; // 锁住 id = 1 的记录，记录锁</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>2、当使用唯一索引来等值查询的语句时, 如果这行数据不存在，会产生间隙锁。</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">select * from t where id = 3 for update; // 锁住（1，4），间隙锁</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>3、<strong>当使用唯一索引来范围查询的语句时，对于满足查询条件但不存在的数据产生间隙(gap)锁，如果查询存在的记录就会产生记录锁，加在一起就是临键锁(next-key)。</strong></p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">select * from t where id &gt; 10 for update; // 锁住（10，+∞），间隙锁</span></span>
<span class="line"><span style="color:#A6ACCD;">select * from t where id &gt;= 10 for update; // 会锁住[10，+∞），临键锁</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>4、当使用普通索引不管是锁住单条，还是多条记录，都会产生间隙锁；</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">select * from t where age = 4 for update; // 锁住(1,4]和(4,7],临键锁</span></span>
<span class="line"><span style="color:#A6ACCD;">select * from t where age = 5 for update; // 锁住(1,4)和(4,7)，间隙锁</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>5、在没有索引上不管是锁住单条，还是多条记录，都会产生表锁；</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">select * from t where name = &#39;关羽&#39; for update; // 表锁</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="五、死锁的产生与处理" tabindex="-1">五、死锁的产生与处理 <a class="header-anchor" href="#五、死锁的产生与处理" aria-hidden="true">#</a></h2><h2 id="_1、死锁产生的原因" tabindex="-1">1、死锁产生的原因 <a class="header-anchor" href="#_1、死锁产生的原因" aria-hidden="true">#</a></h2><p>所谓死锁 <code>&lt;DeadLock&gt;</code>：是指两个或两个以上的进程在执行过程中，因争夺资源而造成的一种互相等待的现象,若无外力作用，它们都将无法推进下去。此时称系统处于死锁状态或系统产生了死锁，这些永远在互相等待的进程称为死锁进程。表级锁不会产生死锁，所以解决死锁主要还是针对于最常用的InnoDB。</p><p><strong>死锁的关键在于：两个(或以上)的Session加锁的顺序不一致。</strong></p><p><strong>那么对应的解决死锁问题的关键就是：让不同的session加锁有次序</strong></p><p>死锁是数据库对事务的保护机制，一旦发生死锁，MySQL 会选择<strong>相对小的事务(undo较少的)进行回滚</strong>。</p><h2 id="_2、死锁产生示例" tabindex="-1">2、死锁产生示例 <a class="header-anchor" href="#_2、死锁产生示例" aria-hidden="true">#</a></h2><p>事务1事务2分别对id为1与id为2的数据进行排它锁加锁，随后进行交叉的数据修改。</p><table><thead><tr><th>事务运行顺序</th><th>事务1</th><th>事务2</th></tr></thead><tbody><tr><td>①</td><td>begin;</td><td>begin;</td></tr><tr><td>②</td><td>select * from user where id = 1 for update;</td><td>select * from user where id = 2 for update;</td></tr><tr><td>③</td><td>update user set username = &#39;shine York&#39; where id =2;</td><td>update user set username = &#39;starsky&#39; where id =1;</td></tr><tr><td>④</td><td>commit</td><td>commit</td></tr></tbody></table><p>运行结果：</p><p><img src="/guo-notes/mysql/mysql-29.png" alt="image-20210830145907986"></p><h2 id="_3、尽可能的避免事务死锁" tabindex="-1">3、尽可能的避免事务死锁 <a class="header-anchor" href="#_3、尽可能的避免事务死锁" aria-hidden="true">#</a></h2><p>1）不同的应用访问同一组表时，应尽量约定以相同的顺序访问各表。对一个表而言，应尽量以固定的顺序存取表中的行。</p><p>2）在主键等值更新的时候，尽量先查询看数据库中有没有满足条件的数据，如果不存在就不用更新，存在才更新。避免产生间隙锁。</p><p>3）大事务拆小。大事务更倾向于死锁，如果业务允许，将大事务拆小。</p><p>4）尽量使用主键更新数据,因为主键是唯一索引，在等值查询能查到数据的情况下只会产生行锁，不会产生间隙锁，这样产生死锁的概率就减少了。当然如果是范围查询，一样会产生间隙锁。</p><p>5）降低隔离级别。如果业务允许，将隔离级别调低也是较好的选择，比如将隔离级别从RR调整为RC，可以避免掉很多因为gap锁造成的死锁。</p><p>6）<strong>为表添加合理的索引。可以看到如果不走索引将会为表的每一行记录添加上锁，死锁的概率大大增大。</strong></p><h2 id="六、乐观锁与悲观锁" tabindex="-1">六、乐观锁与悲观锁 <a class="header-anchor" href="#六、乐观锁与悲观锁" aria-hidden="true">#</a></h2><p><strong>乐观锁与悲观锁 是指实现锁机制的一个概念，是一种实现逻辑，不是具体的锁。</strong></p><p>悲观锁（Pessimistic Lock），顾名思义，就是很悲观，每次去拿数据的时候都认为别人会修改，<strong>所以每次在拿数据的时候都会上锁，</strong> 这样别人想拿这个数据就会block直到它拿到锁。传统的关系型数据库里边就用到了很多这种锁机制，比如行锁，表锁等，读锁，写锁等，都是在做操作之前先上锁。</p><p>乐观锁（Optimistic Lock），顾名思义，就是很乐观，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，可以使用版本号等机制。乐观锁适用于多读的应用类型，这样可以提高吞吐量，像数据库如果提供类似于 write_condition 机制的其实都是提供的乐观锁。</p></div></div></main><!--[--><!--]--><footer class="VPDocFooter" data-v-37ebe389 data-v-a54a85bd><div class="edit-info" data-v-a54a85bd><!----><div class="last-updated" data-v-a54a85bd><p class="VPLastUpdated" data-v-a54a85bd data-v-f7d51a9c>Last updated: <time datatime="2023-03-14T11:05:17.000Z" data-v-f7d51a9c></time></p></div></div><div class="prev-next" data-v-a54a85bd><div class="pager" data-v-a54a85bd><a class="pager-link prev" href="/guo-notes/classify/mysql/mysql%E7%B4%A2%E5%BC%95.html" data-v-a54a85bd><span class="desc" data-v-a54a85bd>Previous page</span><span class="title" data-v-a54a85bd>九、索引</span></a></div><div class="has-prev pager" data-v-a54a85bd><a class="pager-link next" href="/guo-notes/classify/mysql/mysql%E4%BA%8B%E5%8A%A1.html" data-v-a54a85bd><span class="desc" data-v-a54a85bd>Next page</span><span class="title" data-v-a54a85bd>十一、事务</span></a></div></div></footer><!--[--><!--]--></div></div></div></div></div><!----><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"classify_rabbitmq_exchange核心概念.md\":\"35e6b8b9\",\"classify_rabbitmq_mq的概念.md\":\"1542edba\",\"classify_rabbitmq_mq的种类和对比.md\":\"d772f65c\",\"classify_rabbitmq_rabbitmq命令行.md\":\"135cf4fc\",\"classify_rabbitmq_rabbitmq工作模式.md\":\"eaabfd00\",\"classify_rabbitmq_rabbitmq应用方案.md\":\"6f0867d8\",\"classify_rabbitmq_rabbitmq的安装和启动.md\":\"5bac96d8\",\"classify_rabbitmq_rabbitmq简介.md\":\"d94be1e0\",\"classify_rabbitmq_rabbitmq管控台介绍.md\":\"847827ea\",\"classify_rabbitmq_rabbitmq高级特性.md\":\"e4bd37df\",\"classify_rabbitmq_rabbitmq高级特性1.md\":\"5a5962e1\",\"classify_redis_redis主从.md\":\"d9f85e63\",\"classify_redis_redis事务.md\":\"0316cb01\",\"classify_redis_redis五大数据类型实现原理.md\":\"6de66d24\",\"classify_redis_redis介绍.md\":\"58a2c805\",\"classify_redis_redis内存回收.md\":\"8e7ce81e\",\"classify_redis_redis内存淘汰策略.md\":\"d0c8d877\",\"classify_redis_redis内存碎片率.md\":\"db86c5ea\",\"classify_redis_redis分布式锁.md\":\"a4113245\",\"classify_redis_redis哨兵.md\":\"9f74d4b2\",\"classify_redis_redis底层数据结构.md\":\"9b579b06\",\"classify_redis_redis慢查询和管道.md\":\"11fb9c4c\",\"classify_redis_redis持久化.md\":\"76430a16\",\"classify_redis_redis数据类型简介.md\":\"31618846\",\"classify_redis_redis缓存击穿、穿透、雪崩.md\":\"2012ec9c\",\"classify_redis_redis配置文件解析.md\":\"1d8f4ba7\",\"classify_redis_redis集群.md\":\"630d7e68\",\"classify_algorithm_concept_复杂度-时间复杂度和空间复杂度.md\":\"78dbdcd0\",\"classify_algorithm_concept_数据结构-堆.md\":\"14a78765\",\"classify_algorithm_concept_数据结构-栈与队列.md\":\"6bf935a9\",\"classify_algorithm_concept_数据结构-树.md\":\"9995f977\",\"classify_algorithm_concept_算法-排序算法.md\":\"8cfe5984\",\"classify_algorithm_concept_算法-查找算法.md\":\"df304535\",\"classify_algorithm_concept_算法-深度优先搜索和广度优先搜索.md\":\"0979f32e\",\"classify_algorithm_index.md\":\"947d60e4\",\"classify_algorithm_title_leetcode-1.md\":\"13e06c08\",\"classify_algorithm_title_leetcode-101.md\":\"90132690\",\"classify_algorithm_title_leetcode-104.md\":\"70fcddcb\",\"classify_algorithm_title_leetcode-110.md\":\"3d04a413\",\"classify_algorithm_title_leetcode-141.md\":\"2ddce3d8\",\"classify_algorithm_title_leetcode-142.md\":\"7c17a9df\",\"classify_algorithm_title_leetcode-144.md\":\"c3ee202b\",\"classify_algorithm_title_leetcode-145.md\":\"cb106181\",\"classify_algorithm_title_leetcode-160.md\":\"f8c550b6\",\"classify_algorithm_title_leetcode-206.md\":\"d687f2d6\",\"classify_algorithm_title_leetcode-21.md\":\"c87d4609\",\"classify_algorithm_title_leetcode-226.md\":\"6be37586\",\"classify_algorithm_title_leetcode-232.md\":\"216d2fc7\",\"classify_algorithm_title_leetcode-234.md\":\"09c22929\",\"classify_algorithm_title_leetcode-283.md\":\"bc282227\",\"classify_algorithm_title_leetcode-394.md\":\"265087c1\",\"classify_algorithm_title_leetcode-448.md\":\"32b5c564\",\"classify_algorithm_title_leetcode-70.md\":\"ccaeadc2\",\"classify_algorithm_title_leetcode-83.md\":\"77ca5bd3\",\"classify_algorithm_title_leetcode-876.md\":\"eb4bdce9\",\"classify_algorithm_title_leetcode-88.md\":\"6b4f0c7b\",\"classify_algorithm_title_leetcode-912.md\":\"77c8fd1d\",\"classify_algorithm_title_leetcode-94.md\":\"8a28db6a\",\"classify_algorithm_title_leetcode-模板.md\":\"c0d869f6\",\"classify_algorithm_title_剑指offer-22.md\":\"0fbdcfc6\",\"classify_algorithm_其他-设计.md\":\"c9fa3d60\",\"classify_algorithm_基础-排序.md\":\"eb2ada83\",\"classify_algorithm_基础数据结构-哈希表.md\":\"a051342b\",\"classify_algorithm_基础数据结构-字符串.md\":\"e8cae410\",\"classify_algorithm_基础数据结构-数组.md\":\"2cabc4ff\",\"classify_algorithm_基础数据结构-栈.md\":\"55ce8154\",\"classify_algorithm_基础数据结构-树.md\":\"4fba2992\",\"classify_algorithm_基础数据结构-链表.md\":\"fc6aaf64\",\"classify_algorithm_基础数据结构-队列.md\":\"11d5244b\",\"classify_algorithm_技巧-双指针.md\":\"c76c0b18\",\"classify_algorithm_数学-斐波那契数列.md\":\"e21ef8df\",\"classify_algorithm_数学-相遇问题.md\":\"2b01d99b\",\"classify_algorithm_算法-动态规划.md\":\"9ca9953b\",\"classify_algorithm_算法-广度优先搜索.md\":\"b5c771ea\",\"classify_algorithm_算法-排序.md\":\"5b11e326\",\"classify_algorithm_算法-深度优先搜索.md\":\"b8d9787a\",\"classify_algorithm_算法-迭代.md\":\"dd6a9f54\",\"classify_algorithm_算法-递归.md\":\"85496316\",\"classify_mysql_mvcc多版本并发控制.md\":\"d9af3204\",\"classify_mysql_mysql三大日志.md\":\"f38e70b3\",\"classify_mysql_mysql主从复制.md\":\"a7ab6a40\",\"classify_mysql_mysql事务.md\":\"1955e6c9\",\"classify_mysql_mysql介绍.md\":\"f31f8933\",\"classify_mysql_mysql分区.md\":\"44027cfa\",\"classify_mysql_mysql分库分表.md\":\"cf1e5b5b\",\"classify_mysql_mysql索引.md\":\"b53d7f53\",\"classify_mysql_mysql语法.md\":\"ee2fa2de\",\"classify_mysql_mysql读写分离.md\":\"c3a9dad3\",\"classify_mysql_mysql负载均衡和高可用.md\":\"a9e4b06f\",\"classify_mysql_mysql锁.md\":\"5470bc41\",\"classify_mysql_sql语句优化.md\":\"366e2b2e\",\"classify_mysql_sql语句执行流程.md\":\"5615759d\",\"classify_mysql_存储引擎.md\":\"bbeb6ddd\",\"classify_mysql_性能分析.md\":\"9df237e9\",\"classify_mysql_物理文件.md\":\"3f87a6b0\",\"classify_mysql_管理常用工具.md\":\"c5607a25\",\"classify_sundry_tools_git_github 连接失败.md\":\"5170410d\",\"classify_sundry_tools_vscode_vscode 启动 debug.md\":\"d9fea741\",\"classify_框架学习_laravel_artisan控制台命令.md\":\"5b9aecab\",\"classify_框架学习_laravel_生命周期相关核心概念.md\":\"5138be10\",\"classify_解决方案_redis主从存在的问题和解决方案.md\":\"d5c9d501\",\"classify_解决方案_数据库与缓存一致性解决方案.md\":\"0812f58d\",\"classify_计算机基础_计算机网络_io模型.md\":\"35be020f\",\"classify_计算机基础_计算机网络_index.md\":\"e37f7ab0\",\"index.md\":\"1ba35b2d\",\"preface_install.md\":\"4bf1ae00\",\"preface_preface.md\":\"95e197b6\",\"学习网址.md\":\"6eb5d082\",\"网站常用.md\":\"d829d5e7\"}")</script>
    <script type="module" async src="/guo-notes/assets/app.991e8579.js"></script>
    
  </body>
</html>