<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>mysql负载均衡和高可用 | 技术博客，知识分享，学习笔记，问题解决方案</title>
    <meta name="description" content="啊郭的博客">
    <link rel="stylesheet" href="/guo-notes/assets/style.5e0eda6f.css">
    <link rel="modulepreload" href="/guo-notes/assets/app.c1658bbb.js">
    <link rel="modulepreload" href="/guo-notes/assets/classify_mysql_mysql负载均衡和高可用.md.c7ec40ee.lean.js">
    
    <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance"),a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-c6a644e1><!--[--><!--]--><!--[--><span tabindex="-1" data-v-151f2593></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-151f2593> Skip to content </a><!--]--><!----><header class="VPNav" data-v-c6a644e1 data-v-a71a30f1><div class="VPNavBar has-sidebar" data-v-a71a30f1 data-v-6f1d18b5><div class="container" data-v-6f1d18b5><div class="VPNavBarTitle has-sidebar" data-v-6f1d18b5 data-v-d5925166><a class="title" href="/guo-notes/" data-v-d5925166><!--[--><!--]--><!----><!--[-->啊郭的博客<!--]--><!--[--><!--]--></a></div><div class="content" data-v-6f1d18b5><!--[--><!--]--><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-6f1d18b5 data-v-f83db6ba><span id="main-nav-aria-label" class="visually-hidden" data-v-f83db6ba>Main Navigation</span><!--[--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-f83db6ba data-v-6ffb57d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-6ffb57d3><span class="text" data-v-6ffb57d3><!----> 后端技术 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-6ffb57d3><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-6ffb57d3><div class="VPMenu" data-v-6ffb57d3 data-v-1c5d0cfc><div class="items" data-v-1c5d0cfc><!--[--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/Redis/redis%E4%BB%8B%E7%BB%8D.html" data-v-e8e0fb1d data-v-3c355974><!--[-->Redis<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/mysql/mysql%E4%BB%8B%E7%BB%8D.html" data-v-e8e0fb1d data-v-3c355974><!--[-->Mysql<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/RabbitMQ/MQ%E7%9A%84%E6%A6%82%E5%BF%B5.html" data-v-e8e0fb1d data-v-3c355974><!--[-->RabbitMq<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/Docker/Docker%E4%BB%8B%E7%BB%8D.html" data-v-e8e0fb1d data-v-3c355974><!--[-->Docker<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/Kubernetes/Kubernetes%E4%BB%8B%E7%BB%8D.html" data-v-e8e0fb1d data-v-3c355974><!--[-->Kubernetes<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/Kafka/kafka%E4%BB%8B%E7%BB%8D.html" data-v-e8e0fb1d data-v-3c355974><!--[-->Kafka<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-f83db6ba data-v-6ffb57d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-6ffb57d3><span class="text" data-v-6ffb57d3><!----> 计算机基础 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-6ffb57d3><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-6ffb57d3><div class="VPMenu" data-v-6ffb57d3 data-v-1c5d0cfc><div class="items" data-v-1c5d0cfc><!--[--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/计算机基础/计算机网络/" data-v-e8e0fb1d data-v-3c355974><!--[-->计算机网络<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/guo-notes/classify/algorithm/" data-v-f83db6ba data-v-47a2263e data-v-3c355974><!--[-->算法<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/guo-notes/" data-v-f83db6ba data-v-47a2263e data-v-3c355974><!--[-->解决方案<!--]--><!----></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-f83db6ba data-v-6ffb57d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-6ffb57d3><span class="text" data-v-6ffb57d3><!----> 杂项 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-6ffb57d3><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-6ffb57d3><div class="VPMenu" data-v-6ffb57d3 data-v-1c5d0cfc><div class="items" data-v-1c5d0cfc><!--[--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-6f1d18b5 data-v-a3e7452b><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-a3e7452b data-v-1899cd41 data-v-086e8519><span class="check" data-v-086e8519><span class="icon" data-v-086e8519><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-1899cd41><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-1899cd41><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-6f1d18b5 data-v-738bef5a data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/gyh-up?tab=repositories" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink" href="https://blog.csdn.net/weixin_42258523?spm=1000.2115.3001.5343" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><embed src="https://g.csdnimg.cn/static/logo/favicon32.ico" style="border-radius: 100%;width: 20px;height: 20px;" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-6f1d18b5 data-v-e4361c82 data-v-6ffb57d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-6ffb57d3><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-6ffb57d3><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-6ffb57d3><div class="VPMenu" data-v-6ffb57d3 data-v-1c5d0cfc><!----><!--[--><!--[--><!----><div class="group" data-v-e4361c82><div class="item appearance" data-v-e4361c82><p class="label" data-v-e4361c82>Appearance</p><div class="appearance-action" data-v-e4361c82><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-e4361c82 data-v-1899cd41 data-v-086e8519><span class="check" data-v-086e8519><span class="icon" data-v-086e8519><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-1899cd41><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-1899cd41><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-e4361c82><div class="item social-links" data-v-e4361c82><div class="VPSocialLinks social-links-list" data-v-e4361c82 data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/gyh-up?tab=repositories" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink" href="https://blog.csdn.net/weixin_42258523?spm=1000.2115.3001.5343" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><embed src="https://g.csdnimg.cn/static/logo/favicon32.ico" style="border-radius: 100%;width: 20px;height: 20px;" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6f1d18b5 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-c6a644e1 data-v-aac27d5e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-aac27d5e><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-aac27d5e><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-aac27d5e>Menu</span></button><a class="top-link" href="#" data-v-aac27d5e> Return to top </a></div><aside class="VPSidebar" data-v-c6a644e1 data-v-f332cb62><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-f332cb62><span class="visually-hidden" id="sidebar-aria-label" data-v-f332cb62> Sidebar Navigation </span><!--[--><div class="group" data-v-f332cb62><section class="VPSidebarGroup collapsible" data-v-f332cb62 data-v-35f99ef5><div class="title" role="button" data-v-35f99ef5><h2 class="title-text" data-v-35f99ef5>Mysql 学习笔记</h2><div class="action" data-v-35f99ef5><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-35f99ef5><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-35f99ef5><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-35f99ef5><!--[--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E4%BB%8B%E7%BB%8D.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>一、mysql介绍</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E8%AF%AD%E6%B3%95.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>二、mysql语法</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/%E7%AE%A1%E7%90%86%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>三、管理常用工具</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/%E7%89%A9%E7%90%86%E6%96%87%E4%BB%B6.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>四、物理文件</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>五、存储引擎</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/sql%E8%AF%AD%E5%8F%A5%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>六、sql语句执行流程</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/sql%E8%AF%AD%E5%8F%A5%E4%BC%98%E5%8C%96.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>七、sql语句优化</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>八、性能分析</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E7%B4%A2%E5%BC%95.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>九、索引</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E9%94%81.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十、锁</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E4%BA%8B%E5%8A%A1.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十一、事务</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/MVCC%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十二、MVCC多版本并发控制</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E4%B8%89%E5%A4%A7%E6%97%A5%E5%BF%97.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十三、三大日志</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E5%88%86%E5%8C%BA.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十四、mysql分区</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十五、mysql分库分表</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十六、mysql主从复制</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/mysql/mysql%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十七、mysql读写分离</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link active" href="/guo-notes/classify/mysql/mysql%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十八、mysql负载均衡和高可用</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-c6a644e1 data-v-c95df128><div class="VPDoc has-sidebar has-aside" data-v-c95df128 data-v-37ebe389><div class="container" data-v-37ebe389><div class="aside" data-v-37ebe389><div class="aside-curtain" data-v-37ebe389></div><div class="aside-container" data-v-37ebe389><div class="aside-content" data-v-37ebe389><div class="VPDocAside" data-v-37ebe389 data-v-afc4c1a1><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-afc4c1a1 data-v-2865c0b0><div class="content" data-v-2865c0b0><div class="outline-marker" data-v-2865c0b0></div><div class="outline-title" data-v-2865c0b0>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-2865c0b0><span class="visually-hidden" id="doc-outline-aria-label" data-v-2865c0b0> Table of Contents for current page </span><ul class="root" data-v-2865c0b0 data-v-1188541a><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-afc4c1a1></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-37ebe389><div class="content-container" data-v-37ebe389><!--[--><!--]--><main class="main" data-v-37ebe389><div style="position:relative;" class="vp-doc _guo-notes_classify_mysql_mysql%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8" data-v-37ebe389><div><h1 id="mysql负载均衡和高可用" tabindex="-1">mysql负载均衡和高可用 <a class="header-anchor" href="#mysql负载均衡和高可用" aria-hidden="true">#</a></h1><h2 id="一、haproxy介绍与配置" tabindex="-1">一、haproxy介绍与配置 <a class="header-anchor" href="#一、haproxy介绍与配置" aria-hidden="true">#</a></h2><h2 id="_1-1-haproxy介绍" tabindex="-1">1.1 haproxy介绍 <a class="header-anchor" href="#_1-1-haproxy介绍" aria-hidden="true">#</a></h2><p>HAProxy 是一个使用C语言编写的自由及开放源代码软件，其提供高可用性、负载均衡，以及基于 TCP 和 HTTP 的应用程序代理。</p><ul><li>HAProxy 特别适用于那些负载特大的 web 站点，这些站点通常又需要会话保持或七层处理。</li><li>HAProxy 运行在当前的硬件上，完全可以支持数以万计的并发连接，并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的 web 服务器不被暴露到网络上。</li><li>HAProxy 实现了一种事件驱动，单一进程模型，此模型支持非常大的并发连接数。多进程或多线程模型受内存限制 、系统调度器限制以及无处不在的锁限制，很少能处理数千并发连接。事件驱动模型因为在有更好的资源和时间管理的用户空间 (User-Space) 实现所有这些任务，所以没有这些问题。此模型的弊端是，在多核系统上，这些程序通常扩展性较差。这就是为什么他们必须进行优化以使每个 CPU 时间片 Cycle 做更多的工作。</li><li>相较与 Nginx，HAProxy 更专注与反向代理，因此它可以支持更多的选项，更精细的控制，更多的健康状态检测机制和负载均衡算法。</li><li>包括 GitHub、Bitbucket、Stack Overflow、Reddit、Tumblr、Twitter 和 Tuenti 在内的知名网站，及亚马逊网络服务系统都使用了 HAProxy。</li></ul><p><strong>Haproxy的特性：</strong></p><ol><li>可靠性与稳定性都非常出色，可与硬件级设备媲美。</li><li>支持连接拒绝，可以用于防止 DDoS 攻击</li><li>支持长连接、短连接和日志功能，可根据需要灵活配置</li><li>路由 HTTP 请求到后端服务器,基于 cookie 作会话绑定；同时支持通过获取指定的 url 来检测后端服务器的状态</li><li>HAProxy 还拥有功能强大的 ACL 支持，可灵活配置路由功能，实现动静分离，在架构设计与实现上带来很大方便</li><li>可支持四层和七层负载均衡，几乎能为所有服务常见的提供负载均衡功能</li><li>拥有功能强大的后端服务器的状态监控 web 页面，可以实时了解设备的运行状态 ，还可实现设备上下线等简单操作。</li><li>支持多种负载均衡调度算法，并且也支持 session 保持。</li><li>Haproxy 七层负载均衡模式下，负载均衡与客户端及后端的服务器会分别建立一次 TCP连接，而在四层负载均衡模式下(DR)，仅建立一次 TCP 连接；七层负载均衡对负载均衡设备的要求更高，处理能力也低于四层负载均衡</li></ol><p><strong>haproxy 的配置文件由两部分组成：</strong></p><ol><li>全局设定（global settings）</li><li>对代理的设定（proxies）</li></ol><blockquote><p>全局设定</p></blockquote><p>global settings：主要用于定义 haproxy 进程管理安全及性能相关的参数</p><blockquote><p>代理设定</p></blockquote><p>proxies 共分为4段：defaults，frontend，backend，listen</p><p>defaults：为除了 global 以外的其它配置段提供默认参数，默认配置参数可由下一个 “defaults” 重新设定。</p><p>frontend：定义一系列监听的套接字，这些套接字可接受客户端请求并与之建立连接。</p><p>backend：定义 “后端” 服务器，前端代理服务器将会把客户端的请求调度至这些服务器。</p><p>listen：定义监听的套接字和后端的服务器。类似于将 frontend 和 backend 段放在一起</p><p>所有代理的名称只能使用大写字母、小写字母、数字、-(中线)、_(下划线)、.(点号)和:(冒号)。</p><p>此外，ACL 名称会区分字母大小写。</p><h2 id="_1-2-配置文件详细介绍" tabindex="-1">1.2 配置文件详细介绍 <a class="header-anchor" href="#_1-2-配置文件详细介绍" aria-hidden="true">#</a></h2><p><strong>注意：此处只做配置文件介绍，不做为后期负载均衡配置</strong></p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#A6ACCD;">global</span></span>
<span class="line"><span style="color:#A6ACCD;">	log 127.0.0.1 local0	</span><span style="color:#676E95;"># 定义全局的 syslog 服务器，最多可定义2个,格式：log &lt;address&gt; &lt;facility&gt; [max level [min level]]</span></span>
<span class="line"><span style="color:#A6ACCD;">    chroot /var/lib/haproxy	</span><span style="color:#676E95;"># 修改 haproxy 的工作目录至指定的目录并在放弃权限之前执行，保证haproxy的安全,使用配置文件默认值即可</span></span>
<span class="line"><span style="color:#A6ACCD;">    pidfile /var/run/haproxy.pid</span></span>
<span class="line"><span style="color:#A6ACCD;">    maxconn 10000	</span><span style="color:#676E95;"># 设定每个haproxy进程所接受的最大并发连接数，其等同于命令行选项“-n”；“ulimit -n”自动计算的结果正是参照此参数设定的；</span></span>
<span class="line"><span style="color:#A6ACCD;">    user haproxy	</span><span style="color:#676E95;"># 以指定的 user 运行haproxy，建议使用专用于运行 haproxy 的 user, 以免因权限问题带来风险；</span></span>
<span class="line"><span style="color:#A6ACCD;">    group haproxy	</span><span style="color:#676E95;"># 以指定的 group 运行haproxy，建议使用专用于运行 haproxy 的 group， 以免因权限问题带来风险；</span></span>
<span class="line"><span style="color:#A6ACCD;">    daemon	</span><span style="color:#676E95;"># 让 haproxy 以守护进程的方式工作于后台，其等同于 “-D” 选项的功能， 当然，也可以在命令行中以 “-db” 选项将其禁用；</span></span>
<span class="line"><span style="color:#A6ACCD;">    ulimit-n 100000	</span><span style="color:#676E95;"># 设定每进程所能够打开的最大文件描述符数目，默认情况下其会自动进行计算，因此不推荐修改此选项；Linux默认单进程打开文件数为1024个</span></span>
<span class="line"><span style="color:#A6ACCD;">    stats socket /var/lib/haproxy/stats level admin process 1	</span><span style="color:#676E95;"># 开启一个 socket 管理接口</span></span>
<span class="line"><span style="color:#A6ACCD;">    nbproc 12	</span><span style="color:#676E95;"># 指定启动的 haproxy 进程个数，只能用于守护进程模式的 haproxy；默认只启动一个进程，</span></span>
<span class="line"><span style="color:#A6ACCD;">    cpu-map 1 0	</span><span style="color:#676E95;"># 绑定 cpu,和 nbproc 数量相对。进程号从1开始，cpu 核数从0开始；</span></span>
<span class="line"><span style="color:#A6ACCD;">    cpu-map 2 1</span></span>
<span class="line"><span style="color:#A6ACCD;">    cpu-map 3 2</span></span>
<span class="line"><span style="color:#A6ACCD;">    cpu-map 4 3</span></span>
<span class="line"><span style="color:#A6ACCD;">    cpu-map 5 4</span></span>
<span class="line"><span style="color:#A6ACCD;">    cpu-map 6 5</span></span>
<span class="line"><span style="color:#A6ACCD;">    cpu-map 7 6</span></span>
<span class="line"><span style="color:#A6ACCD;">    cpu-map 8 7</span></span>
<span class="line"><span style="color:#A6ACCD;">    cpu-map 9 8</span></span>
<span class="line"><span style="color:#A6ACCD;">    cpu-map 10 9</span></span>
<span class="line"><span style="color:#A6ACCD;">    cpu-map 11 10</span></span>
<span class="line"><span style="color:#A6ACCD;">    cpu-map 12 11</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">defaults</span></span>
<span class="line"><span style="color:#A6ACCD;">    log global</span></span>
<span class="line"><span style="color:#A6ACCD;">    option tcplog	</span><span style="color:#676E95;"># 启用日志记录；tcplog 请求；</span></span>
<span class="line"><span style="color:#A6ACCD;">    option dontlognull	</span><span style="color:#676E95;"># 日志中将不会记录空连接；</span></span>
<span class="line"><span style="color:#A6ACCD;">    retries 3	</span><span style="color:#676E95;"># 定义连接后端服务器的失败重连次数</span></span>
<span class="line"><span style="color:#A6ACCD;">    timeout connect 2s	</span><span style="color:#676E95;"># 定义 haproxy 将客户端请求转发至后端服务器所等待的超时时长</span></span>
<span class="line"><span style="color:#A6ACCD;">    timeout client 3600s	</span><span style="color:#676E95;"># 客户端非活动状态的超时时长</span></span>
<span class="line"><span style="color:#A6ACCD;">    timeout server 3600s	</span><span style="color:#676E95;"># 客户端与服务器端建立连接后，等待服务器端的超时时长</span></span>
<span class="line"><span style="color:#A6ACCD;">    maxconn 10000	</span><span style="color:#676E95;"># 默认和前段的最大连接数，但不能超过 global 中的 maxconn 限制数</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">listen admin_stats	</span><span style="color:#676E95;"># 开启一个统计报告服务</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">bind</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">:1080	</span><span style="color:#676E95;"># 监听1080端口</span></span>
<span class="line"><span style="color:#A6ACCD;">    mode http	</span><span style="color:#676E95;"># 基于http协议</span></span>
<span class="line"><span style="color:#A6ACCD;">    maxconn 10</span></span>
<span class="line"><span style="color:#A6ACCD;">    stats refresh 10s	</span><span style="color:#676E95;"># 统计页面自动刷新时间间隔</span></span>
<span class="line"><span style="color:#A6ACCD;">    stats uri /haproxy	</span><span style="color:#676E95;"># url 地址</span></span>
<span class="line"><span style="color:#A6ACCD;">    stats realm Haproxy	</span><span style="color:#676E95;"># 统计页面密码框上提示文本</span></span>
<span class="line"><span style="color:#A6ACCD;">    stats auth admin:admin	</span><span style="color:#676E95;"># 账号：密码</span></span>
<span class="line"><span style="color:#A6ACCD;">    stats hide-version	</span><span style="color:#676E95;"># 隐藏统计报告版本信息</span></span>
<span class="line"><span style="color:#A6ACCD;">    stats admin </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> TRUE	</span><span style="color:#676E95;"># 在制定条件下开启admin 功能</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">frontend haproxy	</span><span style="color:#676E95;"># 前端应用</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">bind</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">:40000	</span><span style="color:#676E95;"># 端口</span></span>
<span class="line"><span style="color:#A6ACCD;">    mode tcp	</span><span style="color:#676E95;"># tcp 模式</span></span>
<span class="line"><span style="color:#A6ACCD;">    default_backend tidb	</span><span style="color:#676E95;"># 此前端对应的后端应用</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">backend tidb	</span><span style="color:#676E95;"># 后端应用</span></span>
<span class="line"><span style="color:#A6ACCD;">    balance leastconn	</span><span style="color:#676E95;"># balance 基于最少连接数</span></span>
<span class="line"><span style="color:#A6ACCD;">    mode tcp	</span><span style="color:#676E95;"># tcp 模式</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># acl internal_networks src 192.168.0.0/16 172.16.0.0/12 10.0.0.0/8 127.0.0.1  定义一条ACL，ACL是根据数据包的指定属性以指定表达式计算出的true/false值。</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># tcp-request content reject if ! internal_networks</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># option mysql-check user haproxy post-41</span></span>
<span class="line"><span style="color:#A6ACCD;">    server tidb1 10.0.1.4:4000 check	</span><span style="color:#676E95;"># 后端应用地址，代理将会将对应客户端的请求转发至这些服务器。</span></span>
<span class="line"><span style="color:#A6ACCD;">    server tidb2 10.0.1.10:4000 check</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>环境搭建准备：</p><table><thead><tr><th>服务器名称</th><th>IP</th><th>操作系统</th><th>安装服务</th></tr></thead><tbody><tr><td>Mysql-Master</td><td>192.168.199.131</td><td>CentOS7.1</td><td>mysql,elasticsearch</td></tr><tr><td>Mysql-Slave1</td><td>192.168.199.175</td><td>CentOS7.1</td><td>mysql,Mycat，haproxy，Keepalived</td></tr><tr><td>Mysql-Slave2</td><td>192.168.199.172</td><td>CentOS7.1</td><td>mysql，haproxy，Keepalived</td></tr></tbody></table><h2 id="_1-3-haproxy安装与环境配置" tabindex="-1">1.3 haproxy安装与环境配置 <a class="header-anchor" href="#_1-3-haproxy安装与环境配置" aria-hidden="true">#</a></h2><p>在192.168.199.175与192.168.199.172(负载均衡服务器)中安装与配置如下：</p><ol><li>安装haproxy负载均衡器</li></ol><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#A6ACCD;">yum install haproxy -y</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>配置haproxy配置文件，目录：/etc/haproxy/haproxy.cfg</li></ol><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#A6ACCD;">global</span></span>
<span class="line"><span style="color:#A6ACCD;">    log         127.0.0.1 local2</span></span>
<span class="line"><span style="color:#A6ACCD;">    chroot      /var/lib/haproxy</span></span>
<span class="line"><span style="color:#A6ACCD;">    pidfile     /var/run/haproxy.pid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">maxconn     4000</span></span>
<span class="line"><span style="color:#A6ACCD;">    user        haproxy</span></span>
<span class="line"><span style="color:#A6ACCD;">    group       haproxy</span></span>
<span class="line"><span style="color:#A6ACCD;">    daemon</span></span>
<span class="line"><span style="color:#A6ACCD;">    stats socket /var/lib/haproxy/stats</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">defaults</span></span>
<span class="line"><span style="color:#A6ACCD;">    mode                   tcp</span></span>
<span class="line"><span style="color:#A6ACCD;">    log                     global</span></span>
<span class="line"><span style="color:#A6ACCD;">    option                  tcplog</span></span>
<span class="line"><span style="color:#A6ACCD;">    option                  dontlognull</span></span>
<span class="line"><span style="color:#A6ACCD;">    option http-server-close</span></span>
<span class="line"><span style="color:#A6ACCD;">    option                  redispatch</span></span>
<span class="line"><span style="color:#A6ACCD;">    retries                 3</span></span>
<span class="line"><span style="color:#A6ACCD;">    timeout http-request    10s</span></span>
<span class="line"><span style="color:#A6ACCD;">    timeout queue           1m</span></span>
<span class="line"><span style="color:#A6ACCD;">    timeout connect         10s</span></span>
<span class="line"><span style="color:#A6ACCD;">    timeout client          1m</span></span>
<span class="line"><span style="color:#A6ACCD;">    timeout server          1m</span></span>
<span class="line"><span style="color:#A6ACCD;">    timeout http-keep-alive 10s</span></span>
<span class="line"><span style="color:#A6ACCD;">    timeout check           10s</span></span>
<span class="line"><span style="color:#A6ACCD;">    maxconn                 3000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">frontend    mysql</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">bind</span><span style="color:#A6ACCD;">        0.0.0.0:3307</span></span>
<span class="line"><span style="color:#A6ACCD;">    mode       tcp</span></span>
<span class="line"><span style="color:#A6ACCD;">    log             global</span></span>
<span class="line"><span style="color:#A6ACCD;">    default_backend         mysql_server</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">backend     mysql_server</span></span>
<span class="line"><span style="color:#A6ACCD;">    balance     roundrobin</span></span>
<span class="line"><span style="color:#A6ACCD;">    server  mysql1 192.168.199.172:3306 check inter 5s rise 2 fall 3</span></span>
<span class="line"><span style="color:#A6ACCD;">    server  mysql2 192.168.199.175:3306 check inter 5s rise 2 fall 3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">listen stats</span></span>
<span class="line"><span style="color:#A6ACCD;">    mode http</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">bind</span><span style="color:#A6ACCD;"> 0.0.0.0:1080</span></span>
<span class="line"><span style="color:#A6ACCD;">    stats </span><span style="color:#82AAFF;">enable</span></span>
<span class="line"><span style="color:#A6ACCD;">    stats hide-version</span></span>
<span class="line"><span style="color:#A6ACCD;">    stats uri /haproxyadmin</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;">stats</span></span>
<span class="line"><span style="color:#A6ACCD;">    stats realm Haproxy\ Statistics</span></span>
<span class="line"><span style="color:#A6ACCD;">    stats auth admin:admin</span></span>
<span class="line"><span style="color:#A6ACCD;">    stats admin </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> TRUE</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><ol start="3"><li>启动haproxy负载均衡</li></ol><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#A6ACCD;">./usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="二、keeplived介绍与配置" tabindex="-1">二、keeplived介绍与配置 <a class="header-anchor" href="#二、keeplived介绍与配置" aria-hidden="true">#</a></h2><h2 id="_1、keepalived介绍" tabindex="-1">1、Keepalived介绍 <a class="header-anchor" href="#_1、keepalived介绍" aria-hidden="true">#</a></h2><p>Keepalived 的作用是检测服务器的状态，如果有一台服务器宕机，或工作出现故障，Keepalived将检测到，并将有故障的服务器从系统中剔除，同时使用其它服务器代替该服务器的工作，当服务器工作正常后Keepalived自动将服务器加入到服务器群中，这些工作全部自动完成，不需要人工干涉，需要人工做的只是修复故障的服务器。</p><h2 id="_2、keepalived安装" tabindex="-1">2、Keepalived安装 <a class="header-anchor" href="#_2、keepalived安装" aria-hidden="true">#</a></h2><blockquote><p>安装 keepalived 需要用到 openssl</p></blockquote><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@localhost keepalived]# yum install gcc gcc-c++ openssl openssl-devel</span></span>
<span class="line"><span style="color:#A6ACCD;">[root@localhost home]# wget -q https://www.keepalived.org/software/keepalived-1.2.18.tar.gz</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>解压Keepalived并安装</p></blockquote><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@localhost home]# tar -zxvf keepalived-1.2.18.tar.gz</span></span>
<span class="line"><span style="color:#A6ACCD;">[root@localhost home]# cd keepalived-1.2.18</span></span>
<span class="line"><span style="color:#A6ACCD;">[root@localhost keepalived-1.2.18]# ./configure --prefix=/usr/local/keepalived</span></span>
<span class="line"><span style="color:#A6ACCD;">[root@localhost keepalived-1.2.18]# make &amp;&amp; make install</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>将 keepalived 安装成 Linux 系统服务</p></blockquote><p>因为没有使用 keepalived 的默认路径安装（默认是/usr/local） ,安装完成之后，需要做一些工作 复制默认配置文件到默认路径</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@localhost keepalived-1.2.18]# mkdir /etc/keepalived</span></span>
<span class="line"><span style="color:#A6ACCD;">[root@localhost keepalived-1.2.18]# cp /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>复制 keepalived 服务脚本到默认的地址</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@localhost keepalived-1.2.18]# cp /usr/local/keepalived/etc/rc.d/init.d/keepalived /etc/init.d/</span></span>
<span class="line"><span style="color:#A6ACCD;">[root@localhost keepalived-1.2.18]# cp /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/</span></span>
<span class="line"><span style="color:#A6ACCD;">[root@localhost keepalived-1.2.18]# ln -s /usr/local/keepalived/sbin/keepalived /usr/sbin/</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>设置 keepalived 服务开机启动</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@localhost keepalived-1.2.18]# chkconfig keepalived on</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="三、mysql-高可用搭建" tabindex="-1">三、mysql 高可用搭建 <a class="header-anchor" href="#三、mysql-高可用搭建" aria-hidden="true">#</a></h2><h2 id="_1、keepalived-配置" tabindex="-1">1、Keepalived 配置 <a class="header-anchor" href="#_1、keepalived-配置" aria-hidden="true">#</a></h2><blockquote><p>keepalived主机配置</p></blockquote><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;"> Configuration File </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> keepalived</span></span>
<span class="line"><span style="color:#A6ACCD;">global_defs </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    router_id LVS_MASTER</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">vrrp_sync_group VG1 </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    group </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        VI_1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">vrrp_script chk_haproxy </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    script </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/etc/keepalived/haproxy_check.sh</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">## 检测 haproxy 状态的脚本路径</span></span>
<span class="line"><span style="color:#A6ACCD;">    interval 2 </span><span style="color:#676E95;">## 检测时间间隔</span></span>
<span class="line"><span style="color:#A6ACCD;">    weight 2 </span><span style="color:#676E95;">## 如果条件成立，权重+2</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">vrrp_instance VI_1 </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    state MASTER</span></span>
<span class="line"><span style="color:#A6ACCD;">    interface ens33</span></span>
<span class="line"><span style="color:#A6ACCD;">    virtual_router_id 79</span></span>
<span class="line"><span style="color:#A6ACCD;">    priority 100</span></span>
<span class="line"><span style="color:#A6ACCD;">    advert_int 1</span></span>
<span class="line"><span style="color:#A6ACCD;">    nopreempt</span></span>
<span class="line"><span style="color:#A6ACCD;">    authentication </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        auth_type PASS</span></span>
<span class="line"><span style="color:#A6ACCD;">        auth_pass 1234</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    virtual_ipaddress </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        192.168.199.101</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;"># 写VIP virtual_server，只配置本地机器</span></span>
<span class="line"><span style="color:#A6ACCD;">virtual_server 192.168.199.101 3307 {</span><span style="color:#676E95;"># 定义虚拟服务器，地址与上面的virtual_ipaddress相同</span></span>
<span class="line"><span style="color:#A6ACCD;">    delay_loop 3 </span><span style="color:#676E95;"># 健康检查时间间隔，3秒</span></span>
<span class="line"><span style="color:#A6ACCD;">    lb_algo rr </span><span style="color:#676E95;"># 负载均衡调度算法：rr|wrr|lc|wlc|sh|dh|lblc</span></span>
<span class="line"><span style="color:#A6ACCD;">    lb_kind DR </span><span style="color:#676E95;"># 负载均衡转发规则：NAT|DR|TUN</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># persistence_timeout 5 # 会话保持时间5秒，动态服务建议开启</span></span>
<span class="line"><span style="color:#A6ACCD;">    protocol TCP </span><span style="color:#676E95;"># 转发协议protocol，一般有tcp和udp两种</span></span>
<span class="line"><span style="color:#A6ACCD;">    real_server 192.168.199.175 3307 </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        weight 1 </span><span style="color:#676E95;"># 权重越大负载分越大，0表示失效</span></span>
<span class="line"><span style="color:#A6ACCD;">        TCP_CHECK </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            connect_timeout 3</span></span>
<span class="line"><span style="color:#A6ACCD;">            nb_get_retry 3</span></span>
<span class="line"><span style="color:#A6ACCD;">            delay_before_retry 3</span></span>
<span class="line"><span style="color:#A6ACCD;">            connect_port 3306</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">track_script </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    haproxy_check</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><blockquote><p>Keepalived从机配置</p></blockquote><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;"> Configuration File </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> keepalived</span></span>
<span class="line"><span style="color:#A6ACCD;">global_defs </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    router_id LVS_MASTER</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">vrrp_sync_group VG1 </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    group </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        VI_1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">rrp_script chk_haproxy </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    script </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/etc/keepalived/haproxy_check.sh</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">## 检测 haproxy 状态的脚本路径</span></span>
<span class="line"><span style="color:#A6ACCD;">    interval 2 </span><span style="color:#676E95;">## 检测时间间隔</span></span>
<span class="line"><span style="color:#A6ACCD;">    weight 2 </span><span style="color:#676E95;">## 如果条件成立，权重+2</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">vrrp_instance VI_1 </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    state BACKUP</span></span>
<span class="line"><span style="color:#A6ACCD;">    interface ens33</span></span>
<span class="line"><span style="color:#A6ACCD;">    virtual_router_id 79</span></span>
<span class="line"><span style="color:#A6ACCD;">    priority 90</span></span>
<span class="line"><span style="color:#A6ACCD;">    advert_int 1</span></span>
<span class="line"><span style="color:#A6ACCD;">    nopreempt</span></span>
<span class="line"><span style="color:#A6ACCD;">    authentication </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        auth_type PASS</span></span>
<span class="line"><span style="color:#A6ACCD;">        auth_pass 1234</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    virtual_ipaddress </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        192.168.199.101</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;"># 写VIP virtual_server，只配置本地机器</span></span>
<span class="line"><span style="color:#A6ACCD;">virtual_server 192.168.199.101 3307 {</span><span style="color:#676E95;"># 定义虚拟服务器，地址与上面的virtual_ipaddress相同</span></span>
<span class="line"><span style="color:#A6ACCD;">    delay_loop 3 </span><span style="color:#676E95;"># 健康检查时间间隔，3秒</span></span>
<span class="line"><span style="color:#A6ACCD;">    lb_algo rr </span><span style="color:#676E95;"># 负载均衡调度算法：rr|wrr|lc|wlc|sh|dh|lblc</span></span>
<span class="line"><span style="color:#A6ACCD;">    lb_kind DR </span><span style="color:#676E95;"># 负载均衡转发规则：NAT|DR|TUN</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;"># persistence_timeout 5 # 会话保持时间5秒，动态服务建议开启</span></span>
<span class="line"><span style="color:#A6ACCD;">    protocol TCP </span><span style="color:#676E95;"># 转发协议protocol，一般有tcp和udp两种</span></span>
<span class="line"><span style="color:#A6ACCD;">    real_server 192.168.199.172 3307 </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        weight 1 </span><span style="color:#676E95;"># 权重越大负载分越大，0表示失效</span></span>
<span class="line"><span style="color:#A6ACCD;">        TCP_CHECK </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            connect_timeout 3</span></span>
<span class="line"><span style="color:#A6ACCD;">            nb_get_retry 3</span></span>
<span class="line"><span style="color:#A6ACCD;">            delay_before_retry 3</span></span>
<span class="line"><span style="color:#A6ACCD;">            connect_port 3306</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">track_script </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    haproxy_check</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><blockquote><p>haproxy状态检测脚本</p></blockquote><div class="language-sh line-numbers-mode"><button class="copy"></button><span class="lang">sh</span><pre><code><span class="line"><span style="color:#676E95;">#!/bin/bash</span></span>
<span class="line"><span style="color:#A6ACCD;">START_HAPROXY=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#haproxy启动命令</span></span>
<span class="line"><span style="color:#A6ACCD;">LOG_FILE=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/usr/local/keepalived/log/haproxy-check.log</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 日志文件</span></span>
<span class="line"><span style="color:#A6ACCD;">HAPS=</span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">ps -C haproxy --no-header </span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">wc -l</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 检测haproxy的状态，0代表未启动,1已经启动</span></span>
<span class="line"><span style="color:#A6ACCD;">date </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">+%Y-%m-%d %H:%M:%S</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">LOG_FILE </span><span style="color:#676E95;">#在日志文件当中记录检测时间</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">check haproxy status</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">LOG_FILE </span><span style="color:#676E95;"># 记录haproxy的状态</span></span>
<span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">HAPS </span><span style="color:#89DDFF;">-eq</span><span style="color:#A6ACCD;"> 0 </span><span style="color:#89DDFF;">];</span><span style="color:#89DDFF;">then</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#执行haproxy判断</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">START_HAPROXY </span><span style="color:#89DDFF;">&gt;&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">LOG_FILE </span><span style="color:#676E95;">#记录启动命令</span></span>
<span class="line"><span style="color:#A6ACCD;">  /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg </span><span style="color:#676E95;">#启动haproxy</span></span>
<span class="line"><span style="color:#A6ACCD;">  sleep 3</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">ps -C haproxy --no-header </span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">wc -l</span><span style="color:#89DDFF;">`</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-eq</span><span style="color:#A6ACCD;"> 0 </span><span style="color:#89DDFF;">];</span><span style="color:#89DDFF;">then</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">start haproxy failed, killall keepalived</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">LOG_FILE</span></span>
<span class="line"><span style="color:#A6ACCD;">    killall keepalived</span></span>
<span class="line"><span style="color:#A6ACCD;">    service keepalived stop</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">fi</span></span>
<span class="line"><span style="color:#89DDFF;">fi</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>haproxy状态检测脚本不执行问题，如果是使用的service keeplived start 或者是 systemctl 方式启动，脚本可能会不执行，可以使用 Keepalived -f /etc/keepalived/keepalived.conf方式启动Keepalived</p><blockquote><p>keepalived配置注意点 - 配置完成但是ip不生效；</p></blockquote><ol><li>查看虚拟机/机器系统时间是否一致</li><li>virtual_router_id路由id不对，不能冲突。可以通过/var/log/messages查看此错误</li></ol><h2 id="_2、测试" tabindex="-1">2、测试 <a class="header-anchor" href="#_2、测试" aria-hidden="true">#</a></h2><p>在本地通过192.168.199.101去连接mysql，查询sever_id，端口使用haproxy定义的3307</p><p><img src="/guo-notes/mysql/mysql-41.png" alt="image-20210831090903100"></p><p>可以看到同样的连接方式，但是查询到的server_id确是不同机器的server_id.</p><h2 id="四、mysql高可用mha" tabindex="-1">四、MySQL高可用MHA <a class="header-anchor" href="#四、mysql高可用mha" aria-hidden="true">#</a></h2><h2 id="_1、设计分析" tabindex="-1">1、设计分析 <a class="header-anchor" href="#_1、设计分析" aria-hidden="true">#</a></h2><p>在设计分析之前，先普及下MHA知识，否则设计分析也看不懂</p><h2 id="_1-1-理解mha" tabindex="-1">1.1 理解MHA <a class="header-anchor" href="#_1-1-理解mha" aria-hidden="true">#</a></h2><p><strong>MHA是什么</strong></p><p>MHA是mysql高可用解决方案之一。</p><ul><li>当mysql主库发生故障，MHA提升从库为主库，确保主库高可用。</li><li>MHA 能在最大程度上保证数据的一致性，以达到真正意义上的高可用。</li></ul><p><strong>MHA由什么组成</strong></p><blockquote><p>1 MHA Manager（管理节点）</p></blockquote><p>建议同学们将MHA Manager单独部署在一台独立的机器上管理多个master-slave集群。</p><blockquote><p>2 MHA Node（数据节点）</p></blockquote><p>MHA Node运行在每台MySQL服务器上，是MHA Manager的员工，接收Manager的命令并执行</p><p><strong>MHA各个工具包的作用</strong></p><p>manager工具包：</p><table><thead><tr><th>组件名称</th><th>组件说明</th></tr></thead><tbody><tr><td>masterha_check_ssh</td><td>检查MHA的SSH配置状况</td></tr><tr><td>masterha_check_repl</td><td>检查MySQL复制状况</td></tr><tr><td>masterha_manger</td><td>启动MHA</td></tr><tr><td>masterha_check_status</td><td>检测当前MHA运行状态</td></tr><tr><td>masterha_master_monitor</td><td>检测master是否宕机</td></tr><tr><td>masterha_master_switch</td><td>控制故障转移（自动或者手动）</td></tr><tr><td>masterha_conf_host</td><td>添加或删除配置的server信息</td></tr></tbody></table><p>node工具包：</p><table><thead><tr><th>组件名称</th><th>组件说明</th></tr></thead><tbody><tr><td>save_binary_logs</td><td>保存和复制master的二进制日志</td></tr><tr><td>apply_diff_relay_logs</td><td>识别差异的中继日志事件并将其差异的事件应用于其他的slave</td></tr><tr><td>filter_mysqlbinlog</td><td>去除不必要的ROLLBACK事件（MHA已不再使用这个工具）</td></tr><tr><td>purge_relay_logs</td><td>清除中继日志（不会阻塞SQL线程）</td></tr></tbody></table><p><strong>MHA工作原理</strong></p><ol><li>从宕机崩溃的 master 保存二进制日志事件（binlog events）</li><li>识别含有最新更新的 slave</li><li>应用差异的中继日志（relay log）到其他的slave；</li><li>应用从 master 保存的二进制日志事件（binlog events）；</li><li>提升一个 slave 为新的 master；</li><li>使其他的 slave 连接新的 master 进行复制；</li></ol><h2 id="_1-2-设计分析" tabindex="-1">1.2 设计分析 <a class="header-anchor" href="#_1-2-设计分析" aria-hidden="true">#</a></h2><blockquote><p>我们采用分库分表来实现分散并发压力，那么我们还要确保每个分库的高可用</p></blockquote><p><strong>设计目的</strong></p><p>保障主库的高可用。</p><p><strong>设计图</strong></p><img src="/guo-notes/mysql/mysql-47.png" alt="image-20210831142316461" style="zoom:67%;"><p><strong>设计图拆解分析</strong></p><img src="/guo-notes/mysql/mysql-48.png" alt="image-20210831142413658" style="zoom:67%;"><p>如上图， 4个长方形代表一共4台服务器， 下面的3台上装了MHA_node 和 一主2从（一台master+2台slave）， 上面那台服务器则装了MHA_manager, manager 是 mha 的心跳检测官和总指挥官，node是manager的员工。</p><p>manager干啥：</p><ul><li>心跳检测： 检测master是否宕机。</li><li>一旦宕机，manager会以发送指令给node的方式协调整个主从切换的过程。</li></ul><p>虽然我们上面3台 mysql，每台都有 ip 地址， 但是我们应用程序不直接访问这些 IP，我们暴露给应用程序的是一个虚拟IP，简称VIP，应用程序通过 VIP 访问 master。起初，这个VIP（192.168.232.99）是位于我们的 master（192.168.168.232.101），后面主机宕机了，VIP漂移到 slave1（192.168.168.232.102）或者slave2（192.168.168.232.102）的服务器上。那么应用程序就会写入其中的slave了。</p><p><img src="/guo-notes/mysql/mysql-49.png" alt="mysql-49"></p><p>如图所示，这个VIP的切换过程就是通过manager触发IP script脚本完成的。</p><h2 id="_2、环境搭建" tabindex="-1">2、环境搭建 <a class="header-anchor" href="#_2、环境搭建" aria-hidden="true">#</a></h2><p>MHA_manager：192.168.232.100，MHA_node：192.168.232.101、192.168.232.102、192.168.232.103。</p><h2 id="_2-1-秘钥互信" tabindex="-1">2.1 秘钥互信 <a class="header-anchor" href="#_2-1-秘钥互信" aria-hidden="true">#</a></h2><p>每个节点都执行</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># cd ~</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># ssh-keygen -t rsa #看到提示不用管，一路回车就是</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># chmod 600 ~/.ssh/authorized_keys</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>只要在一个节点执行即可。这里在 192.168.232.100上执行</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># ssh 192.168.232.101 cat ~/.ssh/id_rsa.pub &gt;&gt;~/.ssh/authorized_keys</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># ssh 192.168.232.102 cat ~/.ssh/id_rsa.pub &gt;&gt;~/.ssh/authorized_keys</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># ssh 192.168.232.103 cat ~/.ssh/id_rsa.pub &gt;&gt;~/.ssh/authorized_keys</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>分发整合后的文件到其它节点</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># scp ~/.ssh/authorized_keys 192.168.232.101:~/.ssh/</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># scp ~/.ssh/authorized_keys 192.168.232.102:~/.ssh/</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># scp ~/.ssh/authorized_keys 192.168.232.103:~/.ssh/</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_2-2-安装基础依赖包" tabindex="-1">2.2 安装基础依赖包 <a class="header-anchor" href="#_2-2-安装基础依赖包" aria-hidden="true">#</a></h2><p>在所有机器上执行:</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#A6ACCD;">yum install -y perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker perl-CPAN perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Time-HiRes</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_2-3-安装mha组件" tabindex="-1">2.3 安装MHA组件 <a class="header-anchor" href="#_2-3-安装mha组件" aria-hidden="true">#</a></h2><p><strong>安装 MHA Node组件</strong></p><p>我们登陆100这台机器</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># cd /usr/local/src/mhab</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后将2个安装包（mha4mysql-manager-0.58.tar.gz、mha4mysql-node-0.58.tar.gz）上传至这个目录，如下:</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 mha</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># ll | grep mha</span></span>
<span class="line"><span style="color:#A6ACCD;">-rw-r--r-- 1 root root 119801 Sep 15 16:11 mha4mysql-manager-0.58.tar.gz</span></span>
<span class="line"><span style="color:#A6ACCD;">-rw-r--r-- 1 root root 56220 Sep 15 16:11 mha4mysql-node-0.58.tar.gz</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>将mha4mysql-node-0.58.tar.gz分发到其它3台机器</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#A6ACCD;">scp mha4mysql-node-0.58.tar.gz root@192.168.232.101:/usr/local/src/mha/</span></span>
<span class="line"><span style="color:#A6ACCD;">scp mha4mysql-node-0.58.tar.gz root@192.168.232.102:/usr/local/src/mha/</span></span>
<span class="line"><span style="color:#A6ACCD;">scp mha4mysql-node-0.58.tar.gz root@192.168.232.103:/usr/local/src/mha/</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>解压安装（在所有 node 机器上执行：）:</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@node01 soft</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># tar xf mha4mysql-node-0.58.tar.gz</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@node01 soft</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># cd mha4mysql-node-0.58</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@node01 mha4mysql-node-0.58</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># perl Makefile.PL</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@node01 mha4mysql-node-0.58</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># make &amp;&amp; make install</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Node安装完成后会得到四个工具，位于/usr/local/bin/下面</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@localhost ~]# ll /usr/local/bin/</span></span>
<span class="line"><span style="color:#A6ACCD;">total 20876</span></span>
<span class="line"><span style="color:#A6ACCD;">-r-xr-xr-x 1 root root 17639 Sep 15 02:44 apply_diff_relay_logs</span></span>
<span class="line"><span style="color:#A6ACCD;">-r-xr-xr-x 1 root root 4807 Sep 15 02:44 filter_mysqlbinlog</span></span>
<span class="line"><span style="color:#A6ACCD;">-r-xr-xr-x 1 root root 8337 Sep 15 02:44 purge_relay_logs</span></span>
<span class="line"><span style="color:#A6ACCD;">-r-xr-xr-x 1 root root 7525 Sep 15 02:44 save_binary_logs</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>安装 MHA Manager 组件</strong></p><p>只在100上安装：</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 mha</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># cd /usr/local/src/mha</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 mha</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># tar -zxxf mha4mysql-manager-0.58.tar.gz</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 mha</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># # cd mha4mysql-manager-0.58</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 mha4mysql-manager-0.58</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># ls</span></span>
<span class="line"><span style="color:#A6ACCD;">AUTHORS blib debian lib Makefile.PL META.yml README samples tests</span></span>
<span class="line"><span style="color:#A6ACCD;">bin COPYING inc Makefile MANIFEST pm_to_blib rpm t</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@manager mha4mysql-manager-0.58</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># perl Makefile.PL</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@manager mha4mysql-manager-0.58</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># make &amp;&amp; make install</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>查看 Manager 工具</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@101 mha4mysql-manager-0.58</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># ll /usr/local/bin/ | grep master</span></span>
<span class="line"><span style="color:#A6ACCD;">-rw-r--r-- 1 root root 406891 Jul 30 12:58 compose-master.zip</span></span>
<span class="line"><span style="color:#A6ACCD;">-r-xr-xr-x 1 root root 1995 Sep 15 03:17 masterha_check_repl</span></span>
<span class="line"><span style="color:#A6ACCD;">-r-xr-xr-x 1 root root 1779 Sep 15 03:17 masterha_check_ssh</span></span>
<span class="line"><span style="color:#A6ACCD;">-r-xr-xr-x 1 root root 1865 Sep 15 03:17 masterha_check_status</span></span>
<span class="line"><span style="color:#A6ACCD;">-r-xr-xr-x 1 root root 3201 Sep 15 03:17 masterha_conf_host</span></span>
<span class="line"><span style="color:#A6ACCD;">-r-xr-xr-x 1 root root 2517 Sep 15 03:17 masterha_manager</span></span>
<span class="line"><span style="color:#A6ACCD;">-r-xr-xr-x 1 root root 2165 Sep 15 03:17 masterha_master_monitor</span></span>
<span class="line"><span style="color:#A6ACCD;">-r-xr-xr-x 1 root root 2373 Sep 15 03:17 masterha_master_switch</span></span>
<span class="line"><span style="color:#A6ACCD;">-r-xr-xr-x 1 root root 5172 Sep 15 03:17 masterha_secondary_check</span></span>
<span class="line"><span style="color:#A6ACCD;">-r-xr-xr-x 1 root root 1739 Sep 15 03:17 masterha_stop</span></span>
<span class="line"><span style="color:#A6ACCD;">-rwxr-xr-x 1 root root 3648 Sep 16 02:47 master_ip_failover</span></span>
<span class="line"><span style="color:#A6ACCD;">-rwxr-xr-x 1 root root 9870 Sep 16 02:47 master_ip_online_change</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="_2-4-安装mysql" tabindex="-1">2.4 安装mysql <a class="header-anchor" href="#_2-4-安装mysql" aria-hidden="true">#</a></h2><blockquote><p>101为 master，102和103两个node 为 slave 。</p></blockquote><p>下载mysql的安装包，</p><p>mysql安装命令（在3台mysql上都要执行）：</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@101 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># cd /usl/local/src/mha</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@101 mha</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># useradd -s /sbin/nologin -M mysql</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@101 mha</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># tar -zxxf mysql-5.7.18-linux-glibc2.5-x86_64.tar.gz</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@101 mha</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># mv mysql-5.7.18-linux-glibc2.5-x86_64 mysql-5.7</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@101 mha</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># ln -s /usr/local/src/mha/mysql-5.7 /usr/local/mysql-5.7</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@101 mha</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># ln -s /usr/local/src/mha/mysql-5.7 /usr/local/mysql</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@101 mha</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># echo &#39;export PATH=$PATH:/usr/local/mysql-5.7/bin&#39; &gt;&gt; /etc/profile</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@node01 mha</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># source /etc/profile</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@node01 mha</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># mysql -V</span></span>
<span class="line"><span style="color:#A6ACCD;">mysql Ver 14.14 Distrib 5.7.18, </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> linux-glibc2.5 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x86_64</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> using EditLine wrapper</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@101 mha</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># cd /usr/local/mysql-5.7</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@node01 mysql-5.7</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># cp support-files/mysql.server /etc/init.d/mysqld</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@node01 mysql-5.7</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># sed -i &#39;s@/etc/my.cnf@/usr/local/mysql-5.7/my.cnf@g&#39; /etc/init.d/mysqld</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@node01 mysql-5.7</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># sed -i &#39;s@/usr/local/mysql/data@/opt/mysql_data@g&#39; /etc/init.d/mysqld</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@node01 mysql-5.7</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># chkconfig mysqld on</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@node01 mysql-5.7</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># mkdir -p /opt/mysql_data</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@node01 mysql-5.7</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># chown -R mysql.mysql /usr/local/src/mha/mysql-5.7</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@node01 mysql-5.7</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># chown -R mysql.mysql /opt/mysql_data</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@node01 mysql-5.7</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># ln -s /usr/local/src/mha/mysql-5.7/bin/mysqlbinlog /usr/local/bin/mysqlbinlog</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@node01 mysql-5.7</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># ln -s /usr/local/src/mha/mysql-5.7/bin/mysql /usr/local/bin/mysql</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="_2-5-建立一主二从" tabindex="-1">2.5 建立一主二从 <a class="header-anchor" href="#_2-5-建立一主二从" aria-hidden="true">#</a></h2><p>192.168.232.101： 主库</p><p>192.168.232.102： 从库1</p><p>192.168.232.103： 从库2</p><p>my.cnf 配置文件</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">vim /etc/my.cnf</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>主库：</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">mysql</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">default-character-set=utf8</span></span>
<span class="line"><span style="color:#A6ACCD;">socket = /tmp/mysql.sock</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">mysqld</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">socket = /tmp/mysql.sock</span></span>
<span class="line"><span style="color:#A6ACCD;">character-set-server=utf8</span></span>
<span class="line"><span style="color:#A6ACCD;">basedir=/usr/local/mysql-5.7</span></span>
<span class="line"><span style="color:#A6ACCD;">datadir=/opt/mysql_data</span></span>
<span class="line"><span style="color:#A6ACCD;">port=3306</span></span>
<span class="line"><span style="color:#A6ACCD;">pid-file=/opt/mysql_data/mysqld.pid</span></span>
<span class="line"><span style="color:#676E95;"># 四台node不可重复</span></span>
<span class="line"><span style="color:#A6ACCD;">server-id=101</span></span>
<span class="line"><span style="color:#A6ACCD;">log-bin=master-bin</span></span>
<span class="line"><span style="color:#A6ACCD;">relay-log-index=slave-relay-bin.index</span></span>
<span class="line"><span style="color:#A6ACCD;">relay-log=slave-relay-bin</span></span>
<span class="line"><span style="color:#A6ACCD;">binlog_format = MIXED</span></span>
<span class="line"><span style="color:#A6ACCD;">sync_binlog = 1</span></span>
<span class="line"><span style="color:#676E95;">#二进制日志自动删除/过期的天数。默认值为0，表示不自动删除。</span></span>
<span class="line"><span style="color:#A6ACCD;">expire_logs_days =7 </span></span>
<span class="line"><span style="color:#A6ACCD;">log_slave_updates = 1</span></span>
<span class="line"><span style="color:#A6ACCD;">binlog-do-db = </span><span style="color:#82AAFF;">test</span></span>
<span class="line"><span style="color:#A6ACCD;">binlog-ignore-db = mysql,performance_schema,sys,information_schema</span></span>
<span class="line"><span style="color:#A6ACCD;">replicate-do-db=test</span></span>
<span class="line"><span style="color:#A6ACCD;">replicate-ignore-db=mysql,performance_schema,sys,information_schema</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>从库：</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">client</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">socket = /tmp/mysql.sock</span></span>
<span class="line"><span style="color:#A6ACCD;">port=3306</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">mysql</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">default-character-set=utf8</span></span>
<span class="line"><span style="color:#A6ACCD;">socket = /tmp/mysql.sock</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">mysqld</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">socket = /tmp/mysql.sock</span></span>
<span class="line"><span style="color:#A6ACCD;">character-set-server=utf8</span></span>
<span class="line"><span style="color:#A6ACCD;">basedir=/usr/local/mysql-5.7</span></span>
<span class="line"><span style="color:#A6ACCD;">datadir=/opt/mysql_data</span></span>
<span class="line"><span style="color:#A6ACCD;">port=3306</span></span>
<span class="line"><span style="color:#A6ACCD;">pid-file=/opt/mysql_data/mysqld.pid</span></span>
<span class="line"><span style="color:#676E95;"># 四台node不可重复</span></span>
<span class="line"><span style="color:#A6ACCD;">server-id=102</span></span>
<span class="line"><span style="color:#A6ACCD;">log-bin=master-bin</span></span>
<span class="line"><span style="color:#A6ACCD;">relay-log-index=slave-relay-bin.index</span></span>
<span class="line"><span style="color:#A6ACCD;">relay-log=slave-relay-bin</span></span>
<span class="line"><span style="color:#A6ACCD;">binlog_format = MIXED</span></span>
<span class="line"><span style="color:#A6ACCD;">sync_binlog = 1</span></span>
<span class="line"><span style="color:#676E95;">#二进制日志自动删除/过期的天数。默认值为0，表示不自动删除。</span></span>
<span class="line"><span style="color:#A6ACCD;">expire_logs_days =7</span></span>
<span class="line"><span style="color:#A6ACCD;">log_slave_updates = 1</span></span>
<span class="line"><span style="color:#A6ACCD;">binlog-do-db = </span><span style="color:#82AAFF;">test</span></span>
<span class="line"><span style="color:#A6ACCD;">binlog-ignore-db = mysql,performance_schema,sys,information_schema</span></span>
<span class="line"><span style="color:#A6ACCD;">replicate-do-db=test</span></span>
<span class="line"><span style="color:#A6ACCD;">replicate-ignore-db=mysql,performance_schema,sys,information_schema</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>注意：四台 node 中的 my.cnf 中的 server-id 的值不能重复，否则主从会建立失败。</p><blockquote><p>初始化 MySQL</p></blockquote><p>在4个node上执行：</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@101 mysql-5.7</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># mysqld --initialize --user=mysql --basedir=/usr/local/mysql-5.7 --datadir=/opt/mysql_data</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>执行完初始化操作后，会给予root的默认密码，可以在命令行操作页面上看到；</p><p>这里还有重置密码和容许外网登录的步骤，大家自己去解决，此处略过。不做容许外网登录的话，mycat等本地工具是连不上的。</p><blockquote><p>启动mysql</p></blockquote><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@101 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># systemctl start mysqld</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>登陆MySQL 并修改密码</p></blockquote><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@101 ~]# mysql -uroot -p</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>所有mysql增加主从用户</p><p>为什么是所有mysql呢？因为主从可能会切换。</p></blockquote><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#A6ACCD;">mysql</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> grant replication slave on </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">.</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> to </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">repl</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">@</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">%</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> identified by </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">123456</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">mysql</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> flush privileges</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>101 上的 MySQL 执行</p></blockquote><div class="language-sql line-numbers-mode"><button class="copy"></button><span class="lang">sql</span><pre><code><span class="line"><span style="color:#A6ACCD;">mysql</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> show </span><span style="color:#F78C6C;">master</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">status</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#676E95;">------------------+----------+--------------+------------------+-------------------+</span></span>
<span class="line"><span style="color:#A6ACCD;">| </span><span style="color:#F78C6C;">File</span><span style="color:#A6ACCD;"> 			   | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#676E95;">------------------+----------+--------------+------------------+-------------------+</span></span>
<span class="line"><span style="color:#A6ACCD;">| mysql</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">bin.0000020| </span><span style="color:#F78C6C;">234</span><span style="color:#A6ACCD;"> 	  | 			 | 					| 					|</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#676E95;">------------------+----------+--------------+------------------+-------------------+</span></span>
<span class="line"><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">row</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">set</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;"> sec)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>node02、node03 都执行下列语句</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">mysql&gt; change master to master_host=&#39;192.168.232.101&#39;,master_user=&#39;repl&#39;,master_password=&#39;123456&#39;,master_log_file=&#39;mysqlbin.</span></span>
<span class="line"><span style="color:#A6ACCD;">000001&#39;,master_log_pos=154;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>注意：上面的master_log_file和master_log_pos这2个参数， 是和master中的参数要一致的。master如何查看这2个参数呢？在master mysql命令行上运行show master status;</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">mysql&gt; show slave status\G; #查看slave IO和slave sql是否都正常</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果出现下面这个，说明搭建基本OK：</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">Slave_IO_Running: Yes</span></span>
<span class="line"><span style="color:#A6ACCD;">Slave_SQL_Running: Yes</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>验证：</p><p>到101上插入一条数据，查看 102 和 103上面的数据。</p><h2 id="_2-6-mha-构建" tabindex="-1">2.6 MHA 构建 <a class="header-anchor" href="#_2-6-mha-构建" aria-hidden="true">#</a></h2><p>这里演示的vip 是：192.168.232.99</p><p>MHA Manager 配置，在192.168.232.100上：</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#676E95;"># 创建MHA配置文件目录</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># mkdir /etc/mha</span></span>
<span class="line"><span style="color:#676E95;"># 创建MHA脚本目录</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># mkdir /etc/mha/scripts</span></span>
<span class="line"><span style="color:#676E95;"># 创建MHA日志目录</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># mkdir /var/log/mha/</span></span>
<span class="line"><span style="color:#676E95;"># 创建日志目录</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># mkdir /var/log/mha/app1 -p</span></span>
<span class="line"><span style="color:#676E95;"># 创建日志文件</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@100 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># touch /var/log/mha/app1/manager.log</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>MHA 配置文件</strong></p><p>配置文件1：</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#A6ACCD;">vim /etc/mha/app1.cnf</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">server default</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">manager_workdir=/var/log/masterha/app1</span></span>
<span class="line"><span style="color:#A6ACCD;">manager_log=/var/log/masterha/app1/manager.log</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">server1</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">hostname=192.168.232.101</span></span>
<span class="line"><span style="color:#A6ACCD;">port=3306</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">server2</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">hostname=192.168.232.102</span></span>
<span class="line"><span style="color:#A6ACCD;">port=3306</span></span>
<span class="line"><span style="color:#A6ACCD;">candidate_master=1</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">server3</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">hostname=192.168.232.103</span></span>
<span class="line"><span style="color:#A6ACCD;">port=3306</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>上面这个配置主要是一个mysql主从的名单。</p><p>candidate_master=1的意思是是否能提升为master。</p><p>配置文件2：</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">vim /etc/masterha_default.cnf</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[server default]</span></span>
<span class="line"><span style="color:#A6ACCD;">user=root #注释请去掉，避免报错</span></span>
<span class="line"><span style="color:#A6ACCD;">password=123456</span></span>
<span class="line"><span style="color:#A6ACCD;">repl_user=repl</span></span>
<span class="line"><span style="color:#A6ACCD;">repl_password=123456</span></span>
<span class="line"><span style="color:#A6ACCD;">ssh_user=root</span></span>
<span class="line"><span style="color:#A6ACCD;">ping_interval=1</span></span>
<span class="line"><span style="color:#A6ACCD;">master_binlog_dir=/opt/mysql_data</span></span>
<span class="line"><span style="color:#A6ACCD;">manager_workdir=/var/log/mha/app1</span></span>
<span class="line"><span style="color:#A6ACCD;">manager_log=/var/log/mha/manager.log</span></span>
<span class="line"><span style="color:#A6ACCD;">master_ip_failover_script=&quot;/etc/mha/scripts/master_ip_failover&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">master_ip_online_change_script=&quot;/etc/mha/scripts/master_ip_online_change&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">report_script=&quot;/etc/mha/scripts/send_report&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">remote_workdir=/tmp</span></span>
<span class="line"><span style="color:#A6ACCD;">secondary_check_script= /usr/local/bin/masterha_secondary_check -s 192.168.232.101 -s 192.168.232.102 -s 192.168.232.103</span></span>
<span class="line"><span style="color:#A6ACCD;">shutdown_script=&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>MHA主要配置文件说明</p><ul><li>manager_workdir=/var/log/masterha/app1：设置manager的工作目录</li><li>manager_log=/var/log/masterha/app1/manager.log：设置manager的日志文件</li><li>master_binlog_dir=/opt/mysql_data：设置master 保存binlog的位置，以便MHA可以找到master的日志</li><li>master_ip_failover_script=&quot;/etc/mha/scripts/master_ip_failover&quot;：设置自动failover时候的切换脚本</li><li>master_ip_online_change_script=&quot;/etc/mha/scripts/master_ip_online_change&quot;：设置手动切换时候的切换脚本</li><li>user=root：设置监控mysql的用户</li><li>password=dayi123：设置监控mysql的用户，需要授权能够在manager节点远程登录</li><li>ping_interval=1：设置监控主库，发送ping包的时间间隔，默认是3秒，尝试三次没有回应的时候自动进行railover</li><li>remote_workdir=/tmp：设置远端mysql在发生切换时binlog的保存位置</li><li>repl_user=repl ：设置mysql中用于复制的用户密码</li><li>repl_password=replication：设置mysql中用于复制的用户</li><li>report_script=/usr/local/send_report：设置发生切换后发送的报警的脚本</li><li>shutdown_script=&quot;&quot;：设置故障发生后关闭故障主机脚本（该脚本的主要作用是关闭主机放在发生脑裂,这里没有使用）</li><li>ssh_user=root //设置ssh的登录用户名</li><li>candidate_master=1：在节点下设置，设置当前节点为候选的master</li><li>slave check_repl_delay=0 :在节点配置下设置，默认情况下如果一个slave落后master 100M的relay logs的话，MHA将不会选择该slave作为一个新的master；这个选项对于对于设置了candidate_master=1的主机非常有用</li></ul><p><strong>脚本配置</strong></p><p>自动 VIP 管理配置</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@100 ~]# vim /etc/mha/scripts/master_ip_failover</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在配置的时候，注意把下文中的变量$vip和$​key 换成自己的。另外，如果网卡类型不是ens33的，就要把文中的ens33换成自己的</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">#!/usr/bin/env perl</span></span>
<span class="line"><span style="color:#A6ACCD;">use strict;</span></span>
<span class="line"><span style="color:#A6ACCD;">use warnings FATAL =&gt; &#39;all&#39;;</span></span>
<span class="line"><span style="color:#A6ACCD;">use Getopt::Long;</span></span>
<span class="line"><span style="color:#A6ACCD;">my (</span></span>
<span class="line"><span style="color:#A6ACCD;">    $command, $ssh_user, $orig_master_host, $orig_master_ip,</span></span>
<span class="line"><span style="color:#A6ACCD;">    $orig_master_port, $new_master_host, $new_master_ip, $new_master_port</span></span>
<span class="line"><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">my $vip = &#39;192.168.232.99&#39;;</span></span>
<span class="line"><span style="color:#A6ACCD;">my $key = &#39;0&#39;;</span></span>
<span class="line"><span style="color:#A6ACCD;">my $ssh_start_vip = &quot;ifconfig ens33:0 $vip netmask 255.255.255.0 up&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">my $ssh_stop_vip = &quot;/sbin/ifconfig ens33:$key down&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">GetOptions(</span></span>
<span class="line"><span style="color:#A6ACCD;">    &#39;command=s&#39; =&gt; \$command,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &#39;ssh_user=s&#39; =&gt; \$ssh_user,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &#39;orig_master_host=s&#39; =&gt; \$orig_master_host,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &#39;orig_master_ip=s&#39; =&gt; \$orig_master_ip,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &#39;orig_master_port=i&#39; =&gt; \$orig_master_port,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &#39;new_master_host=s&#39; =&gt; \$new_master_host,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &#39;new_master_ip=s&#39; =&gt; \$new_master_ip,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &#39;new_master_port=i&#39; =&gt; \$new_master_port,</span></span>
<span class="line"><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">exit &amp;main();</span></span>
<span class="line"><span style="color:#A6ACCD;">sub main {</span></span>
<span class="line"><span style="color:#A6ACCD;">    print &quot;\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">    if ( $command eq &quot;stop&quot; || $command eq &quot;stopssh&quot; ) {</span></span>
<span class="line"><span style="color:#A6ACCD;">        my $exit_code = 1;</span></span>
<span class="line"><span style="color:#A6ACCD;">        eval {</span></span>
<span class="line"><span style="color:#A6ACCD;">            print &quot;Disabling the VIP on old master: $orig_master_host \n&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">            &amp;stop_vip();</span></span>
<span class="line"><span style="color:#A6ACCD;">            $exit_code = 0;</span></span>
<span class="line"><span style="color:#A6ACCD;">        };</span></span>
<span class="line"><span style="color:#A6ACCD;">        if ($@) {</span></span>
<span class="line"><span style="color:#A6ACCD;">            warn &quot;Got Error: $@\n&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">            exit $exit_code;</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"><span style="color:#A6ACCD;">        exit $exit_code;</span></span>
<span class="line"><span style="color:#A6ACCD;">	}</span></span>
<span class="line"><span style="color:#A6ACCD;">    elsif ( $command eq &quot;start&quot; ) {</span></span>
<span class="line"><span style="color:#A6ACCD;">        eval {</span></span>
<span class="line"><span style="color:#A6ACCD;">            print &quot;Enabling the VIP - $vip on the new master - $new_master_host \n&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">            &amp;start_vip();</span></span>
<span class="line"><span style="color:#A6ACCD;">            $exit_code = 0;</span></span>
<span class="line"><span style="color:#A6ACCD;">        };</span></span>
<span class="line"><span style="color:#A6ACCD;">        if ($@) {</span></span>
<span class="line"><span style="color:#A6ACCD;">            warn $@;</span></span>
<span class="line"><span style="color:#A6ACCD;">            exit $exit_code;</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"><span style="color:#A6ACCD;">        exit $exit_code;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">    elsif ( $command eq &quot;status&quot; ) {</span></span>
<span class="line"><span style="color:#A6ACCD;">        print &quot;Checking the Status of the script.. OK \n&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">        exit 0;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">    else {</span></span>
<span class="line"><span style="color:#A6ACCD;">        &amp;usage();</span></span>
<span class="line"><span style="color:#A6ACCD;">        exit 1;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">sub start_vip() {</span></span>
<span class="line"><span style="color:#A6ACCD;">	`ssh $ssh_user\@$new_master_host \&quot; $ssh_start_vip \&quot;`;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">sub stop_vip() {</span></span>
<span class="line"><span style="color:#A6ACCD;">    return 0 unless ($ssh_user);</span></span>
<span class="line"><span style="color:#A6ACCD;">    `ssh $ssh_user\@$orig_master_host \&quot; $ssh_stop_vip \&quot;`;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">sub usage {</span></span>
<span class="line"><span style="color:#A6ACCD;">	print </span></span>
<span class="line"><span style="color:#A6ACCD;">	&quot;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n&quot;;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>最后给刚刚配置的三个脚本增加执行权限</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@100 ~]# chmod +x /etc/mha/scripts/master_ip_failover</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_2-7-验证-mha-相关操作" tabindex="-1">2.7 验证 MHA 相关操作 <a class="header-anchor" href="#_2-7-验证-mha-相关操作" aria-hidden="true">#</a></h2><blockquote><p>通过 masterha_check_ssh 命令验证ssh 信任登录是否成功</p></blockquote><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@100 mha4mysql-manager-0.58]# masterha_check_ssh --conf=/etc/mha/app1.cnf</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:24 2020 - [info] Reading default configuration from /etc/masterha_default.cnf..</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:24 2020 - [info] Reading application default configuration from /etc/mha/app1.cnf..</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:24 2020 - [info] Reading server configuration from /etc/mha/app1.cnf..</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:24 2020 - [info] Starting SSH connection tests..</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:28 2020 - [debug]</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:24 2020 - [debug] Connecting via SSH from root@192.168.232.101(192.168.232.101:22) to</span></span>
<span class="line"><span style="color:#A6ACCD;">root@192.168.232.102(192.168.232.102:22)..</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:25 2020 - [debug] ok.</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:25 2020 - [debug] Connecting via SSH from root@192.168.232.101(192.168.232.101:22) to</span></span>
<span class="line"><span style="color:#A6ACCD;">root@192.168.232.103(192.168.232.103:22)..</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:27 2020 - [debug] ok.</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:32 2020 - [debug]</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:25 2020 - [debug] Connecting via SSH from root@192.168.232.102(192.168.232.102:22) to</span></span>
<span class="line"><span style="color:#A6ACCD;">root@192.168.232.101(192.168.232.101:22)..</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:30 2020 - [debug] ok.</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:30 2020 - [debug] Connecting via SSH from root@192.168.232.102(192.168.232.102:22) to</span></span>
<span class="line"><span style="color:#A6ACCD;">root@192.168.232.103(192.168.232.103:22)..</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:31 2020 - [debug] ok.</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:32 2020 - [debug]</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:25 2020 - [debug] Connecting via SSH from root@192.168.232.103(192.168.232.103:22) to</span></span>
<span class="line"><span style="color:#A6ACCD;">root@192.168.232.101(192.168.232.101:22)..</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:30 2020 - [debug] ok.</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:30 2020 - [debug] Connecting via SSH from root@192.168.232.103(192.168.232.103:22) to</span></span>
<span class="line"><span style="color:#A6ACCD;">root@192.168.232.102(192.168.232.102:22)..</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:31 2020 - [debug] ok.</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 16:01:32 2020 - [info] All SSH connection tests passed successfully.</span></span>
<span class="line"><span style="color:#A6ACCD;">Use of uninitialized value in exit at /usr/local/bin/masterha_check_ssh line 44.</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>可见验证通过。</p><blockquote><p>通过 masterha_check_repl 命令验证 mysql 主从复制是否成功</p></blockquote><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@100 mha4mysql-manager-0.58]# masterha_check_repl --conf=/etc/mha/app1.cnf</span></span>
<span class="line"><span style="color:#A6ACCD;"># 最后出现以下提示，则表示通过</span></span>
<span class="line"><span style="color:#A6ACCD;">MySQL Replication Health is OK.</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_2-8-启动-mha" tabindex="-1">2.8 启动 MHA <a class="header-anchor" href="#_2-8-启动-mha" aria-hidden="true">#</a></h2><p>初次使用的时候，需要先在master上添加vip，以后就不需要了。</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">ifconfig ens33:0 192.168.232.99 netmask 255.255.255.0 up</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>注意：</p><p>1 、ens33是虚拟机上的网卡名，这里要换成自己的。</p><p>2 、192.168.232.99也要换成自己的。</p></blockquote><p>启动manager, 这一步在manager上操作：</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">nohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null &gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">/var/log/mha/app1/manager.log 2&gt;&amp;1 &amp;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>检查 MHA 状态</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@100 ~]# masterha_check_status --conf=/etc/mha/app1.cnf</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>MHA 的日志保存在/var/log/masterha/app1/manager.log 下</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@localhost mha4mysql-manager-0.58]# tail -f /var/log/mha/app1/manager.log</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 10:49:17 2020 - [info] Reading default configuration from /etc/masterha_default.cnf..</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 10:49:17 2020 - [info] Reading application default configuration from /etc/mha/app1.cnf..</span></span>
<span class="line"><span style="color:#A6ACCD;">Thu Sep 17 10:49:17 2020 - [info] Reading server configuration from /etc/mha/app1.cnf..</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>关闭 MHA</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">masterha_stop --conf=/etc/mha/app1.cnf</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_2-9-宕机测试" tabindex="-1">2.9 宕机测试 <a class="header-anchor" href="#_2-9-宕机测试" aria-hidden="true">#</a></h2><p>手动停止101 的 MySQL master，然后查看其它节点情况。</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@node01 ~]# systemctl stop mysqld</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在192.168.232.102上查看VIP</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@102 ~]# ifconfig | grep 232</span></span>
<span class="line"><span style="color:#A6ACCD;">inet 192.168.232.102 netmask 255.255.255.0 broadcast 192.168.232.255</span></span>
<span class="line"><span style="color:#A6ACCD;">inet 192.168.232.99 netmask 255.255.255.0 broadcast 192.168.232.255</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>发现192.168.232.99已经从192.168.232.101漂移到192.168.232.102上面了。</p><p>在192.168.232.103上查看复制状态：</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@103 ~]# mysql -uroot -p123456 -e &quot;show slave status\G&quot; | egrep &#39;Master_Host&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">mysql: [Warning] Using a password on the command line interface can be insecure.</span></span>
<span class="line"><span style="color:#A6ACCD;">Master_Host: 192.168.232.102</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="/guo-notes/mysql/mysql-50.png" alt="image-20210901223937134"></p><p>如图，发现103已经变成从102复制内容了， 103之前是从101复制内容的。之所以发生变化，是因为101宕机了，所以mha将102提升为master，然后将其他slave的复制源从原先的101转而指向102。</p><p>至此，我们的MHA大功告成了。</p><h2 id="_3、总结" tabindex="-1">3、总结 <a class="header-anchor" href="#_3、总结" aria-hidden="true">#</a></h2><p>MHA 的切换过程,共包括以下的步骤：</p><ol><li>配置文件检查阶段,这个阶段会检查整个集群配置文件配置</li><li>宕机的 master 处理,这个阶段包括虚拟 ip 摘除操作,主机关机操作（由于没有定义power_manager脚本，不会关机）</li><li>复制 dead maste 和最新 slave 相差的 relay log,并保存到 MHA Manger 具体的目录下</li><li>识别含有最新更新的 slave</li><li>应用从 master 保存的二进制日志事件(binlog events)（这点信息对于将故障master修复后加入集群很重要）</li><li>提升一个 slave 为新的 master 进行复制</li><li>使其他的 slave 连接新的 master 进行复制</li></ol></div></div></main><!--[--><!--]--><footer class="VPDocFooter" data-v-37ebe389 data-v-a54a85bd><div class="edit-info" data-v-a54a85bd><!----><div class="last-updated" data-v-a54a85bd><p class="VPLastUpdated" data-v-a54a85bd data-v-f7d51a9c>Last updated: <time datatime="2023-03-31T09:47:16.000Z" data-v-f7d51a9c></time></p></div></div><div class="prev-next" data-v-a54a85bd><div class="pager" data-v-a54a85bd><a class="pager-link prev" href="/guo-notes/classify/mysql/mysql%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.html" data-v-a54a85bd><span class="desc" data-v-a54a85bd>Previous page</span><span class="title" data-v-a54a85bd>十七、mysql读写分离</span></a></div><div class="has-prev pager" data-v-a54a85bd><!----></div></div></footer><!--[--><!--]--></div></div></div></div></div><!----><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"classify_docker_docker compose服务编排.md\":\"7be6f30a\",\"classify_docker_dockerhub和私人仓库.md\":\"bed9d875\",\"classify_docker_dockerfile.md\":\"29ef54ef\",\"classify_docker_docker介绍.md\":\"b4255815\",\"classify_docker_docker命令.md\":\"7969ccdf\",\"classify_docker_docker安装和启动.md\":\"dc1c3fe5\",\"classify_docker_docker架构.md\":\"e5a4ecd6\",\"classify_elasticsearch_elasticsearch介绍.md\":\"451c5853\",\"classify_elasticsearch_elasticsearch.md\":\"1944f5f1\",\"classify_kafka_kafka-php整合.md\":\"ce23f813\",\"classify_kafka_kafka-微服务整合.md\":\"bac7a76c\",\"classify_kafka_kafka.md\":\"1dd2309f\",\"classify_kafka_kafka介绍.md\":\"5bd4fb73\",\"classify_kafka_kafka和rabbitmq对比.md\":\"84f0a4ed\",\"classify_kafka_kafka集群.md\":\"b6c24c09\",\"classify_kafka_kafka零拷贝技术.md\":\"2a831159\",\"classify_kubernetes_dashboard.md\":\"48b78e07\",\"classify_kubernetes_kubernetes介绍.md\":\"5b216781\",\"classify_kubernetes_kubernetes实战入门.md\":\"06400a59\",\"classify_kubernetes_kubernetes资源管理.md\":\"52c3323f\",\"classify_kubernetes_kubernetes集群环境搭建.md\":\"bd6b608f\",\"classify_kubernetes_pod控制器详解.md\":\"dada4222\",\"classify_kubernetes_pod详解.md\":\"ee309e94\",\"classify_kubernetes_service详解.md\":\"e3c610fe\",\"classify_kubernetes_安全认证.md\":\"6761d68d\",\"classify_kubernetes_数据存储.md\":\"81afab76\",\"classify_nginx_nginx.md\":\"e6abcd49\",\"classify_rabbitmq_exchange核心概念.md\":\"ed27c26c\",\"classify_rabbitmq_mq的概念.md\":\"4cda7646\",\"classify_rabbitmq_mq的种类和对比.md\":\"422bb821\",\"classify_rabbitmq_rabbitmq命令行.md\":\"6c7faa54\",\"classify_rabbitmq_rabbitmq工作模式.md\":\"7ab8b615\",\"classify_rabbitmq_rabbitmq应用方案.md\":\"e377a028\",\"classify_rabbitmq_rabbitmq的安装和启动.md\":\"e1da4952\",\"classify_rabbitmq_rabbitmq简介.md\":\"4925564a\",\"classify_rabbitmq_rabbitmq管控台介绍.md\":\"61c9de00\",\"classify_rabbitmq_rabbitmq集群搭建.md\":\"3fac301d\",\"classify_rabbitmq_rabbitmq高级特性.md\":\"3d827819\",\"classify_rabbitmq_rabbitmq高级特性1.md\":\"d89c0033\",\"classify_redis_redis主从.md\":\"e99172fc\",\"classify_redis_redis事务.md\":\"aa7d326a\",\"classify_redis_redis五大数据类型实现原理.md\":\"348da22e\",\"classify_redis_redis介绍.md\":\"02166f36\",\"classify_redis_redis内存回收.md\":\"f359730c\",\"classify_redis_redis内存淘汰策略.md\":\"5cac2db3\",\"classify_redis_redis内存碎片率.md\":\"883e82ce\",\"classify_redis_redis分布式锁.md\":\"c512669b\",\"classify_redis_redis哨兵.md\":\"6a2bd593\",\"classify_redis_redis底层数据结构.md\":\"503a299f\",\"classify_redis_redis慢查询和管道.md\":\"cb855720\",\"classify_redis_redis持久化.md\":\"1b6f23c2\",\"classify_redis_redis数据类型简介.md\":\"937a9562\",\"classify_redis_redis缓存穿透、击穿、雪崩.md\":\"9a14eab8\",\"classify_redis_redis配置文件解析.md\":\"0d511718\",\"classify_redis_redis集群.md\":\"a94427bf\",\"classify_algorithm_concept_复杂度-时间复杂度和空间复杂度.md\":\"f9a54bab\",\"classify_algorithm_concept_数据结构-堆.md\":\"fbf45937\",\"classify_algorithm_concept_数据结构-栈与队列.md\":\"c47d56dc\",\"classify_algorithm_concept_数据结构-树.md\":\"8b6f88f5\",\"classify_algorithm_concept_算法-排序算法.md\":\"11b26095\",\"classify_algorithm_concept_算法-查找算法.md\":\"ae4b2ef6\",\"classify_algorithm_concept_算法-深度优先搜索和广度优先搜索.md\":\"8217d1ee\",\"classify_algorithm_index.md\":\"939e438d\",\"classify_algorithm_title_leetcode-1.md\":\"d3729b05\",\"classify_algorithm_title_leetcode-101.md\":\"81ca5c89\",\"classify_algorithm_title_leetcode-104.md\":\"24301cbb\",\"classify_algorithm_title_leetcode-110.md\":\"6d36e216\",\"classify_algorithm_title_leetcode-141.md\":\"0a31736b\",\"classify_algorithm_title_leetcode-142.md\":\"615bbde0\",\"classify_algorithm_title_leetcode-144.md\":\"040f54d4\",\"classify_algorithm_title_leetcode-145.md\":\"0d2f31a6\",\"classify_algorithm_title_leetcode-160.md\":\"db0f2ad0\",\"classify_algorithm_title_leetcode-206.md\":\"04a71187\",\"classify_algorithm_title_leetcode-21.md\":\"aa0df0ac\",\"classify_algorithm_title_leetcode-226.md\":\"5bb90314\",\"classify_algorithm_title_leetcode-232.md\":\"a8ad64ad\",\"classify_algorithm_title_leetcode-234.md\":\"e9868c62\",\"classify_algorithm_title_leetcode-283.md\":\"ee5b4a97\",\"classify_algorithm_title_leetcode-394.md\":\"e488ba40\",\"classify_algorithm_title_leetcode-448.md\":\"7fa420a4\",\"classify_algorithm_title_leetcode-70.md\":\"e2ac2279\",\"classify_algorithm_title_leetcode-83.md\":\"b5b34d46\",\"classify_algorithm_title_leetcode-876.md\":\"3d294a8f\",\"classify_algorithm_title_leetcode-88.md\":\"846124f2\",\"classify_algorithm_title_leetcode-912.md\":\"0d376b53\",\"classify_algorithm_title_leetcode-94.md\":\"16398acd\",\"classify_algorithm_title_leetcode-模板.md\":\"4a666f7a\",\"classify_algorithm_title_剑指offer-22.md\":\"dd91394b\",\"classify_algorithm_其他-设计.md\":\"99d44b55\",\"classify_algorithm_基础-排序.md\":\"9324cd0c\",\"classify_algorithm_基础数据结构-哈希表.md\":\"fe5c94fb\",\"classify_algorithm_基础数据结构-字符串.md\":\"1033510a\",\"classify_algorithm_基础数据结构-数组.md\":\"1309d443\",\"classify_algorithm_基础数据结构-栈.md\":\"147b3cb7\",\"classify_algorithm_基础数据结构-树.md\":\"57485154\",\"classify_algorithm_基础数据结构-链表.md\":\"2335074f\",\"classify_algorithm_基础数据结构-队列.md\":\"eec8d3ae\",\"classify_algorithm_技巧-双指针.md\":\"6b0f198e\",\"classify_algorithm_数学-斐波那契数列.md\":\"fb837411\",\"classify_algorithm_数学-相遇问题.md\":\"35aa3b37\",\"classify_algorithm_算法-动态规划.md\":\"363663e5\",\"classify_algorithm_算法-广度优先搜索.md\":\"691edf12\",\"classify_algorithm_算法-排序.md\":\"f6d8d613\",\"classify_algorithm_算法-深度优先搜索.md\":\"935f5b2d\",\"classify_algorithm_算法-迭代.md\":\"29ecf281\",\"classify_algorithm_算法-递归.md\":\"25d52423\",\"classify_mysql_mvcc多版本并发控制.md\":\"6bc6c070\",\"classify_mysql_mysql三大日志.md\":\"303245de\",\"classify_mysql_mysql主从复制.md\":\"8dc5405d\",\"classify_mysql_mysql事务.md\":\"234b4984\",\"classify_mysql_mysql介绍.md\":\"810989ba\",\"classify_mysql_mysql分区.md\":\"e301b03c\",\"classify_mysql_mysql分库分表.md\":\"a0e33827\",\"classify_mysql_mysql索引.md\":\"215dc793\",\"classify_mysql_mysql语法.md\":\"d5f61bad\",\"classify_mysql_mysql读写分离.md\":\"10e91362\",\"classify_mysql_mysql负载均衡和高可用.md\":\"c7ec40ee\",\"classify_mysql_mysql锁.md\":\"041f1da9\",\"classify_mysql_sql语句优化.md\":\"10ccffdb\",\"classify_mysql_sql语句执行流程.md\":\"4176dbef\",\"classify_mysql_存储引擎.md\":\"e57a16ce\",\"classify_mysql_性能分析.md\":\"64b815a6\",\"classify_mysql_物理文件.md\":\"9e08e83b\",\"classify_mysql_管理常用工具.md\":\"ce2da950\",\"classify_sundry_concept_存储单位与速率单位.md\":\"599b1548\",\"classify_sundry_concept_性能指标.md\":\"6d6d6fb3\",\"classify_sundry_tools_git_github 连接失败.md\":\"e7dcab9f\",\"classify_sundry_tools_vscode_vscode 启动 debug.md\":\"ded39f31\",\"classify_框架学习_laravel_artisan控制台命令.md\":\"71111802\",\"classify_框架学习_laravel_生命周期相关核心概念.md\":\"f387a26f\",\"classify_解决方案_redis主从存在的问题和解决方案.md\":\"447d1624\",\"classify_解决方案_如何分库分表.md\":\"be4d2317\",\"classify_解决方案_数据库与缓存一致性解决方案.md\":\"7cdb9b69\",\"classify_计算机基础_计算机网络_io模型.md\":\"8780259d\",\"classify_计算机基础_计算机网络_index.md\":\"b77b9816\",\"classify_设计模式.md\":\"8ce7c06c\",\"classify_面试常问_web安全.md\":\"704a6fff\",\"classify_面试常问_一次网络请求的完整过程.md\":\"df8102ec\",\"index.md\":\"25fbd46d\",\"preface_install.md\":\"55d7dc68\",\"preface_preface.md\":\"92296ef0\"}")</script>
    <script type="module" async src="/guo-notes/assets/app.c1658bbb.js"></script>
    
  </body>
</html>