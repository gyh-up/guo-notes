<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>redis集群 | 技术博客，知识分享，学习笔记，问题解决方案</title>
    <meta name="description" content="啊郭的博客">
    <link rel="stylesheet" href="/guo-notes/assets/style.5e0eda6f.css">
    <link rel="modulepreload" href="/guo-notes/assets/app.6bd15930.js">
    <link rel="modulepreload" href="/guo-notes/assets/classify_redis_redis集群.md.dd33bc1b.lean.js">
    
    <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance"),a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-c6a644e1><!--[--><!--]--><!--[--><span tabindex="-1" data-v-151f2593></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-151f2593> Skip to content </a><!--]--><!----><header class="VPNav" data-v-c6a644e1 data-v-a71a30f1><div class="VPNavBar has-sidebar" data-v-a71a30f1 data-v-6f1d18b5><div class="container" data-v-6f1d18b5><div class="VPNavBarTitle has-sidebar" data-v-6f1d18b5 data-v-d5925166><a class="title" href="/guo-notes/" data-v-d5925166><!--[--><!--]--><!----><!--[-->啊郭的博客<!--]--><!--[--><!--]--></a></div><div class="content" data-v-6f1d18b5><!--[--><!--]--><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-6f1d18b5 data-v-f83db6ba><span id="main-nav-aria-label" class="visually-hidden" data-v-f83db6ba>Main Navigation</span><!--[--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-f83db6ba data-v-6ffb57d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-6ffb57d3><span class="text" data-v-6ffb57d3><!----> 后端技术 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-6ffb57d3><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-6ffb57d3><div class="VPMenu" data-v-6ffb57d3 data-v-1c5d0cfc><div class="items" data-v-1c5d0cfc><!--[--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/redis/redis%E4%BB%8B%E7%BB%8D.html" data-v-e8e0fb1d data-v-3c355974><!--[-->Redis<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-f83db6ba data-v-6ffb57d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-6ffb57d3><span class="text" data-v-6ffb57d3><!----> 计算机基础 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-6ffb57d3><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-6ffb57d3><div class="VPMenu" data-v-6ffb57d3 data-v-1c5d0cfc><div class="items" data-v-1c5d0cfc><!--[--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/计算机基础/计算机网络/" data-v-e8e0fb1d data-v-3c355974><!--[-->计算机网络<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/guo-notes/classify/algorithm/" data-v-f83db6ba data-v-47a2263e data-v-3c355974><!--[-->算法<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-6f1d18b5 data-v-a3e7452b><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-a3e7452b data-v-1899cd41 data-v-086e8519><span class="check" data-v-086e8519><span class="icon" data-v-086e8519><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-1899cd41><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-1899cd41><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-6f1d18b5 data-v-738bef5a data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/gyh-up?tab=repositories" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink" href="https://blog.csdn.net/weixin_42258523?spm=1000.2115.3001.5343" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><embed src="https://g.csdnimg.cn/static/logo/favicon32.ico" style="border-radius: 100%;width: 20px;height: 20px;" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-6f1d18b5 data-v-e4361c82 data-v-6ffb57d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-6ffb57d3><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-6ffb57d3><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-6ffb57d3><div class="VPMenu" data-v-6ffb57d3 data-v-1c5d0cfc><!----><!--[--><!--[--><!----><div class="group" data-v-e4361c82><div class="item appearance" data-v-e4361c82><p class="label" data-v-e4361c82>Appearance</p><div class="appearance-action" data-v-e4361c82><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-e4361c82 data-v-1899cd41 data-v-086e8519><span class="check" data-v-086e8519><span class="icon" data-v-086e8519><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-1899cd41><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-1899cd41><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-e4361c82><div class="item social-links" data-v-e4361c82><div class="VPSocialLinks social-links-list" data-v-e4361c82 data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/gyh-up?tab=repositories" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink" href="https://blog.csdn.net/weixin_42258523?spm=1000.2115.3001.5343" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><embed src="https://g.csdnimg.cn/static/logo/favicon32.ico" style="border-radius: 100%;width: 20px;height: 20px;" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6f1d18b5 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-c6a644e1 data-v-aac27d5e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-aac27d5e><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-aac27d5e><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-aac27d5e>Menu</span></button><a class="top-link" href="#" data-v-aac27d5e> Return to top </a></div><aside class="VPSidebar" data-v-c6a644e1 data-v-f332cb62><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-f332cb62><span class="visually-hidden" id="sidebar-aria-label" data-v-f332cb62> Sidebar Navigation </span><!--[--><div class="group" data-v-f332cb62><section class="VPSidebarGroup collapsible" data-v-f332cb62 data-v-35f99ef5><div class="title" role="button" data-v-35f99ef5><h2 class="title-text" data-v-35f99ef5>Redis 学习笔记</h2><div class="action" data-v-35f99ef5><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-35f99ef5><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-35f99ef5><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-35f99ef5><!--[--><!--[--><a class="VPLink link link" href="/guo-notes/classify/redis/redis%E4%BB%8B%E7%BB%8D.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>一、介绍</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/redis/redis%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E7%AE%80%E4%BB%8B.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>二、数据类型简介</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/redis/redis%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>三、底层数据结构</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/redis/redis%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>四、五大数据类型实现原理</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/redis/redis%E5%86%85%E5%AD%98%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>五、redis内存淘汰策略</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/redis/redis%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>六、redis内存回收</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/redis/redis%E5%86%85%E5%AD%98%E7%A2%8E%E7%89%87%E7%8E%87.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>七、redis内存碎片率</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/redis/redis%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E3%80%81%E7%A9%BF%E9%80%8F%E3%80%81%E9%9B%AA%E5%B4%A9.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>八、redis缓存击穿、穿透、雪崩</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/redis/redis%E6%85%A2%E6%9F%A5%E8%AF%A2%E5%92%8C%E7%AE%A1%E9%81%93.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>九、redis慢查询和管道</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/redis/redis%E6%8C%81%E4%B9%85%E5%8C%96.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十、redis持久化</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/redis/redis%E4%BA%8B%E5%8A%A1.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十一、redis事务</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/redis/redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十二、redis分布式锁</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/redis/redis%E4%B8%BB%E4%BB%8E.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十三、redis主从</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/redis/redis%E5%93%A8%E5%85%B5.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十四、redis哨兵</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link active" href="/guo-notes/classify/redis/redis%E9%9B%86%E7%BE%A4.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十五、redis集群</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/redis/redis%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十六、redis配置文件解析</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-c6a644e1 data-v-c95df128><div class="VPDoc has-sidebar has-aside" data-v-c95df128 data-v-37ebe389><div class="container" data-v-37ebe389><div class="aside" data-v-37ebe389><div class="aside-curtain" data-v-37ebe389></div><div class="aside-container" data-v-37ebe389><div class="aside-content" data-v-37ebe389><div class="VPDocAside" data-v-37ebe389 data-v-afc4c1a1><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-afc4c1a1 data-v-2865c0b0><div class="content" data-v-2865c0b0><div class="outline-marker" data-v-2865c0b0></div><div class="outline-title" data-v-2865c0b0>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-2865c0b0><span class="visually-hidden" id="doc-outline-aria-label" data-v-2865c0b0> Table of Contents for current page </span><ul class="root" data-v-2865c0b0 data-v-1188541a><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-afc4c1a1></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-37ebe389><div class="content-container" data-v-37ebe389><!--[--><!--]--><main class="main" data-v-37ebe389><div style="position:relative;" class="vp-doc _guo-notes_classify_redis_redis%E9%9B%86%E7%BE%A4" data-v-37ebe389><div><h1 id="redis集群" tabindex="-1">redis集群 <a class="header-anchor" href="#redis集群" aria-hidden="true">#</a></h1><h2 id="_1、redis-哨兵-主从的问题" tabindex="-1">1、redis 哨兵+主从的问题 <a class="header-anchor" href="#_1、redis-哨兵-主从的问题" aria-hidden="true">#</a></h2><p>假设我们在一台主从机器上配置了200G内存，但是业务需求是需要500G的时候，主从结构+哨兵可以实现高可用故障切换+冗余备份，但是并不能解决数据容量的问题，用哨兵，redis每个实例也是全量存储，每个redis存储的内容都是完整的数据，浪费内存且有木桶效应。</p><p>为了最大化利用内存，可以采用cluster群集，就是分布式存储。即每台redis存储不同的内容。</p><p>Redis 分布式方案一般有三种：</p><h3 id="_1-1、客户端分区方案" tabindex="-1">1.1、客户端分区方案 <a class="header-anchor" href="#_1-1、客户端分区方案" aria-hidden="true">#</a></h3><p>优点是分区逻辑可控，缺点是需要自己处理数据路由、高可用、故障转移等问题，比如在 redis2.8 之前通常的做法是获取某个 key 的 hashcode ，然后取余分布到不同节点，不过这种做法无法很好的支持动态伸缩性需求，一旦节点的增或者删操作，都会导致 key 无法在 redis 中命中。</p><p><img src="/guo-notes/redis/redis-27.png" alt="image-20210827094813294"></p><h3 id="_1-2、代理方案" tabindex="-1">1.2、代理方案 <a class="header-anchor" href="#_1-2、代理方案" aria-hidden="true">#</a></h3><p>优点是简化客户端分布式逻辑和升级维护便利，缺点是加重架构部署复杂度和性能损耗，比如 twemproxy、Codis</p><p><img src="/guo-notes/redis/redis-28.png" alt="image-20210827094901183"></p><h3 id="_1-3、官方提供专有的集群方案" tabindex="-1">1.3、官方提供专有的集群方案 <a class="header-anchor" href="#_1-3、官方提供专有的集群方案" aria-hidden="true">#</a></h3><p><code>Redis Cluster，它非常优雅地解决了 Redis 集群方面的问题，部署方便简单，因此理解应用好 Redis Cluster 将极大地解放我们使用分布式 Redis 的工作量。</code></p><h2 id="_2、redis-cluster" tabindex="-1">2、Redis Cluster <a class="header-anchor" href="#_2、redis-cluster" aria-hidden="true">#</a></h2><h3 id="_2-1、简介" tabindex="-1">2.1、简介 <a class="header-anchor" href="#_2-1、简介" aria-hidden="true">#</a></h3><p>Redis Cluster 是 Redis 的分布式解决方案，在3.0版本正式推出，有效地解决了 Redis 分布式方面的需求。<strong>当遇到单机内存、并发、流量等瓶颈时，可以采用Cluster 架构方案达到负载均衡的目的</strong>。 架构图：</p><p><img src="/guo-notes/redis/redis-29.png" alt="image-20210827105818932"></p><p>在这个图中，每一个蓝色的圈都代表着一个redis的服务器节点。<strong>它们任何两个节点之间都是相互连通的</strong>。客户端可以与任何一个节点相连接，然后就可以访问集群中的任何一个节点，对其进行存取和其他操作。</p><p><strong>Redis 集群提供了以下两个好处：</strong></p><p>1、将数据自动切分到多个节点的能力。</p><p>2、当集群中的一部分节点失效或者无法进行通讯时， 仍然可以继续处理命令请求的能力，拥有自动故障转移的能力。</p><p><strong>redis cluster vs. replication + sentinal如何选择</strong></p><p>如果数据量很少，主要是承载高并发高性能的场景，比如缓存一般就几个G，单机足够了。</p><p>Replication：一个mater，多个slave，需要几个 slave 跟需要的读吞吐量有关系，结合 sentinal 集群，去保证redis 主从架构的高可用性，就可以了。</p><p>redis cluster：主要是针对海量数据+高并发+高可用的场景，海量数据，如果数据量很大，那么建议就用 redis cluster。</p><h3 id="_2-2、哈希分区" tabindex="-1">2.2、哈希分区 <a class="header-anchor" href="#_2-2、哈希分区" aria-hidden="true">#</a></h3><h4 id="_2-2-1、数据分布" tabindex="-1">2.2.1、数据分布 <a class="header-anchor" href="#_2-2-1、数据分布" aria-hidden="true">#</a></h4><p>什么是数据分布？数据分布有两种方式，顺序分区和哈希分区。</p><p>分布式数据库首先要解决把整个数据集按照分区规则映射到多个节点的问题，即把数据集划分到多个节点上，每个节点负责整体数据的一个子集。</p><p>顺序分区就是把一整块数据分散到很多机器中，如下图所示。</p><p><img src="/guo-notes/redis/redis-30.png" alt="image-20210827110133865"></p><p><strong>顺序分区一般都是平均分配的。</strong></p><p><strong>哈希分区</strong></p><p>如下图所示，1~100这整块数字，通过 hash 的函数，取余产生的数。这样可以保证这串数字充分的打散，也保证了均匀的分配到各台机器上。</p><p><img src="/guo-notes/redis/redis-31.png" alt="image-20210827110327136"></p><p>哈希分区和顺序分区只是场景上的适用。哈希分区不能顺序访问，比如你想访问1~100，哈希分区只能遍历全部数据，同时哈希分区因为做了 hash 后导致与业务数据无关了。</p><p><img src="/guo-notes/redis/redis-32.png" alt="image-20210827110442852"></p><p>数据倾斜与数据迁移跟节点伸缩</p><p>顺序分区是会导致数据倾斜的，<strong>主要是访问的倾斜</strong>。每次点击会重点访问某台机器，这就导致最后数据都到这台机器上了，这就是顺序分布最大的缺点。</p><p>但哈希分区其实是有个问题的，当我们要扩容机器的时候，<strong>专业上称之为“节点伸缩”</strong>，这个时候，因为是哈希算法，<strong>会导致数据迁移。</strong></p><h4 id="_2-2-2、节点取余" tabindex="-1">2.2.2、节点取余 <a class="header-anchor" href="#_2-2-2、节点取余" aria-hidden="true">#</a></h4><p>使用特定的数据（包括redis的键或用户ID），再根据节点数量N，使用公式：hash(key)%N 计算出一个0~（N-1）值，用来决定数据映射到哪一个节点上。即哈希值对节点总数取余。</p><p>缺点：<strong>当节点数量N变化时（扩容或者收缩），数据和节点之间的映射关系需要重新计算，</strong> 这样的话，按照新的规则映射，要么之前存储的数据找不到，要么之前数据被重新映射到新的节点（导致以前存储的数据发生数据迁移）</p><p>实践：常用于数据库的分库分表规则，一般采用预分区的方式，提前根据数据量规划好分区数，比如划分为512或1024张表，保证可支撑未来一段时间的数据量，再根据负载情况将表迁移到其他数据库中。</p><h4 id="_2-2-3、一致性哈希" tabindex="-1">2.2.3、一致性哈希 <a class="header-anchor" href="#_2-2-3、一致性哈希" aria-hidden="true">#</a></h4><p>一致性哈希分区（Distributed Hash Table）实现思路是为系统中每个节点分配一个 token，范围一般在0~232，这些 token 构成一个<strong>哈希环</strong>。数据读写执行节点查找操作时，先根据 key 计算 hash 值，然后顺时针找到第一个大于等于该哈希值的 token 节点</p><p><img src="/guo-notes/redis/redis-33.png" alt="image-20210827110910409"></p><p>上图就是一个一致性哈希的原理解析。</p><p>假设我们有 n1~n4 这四台机器，我们对每一台机器分配一个唯一 token，每次有数据（图中黄色代表数据），一致性哈希算法规定每次都顺时针漂移数据，也就是图中黄色的数据都指向 n3。</p><p>这个时候我们需要增加一个节点 n5，在 n2 和 n3 之间，数据还是会发生漂移（会偏移到大于等于的节点），但是这个时候你是否注意到，其实只有 n2~n3 这部分的数据被漂移，其他的数据都是不会变的，<strong>这种方式相比节点取余最大的好处在于加入和删除节点只影响哈希环中相邻的节点，对其他节点无影响</strong></p><p>缺点：每个节点的负载不相同，因为每个节点的hash是根据key计算出来的,换句话说就是假设key足够多，被hash算法打散得非常均匀，但是节点过少，导致每个节点处理的key个数不太一样，甚至相差很大，这就会导致某些节点压力很大</p><p>实践：加减节点会造成哈希环中部分数据无法命中，需要手动处理或者忽略这部分数据，因此一致性哈希常用于缓存场景。</p><h4 id="_2-2-4、虚拟槽分区" tabindex="-1">2.2.4、虚拟槽分区 <a class="header-anchor" href="#_2-2-4、虚拟槽分区" aria-hidden="true">#</a></h4><p><strong>虚拟槽分区</strong>巧妙地使用了哈希空间，使用分散度良好的哈希函数把所有数据映射到一个固定范围的整数集合中，整数定义为槽（slot）。这个范围一般远远大于节点数，比如 Redis Cluster 槽范围是 0~16383 。槽是集群内数据管理和迁移的基本单位。采用大范围槽的主要目的是为了方便数据拆分和集群扩展。每个节点会负责一定数量的槽，下图所示。</p><p>当前集群有5个节点，每个节点平均大约负责3276个槽。由于采用高质量的哈希算法，每个槽所映射的数据通常比较均匀，将数据平均划分到5个节点进行数据分区。<code>Redis Cluster 就是采用虚拟槽分区</code>，下面就介绍 Redis 数据分区方法。</p><p><img src="/guo-notes/redis/redis-34.png" alt="image-20210827111312656"></p><p>每当 key 访问过来，Redis Cluster 会计算哈希值是否在这个区间里。它们彼此都知道对应的槽在哪台机器上，这样就能做到平均分配了。</p><p>集群限制： Key批量操作，mget()</p><h2 id="_3、搭建集群准备" tabindex="-1">3、搭建集群准备 <a class="header-anchor" href="#_3、搭建集群准备" aria-hidden="true">#</a></h2><h3 id="_3-1、准备节点" tabindex="-1">3.1、准备节点 <a class="header-anchor" href="#_3-1、准备节点" aria-hidden="true">#</a></h3><ul><li><strong>性能：</strong> 这是Redis赖以生存的看家本领，增加集群功能后当然不能对性能产生太大影响，所以 Redis 采取了 P2P 而非 Proxy 方式、异步复制、客户端重定向等设计，而牺牲了部分的一致性、使用性。</li><li>水平扩展：集群的最重要能力当然是扩展，文档中称可以线性扩展到 1000 节点。</li><li><strong>可用性：</strong> 在 Cluster 推出之前，可用性要靠 Sentinel 保证。有了集群之后也自动具有了 Sentinel 的监控和自动 Failover 能力。</li></ul><p>Redis 集群一般由多个节点组成，<strong>节点数量至少为6个才能保证组成完整高可用的集群</strong>。每个节点需要开启配置 cluster-enabled yes，让 Redis 运行在集群模式下，上面的配置都相应的给到 redis 的配置文件当中并启动。</p><p>其他配置和单机模式一致即可，配置文件命名规则 redis-{port}.conf ，准备好配置后启动所有节点，第一次启动时如果没有集群配置文件，它会自动创建一份，文件名称采用 <code>cluster-config-file</code> 参数项控制，建议采用 <code>node-{port}.conf</code> 格式定义，也就是说会有两份配置文件。</p><p>当集群内节点信息发生变化，如添加节点、节点下线、故障转移等。节点会自动保存集群状态到配置文件中。需要注意的是，Redis 自动维护集群配置文件，不要手动修改，防止节点重启时产生集群信息错乱。</p><p><strong>集群相关配置如下：</strong></p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">#节点端口</span></span>
<span class="line"><span style="color:#A6ACCD;">port 6379</span></span>
<span class="line"><span style="color:#A6ACCD;">#开启集群模式</span></span>
<span class="line"><span style="color:#A6ACCD;">cluster-enabled yes</span></span>
<span class="line"><span style="color:#A6ACCD;">#节点超时时间，单位毫秒</span></span>
<span class="line"><span style="color:#A6ACCD;">cluster-node-timeout 15000</span></span>
<span class="line"><span style="color:#A6ACCD;">#集群内部配置文件</span></span>
<span class="line"><span style="color:#A6ACCD;">cluster-config-file &quot;nodes-6379.conf&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><img src="/guo-notes/redis/redis-35.png" alt="image-20210827113206961" style="zoom:150%;"><h2 id="_4、搭建集群" tabindex="-1">4、搭建集群 <a class="header-anchor" href="#_4、搭建集群" aria-hidden="true">#</a></h2><h3 id="_4-1、使用-redis5-docker-搭建建群的方式" tabindex="-1">4.1、使用 redis5-docker 搭建建群的方式 <a class="header-anchor" href="#_4-1、使用-redis5-docker-搭建建群的方式" aria-hidden="true">#</a></h3><h4 id="_4-1-1、节点准备" tabindex="-1">4.1.1、节点准备 <a class="header-anchor" href="#_4-1-1、节点准备" aria-hidden="true">#</a></h4><p>首先只需要配置好配置文件</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">bind 0.0.0.0  #访问ip限制，0.0.0.0表示不做限制</span></span>
<span class="line"><span style="color:#A6ACCD;">cluster-enabled yes	#开启集群模式</span></span>
<span class="line"><span style="color:#A6ACCD;">cluster-config-file &quot;/redis/conf/nodes.conf&quot; #集群配置文件路径</span></span>
<span class="line"><span style="color:#A6ACCD;">cluster-node-timeout 5000	#节点超时时间，单位毫秒</span></span>
<span class="line"><span style="color:#A6ACCD;">protected-mode no	#不禁止公网访问redis cache</span></span>
<span class="line"><span style="color:#A6ACCD;">port 6379	#节点端口</span></span>
<span class="line"><span style="color:#A6ACCD;">daemonize no #守护进程模式</span></span>
<span class="line"><span style="color:#A6ACCD;">dir &quot;/redis/data&quot;	#数据路径</span></span>
<span class="line"><span style="color:#A6ACCD;">logfile &quot;/redis/log/redis.log&quot;	#日志路径</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>然后配置好，docker-compose及目录结构</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">cluster</span></span>
<span class="line"><span style="color:#A6ACCD;">	- redis5</span></span>
<span class="line"><span style="color:#A6ACCD;">		- 200</span></span>
<span class="line"><span style="color:#A6ACCD;">			- conf</span></span>
<span class="line"><span style="color:#A6ACCD;">                - redis.conf</span></span>
<span class="line"><span style="color:#A6ACCD;">                - nodes.conf</span></span>
<span class="line"><span style="color:#A6ACCD;">			- data</span></span>
<span class="line"><span style="color:#A6ACCD;">			- log</span></span>
<span class="line"><span style="color:#A6ACCD;">		- 201</span></span>
<span class="line"><span style="color:#A6ACCD;">		- 202</span></span>
<span class="line"><span style="color:#A6ACCD;">        - 203</span></span>
<span class="line"><span style="color:#A6ACCD;">        - 204</span></span>
<span class="line"><span style="color:#A6ACCD;">        - 205</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>docker-compose内容</p><p><strong>注意！ redis 集群中的每个节点都会单独开辟一个 tcp 通道，用于节点之间彼此通信，通信端口号在基础端口上加10000</strong></p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">version: &quot;3.6&quot; # 确定docker-composer文件的版本</span></span>
<span class="line"><span style="color:#A6ACCD;">services: # 代表就是一组服务 - 简单来说一组容器</span></span>
<span class="line"><span style="color:#A6ACCD;">redis_200: # 这个表示服务的名称，可自定义; 注意不是容器名称</span></span>
<span class="line"><span style="color:#A6ACCD;">image: redis5asm # 指定容器的镜像文件</span></span>
<span class="line"><span style="color:#A6ACCD;">networks: ## 引入外部预先定义的网段</span></span>
<span class="line"><span style="color:#A6ACCD;">redis5sm:</span></span>
<span class="line"><span style="color:#A6ACCD;">ipv4_address: 192.160.1.200 #设置ip地址</span></span>
<span class="line"><span style="color:#A6ACCD;">container_name: redis5_cluster_200 # 这是容器的名称</span></span>
<span class="line"><span style="color:#A6ACCD;">ports: # 配置容器与宿主机的端口</span></span>
<span class="line"><span style="color:#A6ACCD;">- &quot;6320:6379&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">- &quot;16320:16379&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">volumes: # 配置数据挂载</span></span>
<span class="line"><span style="color:#A6ACCD;">- /redis_2004/cluster/redis5/200:/redis</span></span>
<span class="line"><span style="color:#A6ACCD;">command: /usr/local/bin/redis-server /redis/conf/redis.conf</span></span>
<span class="line"><span style="color:#A6ACCD;">redis_201: # 这个表示服务的名称，课自定义; 注意不是容器名称</span></span>
<span class="line"><span style="color:#A6ACCD;">image: redis5asm # 指定容器的镜像文件</span></span>
<span class="line"><span style="color:#A6ACCD;">networks: ## 引入外部预先定义的网段</span></span>
<span class="line"><span style="color:#A6ACCD;">redis5sm:</span></span>
<span class="line"><span style="color:#A6ACCD;">ipv4_address: 192.160.1.201 #设置ip地址</span></span>
<span class="line"><span style="color:#A6ACCD;">container_name: redis5_cluster_201 # 这是容器的名称</span></span>
<span class="line"><span style="color:#A6ACCD;">ports: # 配置容器与宿主机的端口</span></span>
<span class="line"><span style="color:#A6ACCD;">- &quot;6321:6379&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">- &quot;16321:16379&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">volumes: # 配置数据挂载</span></span>
<span class="line"><span style="color:#A6ACCD;">- /redis_2004/cluster/redis5/201:/redis</span></span>
<span class="line"><span style="color:#A6ACCD;">command: /usr/local/bin/redis-server /redis/conf/redis.conf</span></span>
<span class="line"><span style="color:#A6ACCD;">redis_202: # 这个表示服务的名称，课自定义; 注意不是容器名称</span></span>
<span class="line"><span style="color:#A6ACCD;">image: redis5asm # 指定容器的镜像文件</span></span>
<span class="line"><span style="color:#A6ACCD;">networks: ## 引入外部预先定义的网段</span></span>
<span class="line"><span style="color:#A6ACCD;">redis5sm:</span></span>
<span class="line"><span style="color:#A6ACCD;">ipv4_address: 192.160.1.202 #设置ip地址</span></span>
<span class="line"><span style="color:#A6ACCD;">container_name: redis5_cluster_202 # 这是容器的名称</span></span>
<span class="line"><span style="color:#A6ACCD;">ports: # 配置容器与宿主机的端口</span></span>
<span class="line"><span style="color:#A6ACCD;">- &quot;6322:6379&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">- &quot;16322:16379&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">volumes: # 配置数据挂载</span></span>
<span class="line"><span style="color:#A6ACCD;">- /redis_2004/cluster/redis5/202:/redis</span></span>
<span class="line"><span style="color:#A6ACCD;">command: /usr/local/bin/redis-server /redis/conf/redis.conf</span></span>
<span class="line"><span style="color:#A6ACCD;">redis_203: # 这个表示服务的名称，课自定义; 注意不是容器名称</span></span>
<span class="line"><span style="color:#A6ACCD;">image: redis5asm # 指定容器的镜像文件</span></span>
<span class="line"><span style="color:#A6ACCD;">networks: ## 引入外部预先定义的网段</span></span>
<span class="line"><span style="color:#A6ACCD;">redis5sm:</span></span>
<span class="line"><span style="color:#A6ACCD;">ipv4_address: 192.160.1.203 #设置ip地址</span></span>
<span class="line"><span style="color:#A6ACCD;">container_name: redis5_cluster_203 # 这是容器的名称</span></span>
<span class="line"><span style="color:#A6ACCD;">ports: # 配置容器与宿主机的端口</span></span>
<span class="line"><span style="color:#A6ACCD;">- &quot;6323:6379&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">- &quot;16323:16379&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">volumes: # 配置数据挂载</span></span>
<span class="line"><span style="color:#A6ACCD;">- /redis_2004/cluster/redis5/203:/redis</span></span>
<span class="line"><span style="color:#A6ACCD;">command: /usr/local/bin/redis-server /redis/conf/redis.conf</span></span>
<span class="line"><span style="color:#A6ACCD;">redis_204: # 这个表示服务的名称，课自定义; 注意不是容器名称</span></span>
<span class="line"><span style="color:#A6ACCD;">image: redis5asm # 指定容器的镜像文件</span></span>
<span class="line"><span style="color:#A6ACCD;">networks: ## 引入外部预先定义的网段</span></span>
<span class="line"><span style="color:#A6ACCD;">redis5sm:</span></span>
<span class="line"><span style="color:#A6ACCD;">ipv4_address: 192.160.1.204 #设置ip地址</span></span>
<span class="line"><span style="color:#A6ACCD;">container_name: redis5_cluster_204 # 这是容器的名称</span></span>
<span class="line"><span style="color:#A6ACCD;">ports: # 配置容器与宿主机的端口</span></span>
<span class="line"><span style="color:#A6ACCD;">- &quot;6324:6379&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">- &quot;16324:16379&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">volumes: # 配置数据挂载</span></span>
<span class="line"><span style="color:#A6ACCD;">- /redis_2004/cluster/redis5/204:/redis</span></span>
<span class="line"><span style="color:#A6ACCD;">command: /usr/local/bin/redis-server /redis/conf/redis.conf</span></span>
<span class="line"><span style="color:#A6ACCD;">redis_205: # 这个表示服务的名称，课自定义; 注意不是容器名称</span></span>
<span class="line"><span style="color:#A6ACCD;">image: redis5asm # 指定容器的镜像文件</span></span>
<span class="line"><span style="color:#A6ACCD;">networks: ## 引入外部预先定义的网段</span></span>
<span class="line"><span style="color:#A6ACCD;">redis5sm:</span></span>
<span class="line"><span style="color:#A6ACCD;">ipv4_address: 192.160.1.205 #设置ip地址</span></span>
<span class="line"><span style="color:#A6ACCD;">container_name: redis5_cluster_205 # 这是容器的名称</span></span>
<span class="line"><span style="color:#A6ACCD;">ports: # 配置容器与宿主机的端口</span></span>
<span class="line"><span style="color:#A6ACCD;">- &quot;6325:6379&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">- &quot;16325:16379&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">volumes: # 配置数据挂载</span></span>
<span class="line"><span style="color:#A6ACCD;">- /redis_2004/cluster/redis5/205:/redis</span></span>
<span class="line"><span style="color:#A6ACCD;">command: /usr/local/bin/redis-server /redis/conf/redis.conf</span></span>
<span class="line"><span style="color:#A6ACCD;"># 网段设置</span></span>
<span class="line"><span style="color:#A6ACCD;">networks:</span></span>
<span class="line"><span style="color:#A6ACCD;">#引用外部预先定义好的网段</span></span>
<span class="line"><span style="color:#A6ACCD;">redis5sm:</span></span>
<span class="line"><span style="color:#A6ACCD;">external:</span></span>
<span class="line"><span style="color:#A6ACCD;">name: redis5sm</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br></div></div><h4 id="_4-1-2、集群搭建" tabindex="-1">4.1.2、集群搭建 <a class="header-anchor" href="#_4-1-2、集群搭建" aria-hidden="true">#</a></h4><p>创建容器</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost redis5</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># docker-compose up -d</span></span>
<span class="line"><span style="color:#A6ACCD;">Creating redis5_cluster_200 ... </span><span style="color:#89DDFF;">done</span></span>
<span class="line"><span style="color:#A6ACCD;">.........</span></span>
<span class="line"><span style="color:#A6ACCD;">Creating redis5_cluster_205 ... </span><span style="color:#89DDFF;">done</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>查看容器</p><div class="language-sh line-numbers-mode"><button class="copy"></button><span class="lang">sh</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost redis5</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># docker ps</span></span>
<span class="line"><span style="color:#A6ACCD;">CONTAINER ID IMAGE COMMAND CREATED STATUS PORTSNAMES</span></span>
<span class="line"><span style="color:#A6ACCD;">4308ac04cf14 redis5asm </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/usr/local/bin/redi…</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> 3 seconds ago Up 2 seconds 0.0.0.0:6321-</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">6379/tcp,</span></span>
<span class="line"><span style="color:#A6ACCD;">0.0.0.0:16321-</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">16379/tcp redis5_cluster_200</span></span>
<span class="line"><span style="color:#A6ACCD;">.........</span></span>
<span class="line"><span style="color:#A6ACCD;">4308ac04cf14 redis5asm </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/usr/local/bin/redi…</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> 3 seconds ago Up 2 seconds 0.0.0.0:6321-</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">6379/tcp,</span></span>
<span class="line"><span style="color:#A6ACCD;">0.0.0.0:16321-</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">16379/tcp redis5_cluster_205</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>进入其中容器，并搭建集群</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;">#进入容器</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost redis5</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># docker exec -it redis5_cluster_200 sh </span></span>
<span class="line"><span style="color:#676E95;">#查看集群配置文件</span></span>
<span class="line"><span style="color:#A6ACCD;">/ </span><span style="color:#676E95;"># cat /redis/log/nodes.conf	</span></span>
<span class="line"><span style="color:#A6ACCD;">a163aee6c9a5695f8d98828a850ca851afd73ea6 :0@0 myself,master - 0 0 0 connected vars currentEpoch 0 lastVoteEpoch 0</span></span>
<span class="line"><span style="color:#676E95;">##创建集群，后节集群节点即可，cluster-replicas 参数为数字，1表示每个主节点需要1个从节点</span></span>
<span class="line"><span style="color:#A6ACCD;">/ </span><span style="color:#676E95;"># redis-cli --cluster create 192.160.1.200:6379 192.160.1.201:6379 192.160.1.202:6379 192.160.1.203:6379 192.160.1.204:6379 192.160.1.205:6379 --cluster-replicas 1	</span></span>
<span class="line"><span style="color:#676E95;">#reids5会自动分配节点和数据槽</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Performing </span><span style="color:#82AAFF;">hash</span><span style="color:#A6ACCD;"> slots allocation on 6 nodes...</span></span>
<span class="line"><span style="color:#A6ACCD;">Master</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">0</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> -</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> Slots 0 - 5460</span></span>
<span class="line"><span style="color:#A6ACCD;">Master</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">1</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> -</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> Slots 5461 - 10922</span></span>
<span class="line"><span style="color:#A6ACCD;">Master</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">2</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> -</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> Slots 10923 - 16383</span></span>
<span class="line"><span style="color:#A6ACCD;">Adding replica 192.160.1.204:6379 to 192.160.1.200:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">Adding replica 192.160.1.205:6379 to 192.160.1.201:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">Adding replica 192.160.1.203:6379 to 192.160.1.202:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">M: a163aee6c9a5695f8d98828a850ca851afd73ea6 192.160.1.200:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">slots:</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">0-5460</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">5461 slots</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> master</span></span>
<span class="line"><span style="color:#A6ACCD;">M: 3e992bd376701b9f58dcb77082606d4796e4ba0a 192.160.1.201:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">slots:</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">5461-10922</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">5462 slots</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> master</span></span>
<span class="line"><span style="color:#A6ACCD;">M: 8480eccf92eb45d66d9344982460678444618ea9 192.160.1.202:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">slots:</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">10923-16383</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">5461 slots</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> master</span></span>
<span class="line"><span style="color:#A6ACCD;">S: a68508720542496d71cc675ebedf2ebaed956726 192.160.1.203:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">replicates 8480eccf92eb45d66d9344982460678444618ea9</span></span>
<span class="line"><span style="color:#A6ACCD;">S: bc8175b99a6030e3029a8fddf3acb0ac550ed07d 192.160.1.204:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">replicates a163aee6c9a5695f8d98828a850ca851afd73ea6</span></span>
<span class="line"><span style="color:#A6ACCD;">S: 8057c014c56c1f0bbf7db66bb5bca81744dce85a 192.160.1.205:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">replicates 3e992bd376701b9f58dcb77082606d4796e4ba0a</span></span>
<span class="line"><span style="color:#676E95;">#是否按上诉配置主从、节点数据槽</span></span>
<span class="line"><span style="color:#A6ACCD;">Can I </span><span style="color:#82AAFF;">set</span><span style="color:#A6ACCD;"> the above configuration</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">type </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">yes</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> to accept</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">: yes</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Nodes configuration updated</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Assign a different config epoch to each node</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span></span>
<span class="line"><span style="color:#A6ACCD;">Waiting </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> the cluster to join</span></span>
<span class="line"><span style="color:#A6ACCD;">...</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Performing Cluster Check </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">using node 192.160.1.200:6379</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">M: a163aee6c9a5695f8d98828a850ca851afd73ea6 192.160.1.200:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">slots:</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">0-5460</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">5461 slots</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> master</span></span>
<span class="line"><span style="color:#A6ACCD;">...................</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">OK</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> All 16384 slots covered.</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h4 id="_4-1-3、集群扩容" tabindex="-1">4.1.3、集群扩容 <a class="header-anchor" href="#_4-1-3、集群扩容" aria-hidden="true">#</a></h4><p>扩容是分布式存储最常见的需求，Redis 集群扩容操作可分为如下步骤：</p><ol><li>准备新节点。</li><li>加入集群。</li><li>迁移槽和数据。</li></ol><h5 id="准备新节点" tabindex="-1">准备新节点 <a class="header-anchor" href="#准备新节点" aria-hidden="true">#</a></h5><p>需要提前准备好新节点并运行在集群模式下，新节点建议跟集群内的节点配置保持一致，便于管理统一。</p><p>192.160.1.100:6379、192.160.1.101:6379（生成容器具体操作同上）</p><h5 id="加入集群" tabindex="-1">加入集群 <a class="header-anchor" href="#加入集群" aria-hidden="true">#</a></h5><p>这里我们可以先了解一下 redis5.0 给我们提供的集群命令 <code>redis-cli --cluster help</code></p><p>在 redis5 中，并不需要像 redis4 之前的管理方式需要通过 redis-trib 管理集群</p><p>当然你也可以使用 cluster meet ip port 进行集群之间的感知也是一样的</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">redis-cli -h 192.160.1.200 --cluster add-node 192.160.1.100:6379 192.160.1.200:6379	</span></span>
<span class="line"><span style="color:#A6ACCD;">redis-cli -h 192.160.1.200 --cluster add-node 192.160.1.101:6379 192.160.1.100:6379 --cluster-slave</span></span>
<span class="line"><span style="color:#A6ACCD;">redis-cli -h 192.160.1.200 cluster nodes</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>具体执行如下</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost new</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.200 cluster nodes #查看现有集群节点</span></span>
<span class="line"><span style="color:#A6ACCD;">8480eccf92eb45d66d9344982460678444618ea9 192.160.1.202:6379@16379 slave a68508720542496d71cc675ebedf2ebaed956726 0 1590127254061 7 connected</span></span>
<span class="line"><span style="color:#A6ACCD;">......</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost new</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.200 --cluster add-node 192.160.1.100:6379 192.160.1.200:6379 #添加新节点100 到集群 200中（此处可以是任意一个已加入集群中的节点ip）</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Adding node 192.160.1.100:6379 to cluster 192.160.1.200:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Performing Cluster Check </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">using node 192.160.1.200:6379</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">M: a163aee6c9a5695f8d98828a850ca851afd73ea6 192.160.1.200:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">    slots:</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">0-5460</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">5461 slots</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> master</span></span>
<span class="line"><span style="color:#A6ACCD;">    1 additional replica</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">S: 8480eccf92eb45d66d9344982460678444618ea9 192.160.1.202:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">    slots: </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">0 slots</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> slave</span></span>
<span class="line"><span style="color:#A6ACCD;">    replicates a68508720542496d71cc675ebedf2ebaed956726</span></span>
<span class="line"><span style="color:#A6ACCD;">.......................</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">OK</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> All nodes agree about slots configuration.</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Check </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> open slots...</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Check slots coverage...</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">OK</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> All 16384 slots covered.</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Send CLUSTER MEET to node 192.160.1.100:6379 to make it join the cluster.</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">OK</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> New node added correctly. </span><span style="color:#676E95;">#提示新节点100添加成功</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost new</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.200 cluster nodes #查看集群节点，100已加入集群中</span></span>
<span class="line"><span style="color:#A6ACCD;">8480eccf92eb45d66d9344982460678444618ea9 192.160.1.202:6379@16379 slave a68508720542496d71cc675ebedf2ebaed956726 0 1590127277000 7 connected</span></span>
<span class="line"><span style="color:#A6ACCD;">...............</span></span>
<span class="line"><span style="color:#A6ACCD;">8b3cb12997b92b1de19a3d6bfdaf0a3ff8f13e47 192.160.1.100:6379@16379 master - 0 1590127275522 0 connected</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost new</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.200 --cluster add-node 192.160.1.101:6379 192.160.1.100:6379 --cluster-slave	#添加节点101，作为节点100的从节点</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Adding node 192.160.1.101:6379 to cluster 192.160.1.100:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Performing Cluster Check </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">using node 192.160.1.100:6379</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">M: 8b3cb12997b92b1de19a3d6bfdaf0a3ff8f13e47 192.160.1.100:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">	slots: </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">0 slots</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> master</span></span>
<span class="line"><span style="color:#A6ACCD;">S: 8480eccf92eb45d66d9344982460678444618ea9 192.160.1.202:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">    slots: </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">0 slots</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> slave</span></span>
<span class="line"><span style="color:#A6ACCD;">    replicates a68508720542496d71cc675ebedf2ebaed956726</span></span>
<span class="line"><span style="color:#A6ACCD;">.......................</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Configure node as replica of 192.160.1.100:6379.</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">OK</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> New node added correctly.</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost new</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.200 cluster nodes #查看节点，从节点101添加成功</span></span>
<span class="line"><span style="color:#A6ACCD;">8480eccf92eb45d66d9344982460678444618ea9 192.160.1.202:6379@16379 slave a68508720542496d71cc675ebedf2ebaed956726 0 1590127308000 7 connected</span></span>
<span class="line"><span style="color:#A6ACCD;">.......................</span></span>
<span class="line"><span style="color:#A6ACCD;">8b3cb12997b92b1de19a3d6bfdaf0a3ff8f13e47 192.160.1.100:6379@16379 master - 0 1590127307520 0 connected</span></span>
<span class="line"><span style="color:#A6ACCD;">0e41a25c96818d43a8e8576e28788a26f2ed27b4 192.160.1.101:6379@16379 slave 8b3cb12997b92b1de19a3d6bfdaf0a3ff8f13e47 0 1590127308640 0 connected</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>在 redis5 中这一过程因为对 redis-cli 的命令优化而变得异常的简单；</p><p>对于节点在加入的时候集群内，经过一段时间的 ping/pong 消息通信指挥，所有节点会发现新的节点并将它们的状态保存到本地。<strong>但是因为是刚刚加入的主节点，没有分配槽，所以还是不能接任何读写操作。</strong></p><h5 id="迁移槽和数据" tabindex="-1">迁移槽和数据 <a class="header-anchor" href="#迁移槽和数据" aria-hidden="true">#</a></h5><p><strong>加入集群后需要为新节点迁移槽和相关数据，槽在迁移过程中集群可以正常提供读写服务，迁移过程是集群扩容最核心的环节，</strong> 下面详细讲解。</p><h6 id="_1、重新分配哈希槽" tabindex="-1">1、重新分配哈希槽 <a class="header-anchor" href="#_1、重新分配哈希槽" aria-hidden="true">#</a></h6><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">redis-cli -h 192.160.1.100 --cluster reshard 192.160.1.200:6379</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这个 192.160.1.200:6379 是可以随意一个节点都可以（有效主节点）；</p><h6 id="_2、给新节点分配槽" tabindex="-1">2、给新节点分配槽 <a class="header-anchor" href="#_2、给新节点分配槽" aria-hidden="true">#</a></h6><p>输入要分配多少个哈希槽（数量）？比如我要分配4000个哈希槽</p><p><img src="/guo-notes/redis/redis-48.png" alt="image-20210829005904627"></p><p>输入指定要分配哈希槽的节点ID</p><p><img src="/guo-notes/redis/redis-49.png" alt="image-20210829010330690"></p><p>分配哈希槽有两种方式</p><ol><li>all : 将所有节点用作哈希槽的源节点</li><li>done : 在指定的节点拿出指定数量的哈希槽分配到目标节点</li></ol><p><img src="/guo-notes/redis/redis-50.png" alt="image-20210829010522490"></p><h4 id="_4-1-4、收缩集群" tabindex="-1">4.1.4、收缩集群 <a class="header-anchor" href="#_4-1-4、收缩集群" aria-hidden="true">#</a></h4><p>收缩集群意味着缩减规模，需要从现有集群中安全下线部分节点，下线节点过程如下</p><img src="/guo-notes/redis/redis-51.png" alt="image-20210829011934340" style="zoom:67%;"><ul><li>1）首先需要确定下线节点是否有负责的槽，如果是，需要把槽迁移到其他节点，保证节点下线后整个集群槽节点映射的完整性。</li><li>2）当下线节点不再负责槽或者本身是从节点时，就可以通知集群内其他节点忘记下线节点，当所有的节点忘记该节点后可以正常关闭。</li></ul><h5 id="下线迁移槽" tabindex="-1">下线迁移槽 <a class="header-anchor" href="#下线迁移槽" aria-hidden="true">#</a></h5><p><strong>下线节点需要把自己负责的槽迁移到其他节点，</strong> 原理与之前节点扩容的迁移槽过程一致，但是过程收缩正好和扩容迁移方向相反，下线节点变为源节点，其他主节点变为目标节点，源节点需要把自身负责的4096个槽均匀地迁移到其他主节点上。</p><h6 id="删除一个slave节点" tabindex="-1">删除一个Slave节点 <a class="header-anchor" href="#删除一个slave节点" aria-hidden="true">#</a></h6><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@localhost new]# redis-cli -h 192.160.1.100 --cluster del-node 192.160.1.101:6379 a3107383b2f749381ea1aece64f4ba0e0e260097</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Removing node a3107383b2f749381ea1aece64f4ba0e0e260097 from cluster 192.160.1.101:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; SHUTDOWN the node.</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h6 id="移动槽节点" tabindex="-1">移动槽节点 <a class="header-anchor" href="#移动槽节点" aria-hidden="true">#</a></h6><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@localhost new]# redis-cli -h 192.160.1.100 --cluster reshard 192.160.1.100:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Performing Cluster Check (using node 192.160.1.100:6379)</span></span>
<span class="line"><span style="color:#A6ACCD;">...</span></span>
<span class="line"><span style="color:#A6ACCD;">[OK] All nodes agree about slots configuration.</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Check for open slots...</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Check slots coverage...</span></span>
<span class="line"><span style="color:#A6ACCD;">[OK] All 16384 slots covered.</span></span>
<span class="line"><span style="color:#A6ACCD;">How many slots do you want to move (from 1 to 16384)? 999</span></span>
<span class="line"><span style="color:#A6ACCD;">What is the receiving node ID? de97e718fc3af097ecc38e15e360aaf40835780a</span></span>
<span class="line"><span style="color:#A6ACCD;">Please enter all the source node IDs.</span></span>
<span class="line"><span style="color:#A6ACCD;">Type &#39;all&#39; to use all the nodes as source nodes for the hash slots.</span></span>
<span class="line"><span style="color:#A6ACCD;">Type &#39;done&#39; once you entered all the source nodes IDs.</span></span>
<span class="line"><span style="color:#A6ACCD;">Source node #1: 5252b857cf46af189979a7aaf5d18ae314e44b4d</span></span>
<span class="line"><span style="color:#A6ACCD;">Source node #2: done</span></span>
<span class="line"><span style="color:#A6ACCD;">[root@localhost new]# redis-cli -h 192.160.1.100 cluster slots</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h6 id="删除主节点" tabindex="-1">删除主节点 <a class="header-anchor" href="#删除主节点" aria-hidden="true">#</a></h6><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@localhost new]# redis-cli -h 192.160.1.100 --cluster del-node 192.160.1.100:6379 5252b857cf46af189979a7aaf5d18ae314e44b4d</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Removing node 5252b857cf46af189979a7aaf5d18ae314e44b4d from cluster 192.160.1.100:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; SHUTDOWN the node.</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h6 id="检查集群" tabindex="-1">检查集群 <a class="header-anchor" href="#检查集群" aria-hidden="true">#</a></h6><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost new</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.200 --cluster check 192.160.1.200:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">192.160.1.200:6379 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">982285a0...</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> -</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> 0 keys </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> 3877 slots </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> 1 slaves.</span></span>
<span class="line"><span style="color:#A6ACCD;">192.160.1.202:6379 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">de97e718...</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> -</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> 0 keys </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> 4876 slots </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> 1 slaves.</span></span>
<span class="line"><span style="color:#A6ACCD;">192.160.1.201:6379 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">6aef721d...</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> -</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> 0 keys </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> 7631 slots </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> 1 slaves.</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">OK</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> 0 keys </span><span style="color:#89DDFF;">in</span><span style="color:#A6ACCD;"> 3 masters.</span></span>
<span class="line"><span style="color:#A6ACCD;">0.00 keys per slot on average.</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Performing Cluster Check </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">using node 192.160.1.200:6379</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">....</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">OK</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> All nodes agree about slots configuration.</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Check </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> open slots...</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Check slots coverage...</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">OK</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> All 16384 slots covered.</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h6 id="平衡（rebalance）slot" tabindex="-1">平衡（rebalance）slot <a class="header-anchor" href="#平衡（rebalance）slot" aria-hidden="true">#</a></h6><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost new</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.200 --cluster rebalance 192.160.1.200:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Performing Cluster Check </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">using node 192.160.1.200:6379</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">OK</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> All nodes agree about slots configuration.</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h6 id="检查集群-1" tabindex="-1">检查集群 <a class="header-anchor" href="#检查集群-1" aria-hidden="true">#</a></h6><p>每个节点的槽数量平均</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost new</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.200 --cluster check 192.160.1.200:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">192.160.1.200:6379 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">982285a0...</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> -</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> 0 keys </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> 5462 slots </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> 1 slaves.</span></span>
<span class="line"><span style="color:#A6ACCD;">192.160.1.202:6379 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">de97e718...</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> -</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> 0 keys </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> 5461 slots </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> 1 slaves.</span></span>
<span class="line"><span style="color:#A6ACCD;">192.160.1.201:6379 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">6aef721d...</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> -</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> 0 keys </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> 5461 slots </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> 1 slaves.</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">OK</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> 0 keys </span><span style="color:#89DDFF;">in</span><span style="color:#A6ACCD;"> 3 masters.</span></span>
<span class="line"><span style="color:#A6ACCD;">0.00 keys per slot on average.</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Performing Cluster Check </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">using node 192.160.1.200:6379</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">...</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">OK</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> All nodes agree about slots configuration.</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Check </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> open slots...</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; Check slots coverage...</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">OK</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> All 16384 slots covered.</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>其他命令说明：</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#A6ACCD;">-- 集群信息查看</span></span>
<span class="line"><span style="color:#A6ACCD;">redis-cli --cluster info ip:port</span></span>
<span class="line"><span style="color:#A6ACCD;">-- 修复集群</span></span>
<span class="line"><span style="color:#A6ACCD;">redis-cli --cluster fix ip:port</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_4-2、请求重定向" tabindex="-1">4.2、请求重定向 <a class="header-anchor" href="#_4-2、请求重定向" aria-hidden="true">#</a></h3><p>目前已经搭建好 redis 集群并且能理解了通信和伸缩细节，但是还没有使用客户端去操作集群。redis 集群对客户端通信协议做了比较大的修改，为了追求性能最大化，并没有采用代理方式而是采用客户端直接连节点的方式。</p><p>在集群模式下，Redis 接收任何键相关命令时首先计算键对应的槽，再根据槽找出所对应的节点，如果节点是自身，则处理键命令；否则回复 <code>MOVED 重定向</code>错误，通知客户端请求正确的节点。<strong>这个过程称为 MOVED 重定向。</strong></p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.200</span></span>
<span class="line"><span style="color:#A6ACCD;">192.160.1.200:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">set</span><span style="color:#A6ACCD;"> name h</span></span>
<span class="line"><span style="color:#A6ACCD;">OK</span></span>
<span class="line"><span style="color:#A6ACCD;">192.160.1.200:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">set</span><span style="color:#A6ACCD;"> nayi h</span></span>
<span class="line"><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">error</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> MOVED 6301 192.160.1.202:6379</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><img src="/guo-notes/redis/redis-52.png" alt="image-20210829015259060" style="zoom:80%;"><p>执行set命令成功因为刚刚好对应的槽位于我们的节点上，但是后面失败是因为不在我们的节点上；可以通过<code>cluster keyslot {key} </code>命令返回key所对应的槽</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#A6ACCD;">192.160.1.200:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> cluster keyslot nayi</span></span>
<span class="line"><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">integer</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> 6301</span></span>
<span class="line"><span style="color:#A6ACCD;">192.160.1.200:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> cluster nodes</span></span>
<span class="line"><span style="color:#A6ACCD;">3234c63811c6c9c238c16a958d8433069d21d08f 192.160.1.204:6379@16379 slave 982285a0f4e1d1b6c861fdce379905bebc6402c5 0 1590152389000 11 connected</span></span>
<span class="line"><span style="color:#A6ACCD;">f433f9940fa8ce7492e3ead56112562d355dd24a 192.160.1.205:6379@16379 slave 6aef721d84d66c2b9a4f0d40ad5c8c3c7fa1c05b 0 1590152389598 8 connected</span></span>
<span class="line"><span style="color:#A6ACCD;">982285a0f4e1d1b6c861fdce379905bebc6402c5 192.160.1.200:6379@16379 myself,master - 0 1590152389000 11 connected 497-1332 1584-6209</span></span>
<span class="line"><span style="color:#A6ACCD;">de97e718fc3af097ecc38e15e360aaf40835780a 192.160.1.202:6379@16379 master - 0 1590152389000 12 connected 0-496 1333-1583 6210-6794 12256-</span></span>
<span class="line"><span style="color:#A6ACCD;">16383</span></span>
<span class="line"><span style="color:#A6ACCD;">4f57a888737be4291571948799af0afe3c4c0dbd 192.160.1.203:6379@16379 slave de97e718fc3af097ecc38e15e360aaf40835780a 0 1590152389000 12 connected</span></span>
<span class="line"><span style="color:#A6ACCD;">6aef721d84d66c2b9a4f0d40ad5c8c3c7fa1c05b 192.160.1.201:6379@16379 master - 0 1590152390012 8 connected 6795-12255</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在正常模式下我们可以根据 <code>MOVED {slot} {ip:port} </code> 的信息找到对应的节点信息，并连接。</p><p>当然在 -c 的命令下就会自动切换</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.200 -c</span></span>
<span class="line"><span style="color:#A6ACCD;">192.160.1.200:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">set</span><span style="color:#A6ACCD;"> nayi h</span></span>
<span class="line"><span style="color:#A6ACCD;">-</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> Redirected to slot </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">6301</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> located at 192.160.1.202:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">OK</span></span>
<span class="line"><span style="color:#A6ACCD;">192.160.1.202:</span><span style="color:#89DDFF;">6379&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>redis-cli 自动帮我们连接到正确的节点执行命令，这个过程是载入 redis-cli 内部维护，实际上就是在 redis-cli 接收到 MOVED 信息之后再次发起请求，并不在 Redis 节点中完成请求转发。节点对于不属于它的键命令只回复重定向响应，并不负责转发。</p><p>键命令执行步骤：计算槽，查找槽所对应的节点</p><h3 id="_4-3、集群的批量操作-hash-tag" tabindex="-1">4.3、集群的批量操作 hash_tag <a class="header-anchor" href="#_4-3、集群的批量操作-hash-tag" aria-hidden="true">#</a></h3><p>redis 首先需要计算键对应的槽。根据键的有效部分使用 CRC16 函数计算出散列值，再取对 16383 的余数，使每个键都可以映射到 0~16383 槽范围内。这样不利于进行批量操作（mget 等操作）</p><p><strong>如果键内容包含 { 和 } 大括号字符，则计算槽的有效部分是大括号的内容；</strong> 否则采用简单全部内容计算槽。</p><p>cluster keyslot 命令就是采用 keyHashSlot 函数实现的</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.200</span></span>
<span class="line"><span style="color:#A6ACCD;">192.160.1.200:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> cluster keyslot ytl</span></span>
<span class="line"><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">integer</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> 12078</span></span>
<span class="line"><span style="color:#A6ACCD;">192.160.1.200:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> cluster keyslot y{t}l</span></span>
<span class="line"><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">integer</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> 15891</span></span>
<span class="line"><span style="color:#A6ACCD;">192.160.1.200:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> cluster keyslot t</span></span>
<span class="line"><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">integer</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> 15891</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>cluster keyslot y{t}l =&gt; cluster keyslot key{hash_tag}</code> 这大括号中的内容叫做 hash_tag，它提供不同的键可以具备相同 slot 的功能，常用批量操作；</p><p>比如在集群模式下使用 mset/mget 等命令优化批量调用时，键列表必须具有同的 slot，否则会报错，这个时候可以利用 hash_tag 让不同的键具有相同的 slot 达到目的；</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.200 -c</span></span>
<span class="line"><span style="color:#A6ACCD;">192.160.1.200:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> mset name{1000} u ok{1000} o</span></span>
<span class="line"><span style="color:#A6ACCD;">-</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> Redirected to slot </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">11326</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> located at 192.160.1.201:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">OK</span></span>
<span class="line"><span style="color:#A6ACCD;">192.160.1.201:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> mset name u ok o</span></span>
<span class="line"><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">error</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> CROSSSLOT Keys </span><span style="color:#89DDFF;">in</span><span style="color:#A6ACCD;"> request don</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">t hash to the same slot</span></span>
<span class="line"><span style="color:#C3E88D;">192.160.1.201:6379&gt; mget name{1000} ok{1000}</span></span>
<span class="line"><span style="color:#C3E88D;">1) &quot;u&quot;</span></span>
<span class="line"><span style="color:#C3E88D;">2) &quot;o&quot;</span></span>
<span class="line"><span style="color:#C3E88D;">192.160.1.201:6379&gt; mget name ok</span></span>
<span class="line"><span style="color:#C3E88D;">(error) CROSSSLOT Keys in request don</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">t </span><span style="color:#82AAFF;">hash</span><span style="color:#A6ACCD;"> to the same slot</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_4-4、使用往期方式搭建建群" tabindex="-1">4.4、使用往期方式搭建建群 <a class="header-anchor" href="#_4-4、使用往期方式搭建建群" aria-hidden="true">#</a></h3><h4 id="_4-4-1、节点准备" tabindex="-1">4.4.1、节点准备 <a class="header-anchor" href="#_4-4-1、节点准备" aria-hidden="true">#</a></h4><p>redis 配置文件同上个方案</p><p>然后配置好，docker-compose及目录结构</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">- redis3</span></span>
<span class="line"><span style="color:#A6ACCD;">	- master</span></span>
<span class="line"><span style="color:#A6ACCD;">        - 100</span></span>
<span class="line"><span style="color:#A6ACCD;">        - 101</span></span>
<span class="line"><span style="color:#A6ACCD;">        - 102</span></span>
<span class="line"><span style="color:#A6ACCD;">	- slaves</span></span>
<span class="line"><span style="color:#A6ACCD;">        - 10</span></span>
<span class="line"><span style="color:#A6ACCD;">        - 11</span></span>
<span class="line"><span style="color:#A6ACCD;">        - 12</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>容器创建同上个方案</p><p>redis5 会自动进行集群的搭建，包括节点握手和分配虚拟槽，redis5 版本以下不支持，这里实际就是手动进行这两步操作</p><h4 id="_4-4-2、节点握手" tabindex="-1">4.4.2、节点握手 <a class="header-anchor" href="#_4-4-2、节点握手" aria-hidden="true">#</a></h4><p>节点握手是指一批运行在集群模式下的节点通过 Gossip 协议彼此通信，达到感知对方的过程。节点握手是集群彼此通信的第一步，由客户端发起命令：</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">cluster meet{ip}{port}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>关于Gossip可以看看文章的介绍 <a href="http://www.10tiao.com/html/681/201803/2651029463/1.html" target="_blank" rel="noreferrer">http://www.10tiao.com/html/681/201803/2651029463/1.html</a></p><p>通过命令 cluster meet 127.0.0.1 6380 让节点 6379 和 6380 节点进行握手通信。cluster meet 命令是一个异步命令，执行之后立刻返回。内部发起与目标节点进行握手通信</p><p><img src="/guo-notes/redis/redis-36.png" alt="image-20210827120243200"></p><ol><li>节点6379本地创建6380节点信息对象，并发送 meet 消息。</li><li>节点6380接受到 meet 消息后，保存6379节点信息并回复 pong 消息。</li><li>之后节点6379和6380彼此定期通过 ping/pong 消息进行正常的节点通信。</li></ol><p><strong>注意：</strong></p><p>1、每个Redis Cluster节点会占用两个TCP端口，一个监听客户端的请求，默认是6379，另外一个在前一个端口加上10000， 比如16379，来监听数据的请求，节点 和节点之间会监听第二个端口，用一套二进制协议来通信。 节点之间会通过套协议来进行失败检测，配置更新，failover认证等等。 为了保证节点之间正常的访问，需要注意防火墙的配置。</p><p>2、节点建立握手之后集群还不能正常工作，这时集群处于下线状态，所有的数据读写都被禁止</p><p>3、设置从节点作为一个完整的集群，需要主从节点，保证当它出现故障时可以自动进行故障转移。集群模式下，Reids 节点角色分为主节点和从节点。</p><p>首次启动的节点和被分配槽的节点都是主节点，从节点负责复制主节点槽信息和相关的数据。</p><p>使用 <code>cluster replicate {nodeId}</code> 命令让一个节点成为从节点。其中命令执行必须在对应的从节点上执行，<strong>将当前节点设置为 node_id 指定的节点的从节点</strong></p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">redis-cli -h 47.98.147.49 -p 6395 CLUSTER REPLICATE 0affa79edef47e10a0459832d279fe74467be98b</span></span>
<span class="line"><span style="color:#A6ACCD;">redis-cli -h 47.98.147.49 -p 6396 CLUSTER REPLICATE 1e30c186681638411f25f949f1b6ffded5f5d0a3</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>示例</strong></p><p>先进行握手</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost redis3</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># docker exec -it redis5_mc_101 sh  #进入容器，节点101</span></span>
<span class="line"><span style="color:#A6ACCD;">/ </span><span style="color:#676E95;"># redis-cli	#进入redis 指令模式</span></span>
<span class="line"><span style="color:#A6ACCD;">127.0.0.1:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> cluster meet 192.160.1.100 6379	</span><span style="color:#676E95;">#与节点100握手</span></span>
<span class="line"><span style="color:#A6ACCD;">OK</span></span>
<span class="line"><span style="color:#A6ACCD;">127.0.0.1:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> cluster meet 192.160.1.10 6379	</span><span style="color:#676E95;">#与节点10握手</span></span>
<span class="line"><span style="color:#A6ACCD;">OK</span></span>
<span class="line"><span style="color:#A6ACCD;">127.0.0.1:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> cluster meet 192.160.1.101 6379	</span><span style="color:#676E95;">#与节点101握手</span></span>
<span class="line"><span style="color:#A6ACCD;">OK</span></span>
<span class="line"><span style="color:#A6ACCD;">127.0.0.1:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> cluster meet 192.160.1.11 6379	</span><span style="color:#676E95;">#与节点11握手</span></span>
<span class="line"><span style="color:#A6ACCD;">OK</span></span>
<span class="line"><span style="color:#A6ACCD;">127.0.0.1:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> cluster meet 192.160.1.102 6379	</span><span style="color:#676E95;">#与节点102握手</span></span>
<span class="line"><span style="color:#A6ACCD;">OK</span></span>
<span class="line"><span style="color:#A6ACCD;">127.0.0.1:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> cluster meet 192.160.1.12 6379	</span><span style="color:#676E95;">#与节点12握手</span></span>
<span class="line"><span style="color:#A6ACCD;">OK</span></span>
<span class="line"><span style="color:#A6ACCD;">127.0.0.1:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> cluster nodes	</span><span style="color:#676E95;">#查看集群节点</span></span>
<span class="line"><span style="color:#A6ACCD;">1ceaa79d35ba68264130c817ddf0974444ced0c8 192.160.1.102:6379@16379 master - 0 1590041166964 5 connected</span></span>
<span class="line"><span style="color:#A6ACCD;">6099eed758b664bbe40c972c09769fa2c97cd91c 192.160.1.100:6379@16379 master - 0 1590041166558 3 connected</span></span>
<span class="line"><span style="color:#A6ACCD;">e17fea6610f5bb355350e23157dc67246840fb31 192.160.1.12:6379@16379 master - 0 1590041166000 0 connected</span></span>
<span class="line"><span style="color:#A6ACCD;">2b1fa3acdc5626ccbe11590ec35c4be09dced513 192.160.1.10:6379@16379 master - 0 1590041167572 2 connected</span></span>
<span class="line"><span style="color:#A6ACCD;">a8fe61fd8c00143c8397b4f0631297aa7e3f105a 192.160.1.11:6379@16379 master - 0 1590041166570 4 connected</span></span>
<span class="line"><span style="color:#A6ACCD;">4a082b4fc801aab5b4db218a069fbcf03d32d560 192.160.1.101:6379@16379 myself,master - 0 1590041167000 1 connected</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>配置好每个主节点下的从节点</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.10 cluster replicate 6099eed758b664bbe40c972c09769fa2c97cd91c</span></span>
<span class="line"><span style="color:#A6ACCD;">OK	</span><span style="color:#676E95;">#节点10为从节点，主节点为100（节点序号）</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.11 cluster replicate 4a082b4fc801aab5b4db218a069fbcf03d32d560</span></span>
<span class="line"><span style="color:#A6ACCD;">OK	</span><span style="color:#676E95;">#节点11为从节点，主节点为101（节点序号）</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.12 cluster replicate 1ceaa79d35ba68264130c817ddf0974444ced0c8</span></span>
<span class="line"><span style="color:#A6ACCD;">OK	</span><span style="color:#676E95;">#节点12为从节点，主节点为102（节点序号）</span></span>
<span class="line"><span style="color:#A6ACCD;">127.0.0.1:</span><span style="color:#89DDFF;">6379&gt;</span><span style="color:#A6ACCD;"> cluster nodes 	</span><span style="color:#676E95;">#查看集群节点</span></span>
<span class="line"><span style="color:#A6ACCD;">1ceaa79d35ba68264130c817ddf0974444ced0c8 192.160.1.102:6379@16379 master - 0 1590041451933 5 connected</span></span>
<span class="line"><span style="color:#A6ACCD;">6099eed758b664bbe40c972c09769fa2c97cd91c 192.160.1.100:6379@16379 master - 0 1590041451000 3 connected</span></span>
<span class="line"><span style="color:#A6ACCD;">e17fea6610f5bb355350e23157dc67246840fb31 192.160.1.12:6379@16379 slave 1ceaa79d35ba68264130c817ddf0974444ced0c8 0 1590041451525 5 connected</span></span>
<span class="line"><span style="color:#A6ACCD;">2b1fa3acdc5626ccbe11590ec35c4be09dced513 192.160.1.10:6379@16379 slave 6099eed758b664bbe40c972c09769fa2c97cd91c 0 1590041451525 3 connected</span></span>
<span class="line"><span style="color:#A6ACCD;">a8fe61fd8c00143c8397b4f0631297aa7e3f105a 192.160.1.11:6379@16379 slave 4a082b4fc801aab5b4db218a069fbcf03d32d560 0 1590041450603 4 connected</span></span>
<span class="line"><span style="color:#A6ACCD;">4a082b4fc801aab5b4db218a069fbcf03d32d560 192.160.1.101:6379@16379 myself,master - 0 1590041451000 1 connected</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_4-4-3、分配槽" tabindex="-1">4.4.3、分配槽 <a class="header-anchor" href="#_4-4-3、分配槽" aria-hidden="true">#</a></h4><p>Redis 集群把所有的数据映射到16384个槽中。每个 key 会映射为一个固定的槽，只有当节点分配了槽，才能响应和这些槽关联的键命令。通过 cluster addslots 命令为节点分配槽</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.100 cluster addslots {0..5461}</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.101 cluster addslots {5462..10922}</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.101 cluster addslots {10923..16383}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们依照 Redis 协议手动建立一个集群。它由6个节点构成，3个主节点负责处理槽和相关数据，3个从节点负责故障转移。手动搭建集群便于理解集群建立的流程和细节，但是我们从中发现集群搭建需要很多步骤，当集群节点众多时，必然会加大搭建集群的复杂度和运维成本。因此 Redis 官方提供了redis-trib.rb 工具方便我们快速搭建集群。</p><h3 id="_4-5、redis-trib-rb-搭建集群" tabindex="-1">4.5、redis-trib.rb 搭建集群 <a class="header-anchor" href="#_4-5、redis-trib-rb-搭建集群" aria-hidden="true">#</a></h3><p>redis-trib.rb 是采用 Ruby 实现的 Redis 集群管理工具。内部通过 Cluster 相关命令帮我们简化集群创建、检查、槽迁移和均衡等常见运维操作，使用之前需要安装 Ruby 依赖环境。下面介绍搭建集群的详细步骤。</p><p>内部通过 Cluster 相关命令帮我们简化集群创建、检查、槽迁移和均衡等常见运维操作，使用之前需要安装 Ruby 依赖环境，相关扩展这个我在 dockerfile 文件当中已经写了指令，查看下理解意思就可以了。</p><p>启动好6个节点之后，使用 redis-trib.rb create 命令完成节点握手和槽分配过程</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">redis-trib.rb create --replicas 1 47.98.147.49:6391 47.98.147.49:6392 47.98.147.49:6393 47.98.147.49:6394 47.98.147.49:6395 47.98.147.49:6396</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>--replicas</code> 参数指定集群中<strong>每个主节点配备几个从节点，这里设置为1</strong>， redis-trib.rb 会尽可能保证主从节点不分配在同一机器下，因此会重新排序节点列表顺序。节点列表顺序用于确定主从角色，先主节点之后是从节点。创建过程中首先会给出主从节点角色分配的计划，并且会生成报告 命令说明：</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">redis-trib.rb help</span></span>
<span class="line"><span style="color:#A6ACCD;">Usage: redis-trib &lt;command&gt; &lt;options&gt; &lt;arguments ...&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_4-5-1、集群搭建" tabindex="-1">4.5.1、集群搭建 <a class="header-anchor" href="#_4-5-1、集群搭建" aria-hidden="true">#</a></h4><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">create host1:port1 ... hostN:portN</span></span>
<span class="line"><span style="color:#A6ACCD;">	--replicas &lt;arg&gt; #带上该参数表示是否有从，arg表示从的数量</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>检查集群</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">check host:port</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查看集群信息</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">info host:port</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>修复集群</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">fix host:port</span></span>
<span class="line"><span style="color:#A6ACCD;">	--timeout &lt;arg&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在线迁移slot</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#A6ACCD;">reshard host:port </span><span style="color:#676E95;">#必传参数，用来从一个节点获取整个集群信息，相当于获取集群信息的入口</span></span>
<span class="line"><span style="color:#A6ACCD;">		--from </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#需要从哪些源节点上迁移slot，可从多个源节点完成迁移，以逗号隔开，传递的是节点的node id，还可以直接传递--from all， 这样源节点就是集群的所有节点，不传递该参数的话，则会在迁移过程中提示用户输入</span></span>
<span class="line"><span style="color:#A6ACCD;">		--to </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#slot需要迁移的目的节点的node id，目的节点只能填写一个，不传递该参数的话，则会在迁移过程中提示用户输入。</span></span>
<span class="line"><span style="color:#A6ACCD;">		--slots </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#需要迁移的slot数量，不传递该参数的话，则会在迁移过程中提示用户输入。</span></span>
<span class="line"><span style="color:#A6ACCD;">		--yes </span><span style="color:#676E95;">#设置该参数，可以在打印执行reshard计划的时候，提示用户输入yes确认后再执行reshard</span></span>
<span class="line"><span style="color:#A6ACCD;">		--timeout </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#设置migrate命令的超时时间。</span></span>
<span class="line"><span style="color:#A6ACCD;">		--pipeline </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#定义cluster getkeysinslot命令一次取出的key数量，不传的话使用默认值为10。</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>平衡集群节点slot数量</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#A6ACCD;">rebalance host:port</span></span>
<span class="line"><span style="color:#A6ACCD;">		--weight </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">        --auto-weights</span></span>
<span class="line"><span style="color:#A6ACCD;">        --use-empty-masters</span></span>
<span class="line"><span style="color:#A6ACCD;">        --timeout </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">        --simulate</span></span>
<span class="line"><span style="color:#A6ACCD;">        --pipeline </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">        --threshold </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#676E95;">#将新节点加入集群</span></span>
<span class="line"><span style="color:#A6ACCD;">add-node new_host:new_port existing_host:existing_port</span></span>
<span class="line"><span style="color:#A6ACCD;">        --slave</span></span>
<span class="line"><span style="color:#A6ACCD;">        --master-id </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#676E95;">#从集群中删除节点</span></span>
<span class="line"><span style="color:#A6ACCD;">del-node host:port node_id</span></span>
<span class="line"><span style="color:#676E95;">#设置集群节点间心跳连接的超时时间</span></span>
<span class="line"><span style="color:#A6ACCD;">set-timeout host:port milliseconds</span></span>
<span class="line"><span style="color:#676E95;">#在集群全部节点上执行命令</span></span>
<span class="line"><span style="color:#A6ACCD;">call host:port </span><span style="color:#82AAFF;">command</span><span style="color:#A6ACCD;"> arg arg .. arg</span></span>
<span class="line"><span style="color:#676E95;">#将外部redis数据导入集群</span></span>
<span class="line"><span style="color:#A6ACCD;">import host:port</span></span>
<span class="line"><span style="color:#A6ACCD;">        --from </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">arg</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">        --copy</span></span>
<span class="line"><span style="color:#A6ACCD;">        --replace</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h4 id="_4-5-2、集群伸缩" tabindex="-1">4.5.2、集群伸缩 <a class="header-anchor" href="#_4-5-2、集群伸缩" aria-hidden="true">#</a></h4><p>Redis 集群提供了灵活的节点扩容和收缩方案。在不影响集群对外服务的情况下，可以为集群添加节点进行扩容也可以下线部分节点进行缩容。</p><p><img src="/guo-notes/redis/redis-53.png" alt="image-20210829155000294"></p><p>槽和数据与节点的对应关系</p><p>当主节点分别维护自己负责的槽和对应的数据，如果希望加入1个节点实现集群扩容时，需要通过相关命令把一部分槽和数据迁移给新节点</p><p><img src="/guo-notes/redis/redis-54.png" alt="image-20210829155116041"></p><p>上面图里的每个节点把一部分槽和数据迁移到新的节点6385，每个节点负责的槽和数据相比之前变少了从而达到了集群扩容的目的，集群伸缩=槽和数据在节点之间的移动。</p><h5 id="扩容操作" tabindex="-1">扩容操作 <a class="header-anchor" href="#扩容操作" aria-hidden="true">#</a></h5><p>扩容是分布式存储最常见的需求，Redis 集群扩容操作可分为如下步骤：</p><ol><li>准备新节点。</li><li>加入集群。</li><li>迁移槽和数据。</li></ol><h6 id="准备新节点-1" tabindex="-1">准备新节点 <a class="header-anchor" href="#准备新节点-1" aria-hidden="true">#</a></h6><p>需要提前准备好新节点并运行在集群模式下，新节点建议跟集群内的节点配置保持一致，便于管理统一。</p><p>192.50.0.5:6379、192.30.0.5:6378（生成容器具体操作同上）</p><h6 id="加入集群-1" tabindex="-1">加入集群 <a class="header-anchor" href="#加入集群-1" aria-hidden="true">#</a></h6><p>通过 <code>redis-trib.rb add-node 127.0.0.1:6385 127.0.0.1:6379 </code>实现节点添加 要加入的节点 集群中的节点</p><h6 id="迁移槽和数据-1" tabindex="-1">迁移槽和数据 <a class="header-anchor" href="#迁移槽和数据-1" aria-hidden="true">#</a></h6><p>加入集群后需要为新节点迁移槽和相关数据，槽在迁移过程中集群可以正常提供读写服务，迁移过程是集群扩容最核心的环节，下面详细讲解。</p><p><strong>槽是 Redis 集群管理数据的基本单位，首先需要为新节点制定槽的迁移计划</strong>，确定原有节点的哪些槽需要迁移到新节点。迁移计划需要确保每个节点负责相似数量的槽，从而保证各节点的数据均匀，比如之前是三个节点，现在是四个节点，把节点槽分布在四个节点上。</p><p><img src="/guo-notes/redis/redis-55.png" alt="image-20210829155639717"></p><p>槽迁移计划确定后开始逐个把槽内数据从源节点迁移到目标节点</p><p><img src="/guo-notes/redis/redis-56.png" alt="image-20210829155721671"></p><p>数据迁移过程是逐个槽进行的</p><p>流程说明：</p><ol><li>对目标节点发送导入命令，让目标节点准备导入槽的数据。</li><li>对源节点发送导出命令，让源节点准备迁出槽的数据。</li><li>源节点循环执行迁移命令，将槽跟数据迁移到目标节点。</li></ol><p><img src="/guo-notes/redis/redis-57.png" alt="image-20210829155814070"></p><p>redis-trib 提供了槽重分片功能，命令如下：</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">redis-trib.rb reshard host:port --from &lt;arg&gt; --to &lt;arg&gt; --slots &lt;arg&gt; --yes --timeout &lt;arg&gt; --pipeline &lt;arg&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>参数说明：</p><ul><li>host： port：必传参数，集群内任意节点地址，用来获取整个集群信息。</li><li>from： 制定源节点的 id，如果有多个源节点，使用逗号分隔，如果是all源节点变为集群内所有主节点，在迁移过程中提示用户输入。</li><li>to： 需要迁移的目标节点的id，目标节点只能填写一个，在迁移过程中提示用户输入。</li><li>slots： 需要迁移槽的总数量，在迁移过程中提示用户输入。</li><li>yes： 当打印出 reshard 执行计划时，是否需要用户输入yes确认后再执行 reshard。</li><li>timeout： 控制每次 migrate 操作的超时时间，默认为60000毫秒。</li><li>pipeline： 控制每次批量迁移键的数量，默认为10。</li></ul><p><strong>示例：</strong></p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">redis-trib.rb reshard 127.0.0.1:6379</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>打印出集群每个节点信息后，reshard 命令需要确认迁移的槽数量，这里我们根据节点个数输入对应的值：</p><p><img src="/guo-notes/redis/redis-58.png" alt="image-20210829160131521"></p><p>输入6385的节点 ID 作为目标节点，目标节点只能指定一个：</p><p><img src="/guo-notes/redis/redis-59.png" alt="image-20210829160218390"></p><p>之后输入源节点的 ID，这里分别输入相应的节点 ID 最后 用 done 表示结束。</p><p>数据迁移之前会打印出所有的槽从源节点到目标节点的计划，确认计划无误后输入 yes 执行迁移工作 redis-trib 工具会打印出每个槽迁移的进度:</p><p><img src="/guo-notes/redis/redis-60.png" alt="image-20210829160300410"></p><p>查看节点的信息cluster-node</p><p><img src="/guo-notes/redis/redis-61.png" alt="image-20210829160346091"></p><p>输入 redis-trib.rb rebalance ip:port .</p><p><img src="/guo-notes/redis/redis-62.png" alt="image-20210829160521979"></p><h6 id="主从节点设置" tabindex="-1">主从节点设置 <a class="header-anchor" href="#主从节点设置" aria-hidden="true">#</a></h6><p>扩容之初我们把6385、6386节点加入到集群，节点6385迁移了部分槽和数据作为主节点，但相比其他主节点目前还没有从节点，因此该节点不具备故障转移的能力。</p><p>这时需要把节点6386作为6385的从节点，从而保证整个集群的高可用。使用<code>cluster replicate{masterNodeId} </code>命令为主节点添加对应从节点</p><h5 id="收缩集群" tabindex="-1">收缩集群 <a class="header-anchor" href="#收缩集群" aria-hidden="true">#</a></h5><p>收缩集群意味着缩减规模，需要从现有集群中安全下线部分节点，下线节点过程如下</p><p><img src="/guo-notes/redis/redis-63.png" alt="image-20210829160637552"></p><ol><li>首先需要确定下线节点是否有负责的槽，如果是，需要把槽迁移到其他节点，保证节点下线后整个集群槽节点映射的完整性。</li><li>当下线节点不再负责槽或者本身是从节点时，就可以通知集群内其他节点忘记下线节点，当所有的节点忘记该节点后可以正常关闭。</li></ol><h6 id="下线迁移槽-1" tabindex="-1">下线迁移槽 <a class="header-anchor" href="#下线迁移槽-1" aria-hidden="true">#</a></h6><p>下线节点需要把自己负责的槽迁移到其他节点，原理与之前节点扩容的迁移槽过程一致，但是过程收缩正好和扩容迁移方向相反，下线节点变为源节点，其他主节点变为目标节点，源节点需要把自身负责的4096个槽均匀地迁移到其他主节点上。</p><p>使用 redis-trib.rb reshard 命令完成槽迁移。由于每次执行 reshard 命令只能有一个目标节点，因此需要执行3次 reshard 命令。 准备导出</p><p><img src="/guo-notes/redis/redis-64.png" alt="image-20210829160831312"></p><p>指定目标节点</p><p>直到6397迁移干净，不放在任何节点 <img src="/guo-notes/redis/redis-65.png" alt="image-20210829160948666"></p><h6 id="忘记节点" tabindex="-1">忘记节点 <a class="header-anchor" href="#忘记节点" aria-hidden="true">#</a></h6><p>由于集群内的节点不停地通过 Gossip 消息彼此交换节点状态，因此需要通过一种健壮的机制让集群内所有节点忘记下线的节点。也就是说让其他节点不再与要下线节点进行 Gossip 消息交换。Redis 提供了 <code>cluster forget{downNodeId}</code> 命令实现该功能，会把这个节点信息放入黑名单，但是60s之后会恢复。</p><p>生产环境当中使用 redis-trib.rb del-node {host：port}{downNodeId} 命令进行相关操作</p><p>注意： redis-trib rebalance 命令选择</p><p>适用于节点的槽不平衡的状态，有槽的节点</p><ol><li>默认节点加入，要先做节点槽的迁移</li><li>节点已经迁移了所有的槽信息，并且已经从集群删除后，才可以使用平衡</li></ol><h2 id="_5、操作集群-c-集群模式" tabindex="-1">5、操作集群 -c 集群模式 <a class="header-anchor" href="#_5、操作集群-c-集群模式" aria-hidden="true">#</a></h2><p>如果没有指定集群模式，那么会出现如下错误</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">/ # redis-cli</span></span>
<span class="line"><span style="color:#A6ACCD;">127.0.0.1:6379&gt; set ma k</span></span>
<span class="line"><span style="color:#A6ACCD;">(error) MOVED 497 192.160.1.100:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">/ # redis-cli -c</span></span>
<span class="line"><span style="color:#A6ACCD;">127.0.0.1:6379&gt; set ma l</span></span>
<span class="line"><span style="color:#A6ACCD;">-&gt; Redirected to slot [497] located at 192.160.1.100:6379</span></span>
<span class="line"><span style="color:#A6ACCD;">OK</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>所有命令</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">CLUSTER info： 打印集群的信息。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER nodes： 列出集群当前已知的所有节点（node）的相关信息。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER meet &lt;ip&gt; &lt;port&gt;： 将ip和port所指定的节点添加到集群当中。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER addslots &lt;slot&gt; [slot ...]： 将一个或多个槽（slot）指派（assign）给当前节点。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER delslots &lt;slot&gt; [slot ...]： 移除一个或多个槽对当前节点的指派。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER slots： 列出槽位、节点信息。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER slaves &lt;node_id&gt;： 列出指定节点下面的从节点信息。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER replicate &lt;node_id&gt;： 将当前节点设置为指定节点的从节点。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER saveconfig： 手动执行命令保存保存集群的配置文件，集群默认在配置修改的时候会自动保存配置文件。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER keyslot &lt;key&gt;： 列出key被放置在哪个槽上。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER flushslots： 移除指派给当前节点的所有槽，让当前节点变成一个没有指派任何槽的节点。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER countkeysinslot &lt;slot&gt;： 返回槽目前包含的键值对数量。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER getkeysinslot &lt;slot&gt; &lt;count&gt;： 返回count个槽中的键。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER setslot &lt;slot&gt; node &lt;node_id&gt; 将槽指派给指定的节点，如果槽已经指派给另一个节点，那么先让另一个节点删除该槽，然后再进行指</span></span>
<span class="line"><span style="color:#A6ACCD;">派。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER setslot &lt;slot&gt; migrating &lt;node_id&gt; 将本节点的槽迁移到指定的节点中。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER setslot &lt;slot&gt; importing &lt;node_id&gt; 从 node_id 指定的节点中导入槽 slot 到本节点。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER setslot &lt;slot&gt; stable 取消对槽 slot 的导入（import）或者迁移（migrate）。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER failover： 手动进行故障转移。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER forget &lt;node_id&gt;： 从集群中移除指定的节点，这样就无法完成握手，过期时为60s，60s后两节点又会继续完成握手。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER reset [HARD|SOFT]： 重置集群信息，soft是清空其他节点的信息，但不修改自己的id，hard还会修改自己的id，不传该参数则使用soft方式。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER count-failure-reports &lt;node_id&gt;： 列出某个节点的故障报告的长度。</span></span>
<span class="line"><span style="color:#A6ACCD;">CLUSTER SET-CONFIG-EPOCH： 设置节点epoch，只有在节点加入集群前才能设置。</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="_6、redis-cluster原理" tabindex="-1">6、Redis-cluster原理 <a class="header-anchor" href="#_6、redis-cluster原理" aria-hidden="true">#</a></h2><h3 id="_6-1、节点通信–-gossip（流言）协议" tabindex="-1">6.1、节点通信– Gossip（流言）协议 <a class="header-anchor" href="#_6-1、节点通信–-gossip（流言）协议" aria-hidden="true">#</a></h3><p>在分布式存储中需要提供维护节点元数据信息的机制，所谓元数据是指：节点负责哪些数据，是否出现故障等状态信息，Redis 集群采用 Gossip（流言）协议，<strong>Gossip 协议工作原理就是节点彼此不断通信交换信息，一段时间后所有的节点都会知道集群完整的信息，这种方式类似流言传播</strong></p><ol><li>集群中的每个节点都会单独开辟一个 TCP 通道，用于节点之间彼此通信，通信端口号在基础端口上加10000。</li><li>每个节点在固定周期内通过特定规则选择几个节点发送 ping 消息。</li><li>接收到 ping 消息的节点用 pong 消息作为响应。</li></ol><p>集群中每个节点通过一定规则挑选要通信的节点，每个节点可能知道全部节点，也可能仅知道部分节点，只要这些节点彼此可以正常通信，最终它们会达到一致的状态。</p><p><strong>当节点出故障、新节点加入、主从角色变化、槽信息变更等事件发生时，通过不断的 ping/pong 消息通信，经过一段时间后所有的节点都会知道整个集群全部节点的最新状态，从而达到集群状态同步的目的。</strong></p><h2 id="_7、集群常见问题" tabindex="-1">7、集群常见问题 <a class="header-anchor" href="#_7、集群常见问题" aria-hidden="true">#</a></h2><h3 id="_7-1、集群功能限制" tabindex="-1">7.1、集群功能限制 <a class="header-anchor" href="#_7-1、集群功能限制" aria-hidden="true">#</a></h3><p>Redis 集群相对单机在功能上存在一些限制，需要开发人员提前了解，在使用时做好规避。限制如下：</p><ol><li>key 批量操作支持有限。如 mset、mget，目前只支持具有相同 slot 值的 key 执行批量操作。对于映射为不同 slot 值的 key 由于执行 mget、mset、delete 等操作可能存在于多个节点上因此不被支持。</li><li>key 事务操作支持有限。同理只支持多 key 在同一节点上的事务操作，当多个 key 分布在不同的节点上时无法使用事务功能。</li><li>不支持多数据库空间。单机下的 Redis 可以支持16个数据库，集群模式下只能使用一个数据库空间，即 db0。</li><li>复制结构只支持一层，从节点只能复制主节点，不支持嵌套树状复制结构</li></ol><p><strong>集群实现批量操作的原理</strong></p><p><img src="/guo-notes/redis/redis-66.png" alt="image-20210829161500031"></p><p>流程：</p><ol><li>计算 slot 并根据 slots 缓存获取目标节点连接，发送命令。</li><li>如果出现连接错误，使用随机连接重新执行键命令，每次命令重试对<code> $retryLimit</code> 参数减1。</li><li>如果捕获到 MOVED 重定向错误，使用 cluster slots 命令更新 slots 缓存，调用缓存更新方法</li><li>重复执行1）~3）步，直到命令执行成功，或者当 $​​retries&lt;=0时抛出异常。</li></ol><h3 id="_7-2、移除节点之后" tabindex="-1">7.2、移除节点之后 <a class="header-anchor" href="#_7-2、移除节点之后" aria-hidden="true">#</a></h3><p>因为被移除节点，还保留节点信息，所以必须先删除之前的配置信息，否则有可能出现如下报错</p><p><img src="/guo-notes/redis/redis-67.png" alt="image-20210829161647351"></p><h3 id="_7-3、重定向问题" tabindex="-1">7.3、重定向问题 <a class="header-anchor" href="#_7-3、重定向问题" aria-hidden="true">#</a></h3><p>在集群模式下，Redis 接收任何键相关命令时首先计算键对应的槽，再根据槽找出所对应的节点，如果节点是自身，则处理键命令；否则回复 MOVED 重定向错误，通知客户端请求正确的节点。</p><h3 id="_7-4、ask-重定向问题" tabindex="-1">7.4、ASK 重定向问题 <a class="header-anchor" href="#_7-4、ask-重定向问题" aria-hidden="true">#</a></h3><p>Redis 集群支持在线迁移槽（slot）和数据来完成水平伸缩，当 slot 对应的数据从源节点到目标节点迁移过程中，客户端需要做到智能识别，保证键命令可正常执行。例如当一个 slot 数据从源节点迁移到目标节点时，期间可能出现一部分数据在源节点，而另一部分在目标节点。</p><p>如果键对象不存在，则可能存在于目标节点，这时源节点会回复 ASK 重定向异常。格式如下： <code>（error）ASK{slot}{targetIP}：{targetPort}</code> 。</p><p>客户端从 ASK 重定向异常提取出目标节点信息，发送 asking 命令到目标节点打开客户端连接标识，再执行键命令。如果存在则执行，不存在则返回不存在信息。</p><p><img src="/guo-notes/redis/redis-69.png" alt="image-20210829162002740"></p><p>ASK 与 MOVED 虽然都是对客户端的重定向控制，但是有着本质区别。ASK 重定向说明集群正在进行 slot 数据迁移，客户端无法知道什么时候迁移完成，因此只能是临时性的重定向，客户端不会更新本地的 slots 缓存。但是 MOVED 重定向说明键对应的槽已经明确指定到新的节点，因此需要更新 slots 缓存。</p><h2 id="_8、故障转移与恢复" tabindex="-1">8、故障转移与恢复 <a class="header-anchor" href="#_8、故障转移与恢复" aria-hidden="true">#</a></h2><h3 id="_8-1、代码启动流程" tabindex="-1">8.1、代码启动流程 <a class="header-anchor" href="#_8-1、代码启动流程" aria-hidden="true">#</a></h3><p>server.c</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">void initServer(void) {</span></span>
<span class="line"><span style="color:#A6ACCD;">    /* 代码省略 */</span></span>
<span class="line"><span style="color:#A6ACCD;">    if (server.cluster_enabled) clusterInit();</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在这个函数中会加载配置并且初始化一些状态指标，监听集群通信端口。除此之外，该函数执行了如下一些回调函数的注册。</p><ol><li>集群通信端口建立监听后，注册回调函数 clusterAccpeteHandler。当节点之间建立连接时先由该函数进行处理</li><li>当节点之间建立连接后，为新建立的连接注册读事件的回调函数 clusterReadHandler</li><li>当有读事件发生时，当 clusterReadHandler 读取到一个完整的包体后，调用 clusterProcessPacket 解析具体的包体。集群之间通信数据包的解析都在该函数内完成</li></ol><p>并且有类似哨兵一样的 redis 事件让函数 serverCron 调用</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">int serverCron(){</span></span>
<span class="line"><span style="color:#A6ACCD;">    /* 代码省略 */</span></span>
<span class="line"><span style="color:#A6ACCD;">    /* Run the Redis Cluster cron. */</span></span>
<span class="line"><span style="color:#A6ACCD;">    run_with_period(100) {</span></span>
<span class="line"><span style="color:#A6ACCD;">    	if (server.cluster_enabled) clusterCron();</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">    /* Run the Sentinel timer if we are in sentinel mode. */</span></span>
<span class="line"><span style="color:#A6ACCD;">    if (server.sentinel_mode) sentinelTimer();</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>clusterCron 函数执行如下操作：</p><ol><li>向其他节点发送 meet 消息，将其加入集群</li><li>每 1s 会随机选择一个节点发送 ping 消息</li><li>如果一个节点在超时间之内仍然没收到 ping 包响应，则标记为 pfail</li></ol><p>还有在每次进入循环之前，会在 beforeSleep 函数中执行一些操作，如下：</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">void beforeSleep(struct aeEventLoop *eventLoop) {</span></span>
<span class="line"><span style="color:#A6ACCD;">	if (server.cluster_enabled) clusterBeforeSleep();</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>clusterBeforeSleep() 函数会执行如下操作</p><ol><li>检查主从切换状态，如果需要，执行主从切换相关操作。</li><li>更新集群状态，通过检查是否所有 slot 都有响应的节点提供服务以及是否大部分主服务都是可用状态，来决定集群处于正常状态还是失败状态</li><li>刷新集群状态到配置文件中</li></ol><h3 id="_8-2、故障演示" tabindex="-1">8.2、故障演示 <a class="header-anchor" href="#_8-2、故障演示" aria-hidden="true">#</a></h3><p>比如我们可以尝试终止其中一台服务器的运行</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost redis5</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.200 cluster nodes</span></span>
<span class="line"><span style="color:#A6ACCD;">8480eccf92eb45d66d9344982460678444618ea9 192.160.1.202:6379@16379 master - 0 1590070182852 3 connected 10923-16383</span></span>
<span class="line"><span style="color:#A6ACCD;">a163aee6c9a5695f8d98828a850ca851afd73ea6 192.160.1.200:6379@16379 myself,master - 0 1590070183000 1 connected 0-5460</span></span>
<span class="line"><span style="color:#A6ACCD;">3e992bd376701b9f58dcb77082606d4796e4ba0a 192.160.1.201:6379@16379 master - 0 1590070182000 2 connected 5461-10922</span></span>
<span class="line"><span style="color:#A6ACCD;">a68508720542496d71cc675ebedf2ebaed956726 192.160.1.203:6379@16379 slave 8480eccf92eb45d66d9344982460678444618ea9 0 1590070183359 4</span></span>
<span class="line"><span style="color:#A6ACCD;">connected</span></span>
<span class="line"><span style="color:#A6ACCD;">8057c014c56c1f0bbf7db66bb5bca81744dce85a 192.160.1.205:6379@16379 slave 3e992bd376701b9f58dcb77082606d4796e4ba0a 0 1590070184379 6</span></span>
<span class="line"><span style="color:#A6ACCD;">connected</span></span>
<span class="line"><span style="color:#A6ACCD;">bc8175b99a6030e3029a8fddf3acb0ac550ed07d 192.160.1.204:6379@16379 slave a163aee6c9a5695f8d98828a850ca851afd73ea6 0 1590070183869 5</span></span>
<span class="line"><span style="color:#A6ACCD;">connected</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost redis5</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># docker stop redis5_cluster_202</span></span>
<span class="line"><span style="color:#A6ACCD;">redis5_cluster_202</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost redis5</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.200 cluster nodes</span></span>
<span class="line"><span style="color:#A6ACCD;">8480eccf92eb45d66d9344982460678444618ea9 192.160.1.202:6379@16379 master,fail - 1590070266585 1590070265062 3 connected </span></span>
<span class="line"><span style="color:#A6ACCD;">a163aee6c9a5695f8d98828a850ca851afd73ea6 192.160.1.200:6379@16379 myself,master - 0 1590070272000 1 connected 0-5460</span></span>
<span class="line"><span style="color:#A6ACCD;">3e992bd376701b9f58dcb77082606d4796e4ba0a 192.160.1.201:6379@16379 master - 0 1590070274245 2 connected 5461-10922</span></span>
<span class="line"><span style="color:#A6ACCD;">a68508720542496d71cc675ebedf2ebaed956726 192.160.1.203:6379@16379 master - 0 1590070272210 7 connected 10923-16383</span></span>
<span class="line"><span style="color:#A6ACCD;">8057c014c56c1f0bbf7db66bb5bca81744dce85a 192.160.1.205:6379@16379 slave 3e992bd376701b9f58dcb77082606d4796e4ba0a 0 1590070273226 6</span></span>
<span class="line"><span style="color:#A6ACCD;">connected</span></span>
<span class="line"><span style="color:#A6ACCD;">bc8175b99a6030e3029a8fddf3acb0ac550ed07d 192.160.1.204:6379@16379 slave a163aee6c9a5695f8d98828a850ca851afd73ea6 0 1590070273000 5</span></span>
<span class="line"><span style="color:#A6ACCD;">connected</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>通过观察（14行）可以清楚的看到，出问题的节点发送了一个fail信号，从节点变为主节点（17行）</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost redis5</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># docker start redis5_cluster_202</span></span>
<span class="line"><span style="color:#A6ACCD;">redis5_cluster_202</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost redis5</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># redis-cli -h 192.160.1.200 cluster nodes</span></span>
<span class="line"><span style="color:#A6ACCD;">8480eccf92eb45d66d9344982460678444618ea9 192.160.1.202:6379@16379 slave a68508720542496d71cc675ebedf2ebaed956726 0 1590072460611 7</span></span>
<span class="line"><span style="color:#A6ACCD;">connected</span></span>
<span class="line"><span style="color:#A6ACCD;">a163aee6c9a5695f8d98828a850ca851afd73ea6 192.160.1.200:6379@16379 myself,master - 0 1590072461000 1 connected 0-5460</span></span>
<span class="line"><span style="color:#A6ACCD;">3e992bd376701b9f58dcb77082606d4796e4ba0a 192.160.1.201:6379@16379 master - 0 1590072461630 2 connected 5461-10922</span></span>
<span class="line"><span style="color:#A6ACCD;">a68508720542496d71cc675ebedf2ebaed956726 192.160.1.203:6379@16379 master - 0 1590072460000 7 connected 10923-16383</span></span>
<span class="line"><span style="color:#A6ACCD;">8057c014c56c1f0bbf7db66bb5bca81744dce85a 192.160.1.205:6379@16379 slave 3e992bd376701b9f58dcb77082606d4796e4ba0a 0 1590072461527 6</span></span>
<span class="line"><span style="color:#A6ACCD;">connected</span></span>
<span class="line"><span style="color:#A6ACCD;">bc8175b99a6030e3029a8fddf3acb0ac550ed07d 192.160.1.204:6379@16379 slave a163aee6c9a5695f8d98828a850ca851afd73ea6 0 1590072460000 5</span></span>
<span class="line"><span style="color:#A6ACCD;">connected</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>当我再次上线之前的节点之后，可以看到节点转为了从节点；</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">1:M 21 May 2020 14:11:13.736 * Marking node 8480eccf92eb45d66d9344982460678444618ea9 as failing (quorum reached).</span></span>
<span class="line"><span style="color:#A6ACCD;">1:M 21 May 2020 14:11:13.736 # Cluster state changed: fail</span></span>
<span class="line"><span style="color:#A6ACCD;">1:M 21 May 2020 14:11:13.792 # Failover auth granted to a68508720542496d71cc675ebedf2ebaed956726 for epoch 7</span></span>
<span class="line"><span style="color:#A6ACCD;">1:M 21 May 2020 14:11:13.805 # Cluster state changed: ok</span></span>
<span class="line"><span style="color:#A6ACCD;">1:M 21 May 2020 14:47:38.514 * Clear FAIL state for node 8480eccf92eb45d66d9344982460678444618ea9: master without slots is reachable</span></span>
<span class="line"><span style="color:#A6ACCD;">again.</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这个过程，通过观察日志我们可以很清楚的了解到，在节点发生问题的时候，所有的节点就会收到fail的信号，同时切换对应的从节点作为主节点</p><h3 id="_8-3、故障解释" tabindex="-1">8.3、故障解释 <a class="header-anchor" href="#_8-3、故障解释" aria-hidden="true">#</a></h3><p><strong>Redis 集群自身实现了高可用</strong>。高可用首先需要解决集群部分失败的场景：当集群内节点出现故障时通过自动故障转移保证集群可以正常对外提供服务。本节介绍故障转移的细节，分析故障发现和替换故障节点的过程。</p><h4 id="_8-3-1、故障发现" tabindex="-1">8.3.1、故障发现 <a class="header-anchor" href="#_8-3-1、故障发现" aria-hidden="true">#</a></h4><p>当集群内某个节点出现问题时，需要通过一种健壮的方式保证识别出节点是否发生了故障。Redis 集群内节点通过 ping/pong 消息实现节点通信，消息不但可以传播节点槽信息，还可以传播其他状态如：主从状态、节点故障等。因此故障发现也是通过消息传播机制实现的，主要环节包括：主观下线（pfail）和客观下线（fail）。</p><ul><li>主观下线：指某个节点认为另一个节点不可用，即下线状态，这个状态并不是最终的故障判定，只能代表一个节点的意见，可能存在误判情况。</li><li>客观下线：指标记一个节点真正的下线，集群内多个节点都认为该节点不可用，从而达成共识的结果。如果是持有槽的主节点故障，需要为该节点进行故障转移。</li></ul><h5 id="_8-3-1-1、主观下线" tabindex="-1">8.3.1.1、<strong>主观下线</strong> <a class="header-anchor" href="#_8-3-1-1、主观下线" aria-hidden="true">#</a></h5><p>集群中每个节点都会定期向其他节点发送 ping 消息，接收节点回复 pong 消息作为响应。如果在 cluster-node- timeout 时间内通信一直失败， 则发送节点会认为接收节点存在故障，把接收节点标记为主观下线（pfail）状态。流程如图下</p><p><img src="/guo-notes/redis/redis-70.png" alt="image-20210829171402455"></p><ol><li>节点 A 发送 ping 消息给节点 B，如果通信正常将接收到 pong 消息，节点 A 更新最近一次与节点 B 的通信时间。</li><li>如果节点 A 与节点 B 通信出现问题则断开连接，下次会进行重连。如果一直通信失败，则节点 A 记录的与节点 B 最后通信时间将无法更新。</li><li>节点 A 内的定时任务检测到与节点 B 最后通信时间超过 cluster-node-timeout 时，更新本地对节点 B 的状态为主观下线（pfail）。</li></ol><p>主观下线简单来讲就是，当 cluster-note-timeout 时间内某节点无法与另一个节点顺利完成 ping 消息通信时，则将该节点标记为主观下线状态。每个节点内的 clusterState 结构都需要保存其他节点信息，用于从自身视角判断其他节点的状态。<strong>结构关键属性对应的源码在 cluster.h 中的 <code>clusterState</code></strong>。</p><p><strong><code>clusterNode</code>以及标识状态</strong></p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">#define CLUSTER_NODE_MASTER 1 /* The node is a master */</span></span>
<span class="line"><span style="color:#A6ACCD;">#define CLUSTER_NODE_SLAVE 2 /* The node is a slave */</span></span>
<span class="line"><span style="color:#A6ACCD;">#define CLUSTER_NODE_PFAIL 4 /* Failure? Need acknowledge */</span></span>
<span class="line"><span style="color:#A6ACCD;">#define CLUSTER_NODE_FAIL 8 /* The node is believed to be malfunctioning */</span></span>
<span class="line"><span style="color:#A6ACCD;">#define CLUSTER_NODE_MYSELF 16 /* This node is myself */</span></span>
<span class="line"><span style="color:#A6ACCD;">#define CLUSTER_NODE_HANDSHAKE 32 /* We have still to exchange the first ping */</span></span>
<span class="line"><span style="color:#A6ACCD;">#define CLUSTER_NODE_NOADDR 64 /* We don&#39;t know the address of this node */</span></span>
<span class="line"><span style="color:#A6ACCD;">#define CLUSTER_NODE_MEET 128 /* Send a MEET message to this node */</span></span>
<span class="line"><span style="color:#A6ACCD;">#define CLUSTER_NODE_MIGRATE_TO 256 /* Master elegible for replica migration. */</span></span>
<span class="line"><span style="color:#A6ACCD;">#define CLUSTER_NODE_NOFAILOVER 512 /* Slave will not try to failver. */</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>通过伪代码诠释：</p><div class="language-php line-numbers-mode"><button class="copy"></button><span class="lang">php</span><pre><code><span class="line"><span style="color:#89DDFF;">&lt;?</span><span style="color:#A6ACCD;">php</span></span>
<span class="line"><span style="color:#676E95;">// 节点</span></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">node</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">flags</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">ping_sent</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;">// 集群</span></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">cluster</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">/**</span></span>
<span class="line"><span style="color:#676E95;">    * 节点集合</span></span>
<span class="line"><span style="color:#676E95;">    * </span><span style="color:#F78C6C;">@var</span><span style="color:#676E95;"> </span><span style="color:#FFCB6B;">node</span></span>
<span class="line"><span style="color:#676E95;">    */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">nodes </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[];</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__construct</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// .. 初始化</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">server</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">/**</span></span>
<span class="line"><span style="color:#676E95;">    * </span><span style="color:#F78C6C;">@var</span><span style="color:#676E95;"> </span><span style="color:#FFCB6B;">cluster</span></span>
<span class="line"><span style="color:#676E95;">    */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">cluster</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">cluster_node_timeout</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// 当前为主节点</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> CLUSTER_NODE_MYSTER </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// 主观 下线</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> CLUSTER_NODE_PFALL </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__construct</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">$this-&gt;</span><span style="color:#A6ACCD;">cluster </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">cluster</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">clusterCron</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// .. 忽略其他代码</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">foreach</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">node </span><span style="color:#89DDFF;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">key </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$this-&gt;</span><span style="color:#A6ACCD;">cluster</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">nodes</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">flags </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">self</span><span style="color:#89DDFF;">::</span><span style="color:#A6ACCD;">CLUSTER_NODE_MYSTER</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">continue</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">// 如果是当前自己跳过</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">now </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">time</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// 自身节点最后一次与该ping通信的时间差</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">delay </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">now </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">ping_sent</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// 如果通信时间差超过cluster_node_timeout，将该节点编辑为PFALL(主观下线)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">delay </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$this-&gt;</span><span style="color:#A6ACCD;">cluster_node_timeout</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">flags </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">self</span><span style="color:#89DDFF;">::</span><span style="color:#A6ACCD;">CLUSTER_NODE_PFALL</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">?&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>Redis 集群对于节点最终是否故障判断非常严谨，只有一个节点认为主观下线并不能准确判断是否故障。多个节点协作完成故障发现的过程叫做客观下线。</p><h5 id="_8-3-1-2、客观下线" tabindex="-1">8.3.1.2、客观下线 <a class="header-anchor" href="#_8-3-1-2、客观下线" aria-hidden="true">#</a></h5><p>当某个节点判断另一个节点主观下线后，相应的节点状态会跟随消息在集群内传播。ping/pong 消息的消息体会携带集群 1/10 的其他节点状态数据，当接收节点发现消息体中含有主观下线的节点状态时，会在本地找到故障及 clusterNode 结构，保存到下线报告连接中 <code>clusterNode fail_reportsx</code></p><p>通过Gossip消息传播，集群内节点不断收集到故障节点的下线报告。当半数以上持有槽的主节点都标记某个节点是主观下线时。触发客观下线流程。</p><p>流程：</p><ol><li>当消息体内含有其他节点的 pfail 状态会判断发送节点的状态，如果发送节点是主节点则对报告的 pfail 状态处理，从节点则忽略</li><li>找到 pfail 对应的节点结构，更新 clusterNode 内部下线报告连接表</li><li>根据更新后的下线报告连接表尝试进行客观下线。</li></ol><h5 id="_8-3-1-3、维护下线报表" tabindex="-1">8.3.1.3、维护下线报表 <a class="header-anchor" href="#_8-3-1-3、维护下线报表" aria-hidden="true">#</a></h5><p>信息的内容结构 cluster.h</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">typedef struct clusterNodeFailReport {</span></span>
<span class="line"><span style="color:#A6ACCD;">    struct clusterNode *node; /* Node reporting the failure condition. */</span></span>
<span class="line"><span style="color:#A6ACCD;">    mstime_t time; /* 最晚时间 */</span></span>
<span class="line"><span style="color:#A6ACCD;">} clusterNodeFailReport</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>下线报告中保存了报告故障的节点结构和最近收到下线报告的时间，当接收到fail状态时，会维护对应节点的下线上报连接表</strong></p><h5 id="_8-3-1-4、尝试客观下线" tabindex="-1">8.3.1.4、尝试客观下线 <a class="header-anchor" href="#_8-3-1-4、尝试客观下线" aria-hidden="true">#</a></h5><p>流程说明：</p><ol><li>首先统计有效的下线报告数量，如果小于集群内持有槽的主节点总数的一半则退出。</li><li>当下线报告大于槽主机诶单数量一半时，标记对应故障节点为客观下线状态</li><li>向集群广播一条 fail 消息，通知所有的节点讲故障接地那标记为客观下线，fail 消息的消息体包含故障节点的 id</li></ol><p>伪代码：</p><div class="language-php line-numbers-mode"><button class="copy"></button><span class="lang">php</span><pre><code><span class="line"><span style="color:#89DDFF;">&lt;?</span><span style="color:#A6ACCD;">php</span></span>
<span class="line"><span style="color:#676E95;">// 节点</span></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">clusterNode</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">flags</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">ping_sent</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">fail_reports</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">fail_time</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">server</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">/**</span></span>
<span class="line"><span style="color:#676E95;">    * </span><span style="color:#F78C6C;">@var</span><span style="color:#676E95;"> </span><span style="color:#FFCB6B;">cluster</span></span>
<span class="line"><span style="color:#676E95;">    */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">cluster</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> CLUSTER_NODE_FALL </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">8</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// 客观下线的流程</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">markNodeAsFailingIfNeeded</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">clusterNode</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">failNode</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">failures </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// 主观下线节点数必须超过槽节点的数量的一半</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">needed_quorum </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">($this-&gt;</span><span style="color:#A6ACCD;">cluster</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">size </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// 统计failNode节点有效的下线报告数量（不包括当前节点）</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">failures </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$this-&gt;</span><span style="color:#82AAFF;">clusterNodeFailureReportsCount</span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">failNode</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// 如果当前节点是主节点，将当前节点积累加到failures</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">nodeIsMaster</span><span style="color:#89DDFF;">($this))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">failures</span><span style="color:#89DDFF;">++;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// 下线报告数量不足槽节点的一半退出</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">failures </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">needed_quorum</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// 将该节点标记为客观下线状态(fail)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">failNode</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">flags </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">self</span><span style="color:#89DDFF;">::</span><span style="color:#A6ACCD;">CLUSTER_NODE_FALL</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// 更新客观现下线时间</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">failNode</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">fail_time </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">time</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;">// 如果当前节点为主节点，向集群广播对应的节点的fail消息</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">nodeIsMaster</span><span style="color:#89DDFF;">($this))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">clusterSendFail</span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">failNode</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">$this-&gt;</span><span style="color:#82AAFF;">clusterDoBeforeSleep</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// 判断节点是不是主节点</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">nodeIsMaster</span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">clusterNodeFailureReportsCount</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">clusterDoBeforeSleep</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">?&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>广播 fail 消息是客观下线的最后一步，它承担着非常重要的职责:</p><ul><li>通知集群内所有的节点标记故障节点为客观下线状态并立刻生效。</li><li>通知故障节点的从节点触发故障转移流程。</li></ul><h4 id="_8-3-2、故障恢复" tabindex="-1">8.3.2、故障恢复 <a class="header-anchor" href="#_8-3-2、故障恢复" aria-hidden="true">#</a></h4><p>故障节点变为客观下线后，如果下线节点是持有槽的主节点则需要在它的从节点中选出一个替换它，从而保证集群的高可用。下线主节点的所有从节点承担故障恢复的义务，<strong>当从节点通过内部定时任务发现自身复制的主节点进人客观下线时，将会触发故障恢复流程。</strong></p><ol><li><p>资格检查</p></li><li><p>准备选举时间</p></li><li><p>发起选举</p></li><li><p>选举投票</p></li><li><p>替换主节点</p></li></ol><h5 id="_8-3-2-1、资格检查" tabindex="-1">8.3.2.1、资格检查 <a class="header-anchor" href="#_8-3-2-1、资格检查" aria-hidden="true">#</a></h5><p>每个从节点都要检查最后与主节点断线时间，判断是否有资格替换故障的主节点。如果从节点与主节点断线时间超过 <code>cluster-node-time * cluster-slave-validityfactor</code>，则当前从节点不具备故障转移资格。</p><h5 id="_8-3-2-2、准备选举时间" tabindex="-1">8.3.2.2、准备选举时间 <a class="header-anchor" href="#_8-3-2-2、准备选举时间" aria-hidden="true">#</a></h5><p>当从节点符合故障资格后，更新触发故障选举的时间，只有到达该时间后才能执行后续流程。</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">typedef struct clusterState {</span></span>
<span class="line"><span style="color:#A6ACCD;">    /* 省略 */</span></span>
<span class="line"><span style="color:#A6ACCD;">    /* The following fields are used to take the slave state on elections. */</span></span>
<span class="line"><span style="color:#A6ACCD;">    mstime_t failover_auth_time; /* Time of previous or next election. */</span></span>
<span class="line"><span style="color:#A6ACCD;">    int failover_auth_count; /* Number of votes received so far. */</span></span>
<span class="line"><span style="color:#A6ACCD;">    int failover_auth_sent; /* True if we already asked for votes. */</span></span>
<span class="line"><span style="color:#A6ACCD;">    int failover_auth_rank; /* This slave rank for current auth request. */</span></span>
<span class="line"><span style="color:#A6ACCD;">} clusterState;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>**这里之所以采用延迟触发机制，主要是通过对多个从节点使用不同的延迟选举时间来支持优先级问题。**复制偏移量越大说明从节点延迟越低，那么它应该具有更高的优先级来替换故障主节点。优先级计算伪代码如下:</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">&lt;?php</span></span>
<span class="line"><span style="color:#A6ACCD;">class cluster</span></span>
<span class="line"><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    public $failover_auth_time;</span></span>
<span class="line"><span style="color:#A6ACCD;">    public $failover_auth_rank;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">class server</span></span>
<span class="line"><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    // ..</span></span>
<span class="line"><span style="color:#A6ACCD;">    protected $numslaves;</span></span>
<span class="line"><span style="color:#A6ACCD;">    protected $slaveof;</span></span>
<span class="line"><span style="color:#A6ACCD;">    protected $slaves;</span></span>
<span class="line"><span style="color:#A6ACCD;">    protected $repl_offset;</span></span>
<span class="line"><span style="color:#A6ACCD;">    // 获取从节点优先级</span></span>
<span class="line"><span style="color:#A6ACCD;">    public function clusterGetSlaveRank()</span></span>
<span class="line"><span style="color:#A6ACCD;">    {</span></span>
<span class="line"><span style="color:#A6ACCD;">        $rank = 0;</span></span>
<span class="line"><span style="color:#A6ACCD;">        // 获取从节点的主节点</span></span>
<span class="line"><span style="color:#A6ACCD;">        $this-&gt;nodeIsSlave($this);</span></span>
<span class="line"><span style="color:#A6ACCD;">        $master = $this-&gt;slaveof;</span></span>
<span class="line"><span style="color:#A6ACCD;">        // 获取当前节点的复制偏移量</span></span>
<span class="line"><span style="color:#A6ACCD;">        $myoffset = $this-&gt;replicationGetSlaveOffset();</span></span>
<span class="line"><span style="color:#A6ACCD;">        // 根据其他节点进行复制偏移量计算</span></span>
<span class="line"><span style="color:#A6ACCD;">        for ($i=0; $i &lt; $master-&gt;numslaves; $i++) {</span></span>
<span class="line"><span style="color:#A6ACCD;">            // rank 表示当前从接地那在所有从接地那的复制偏移量排名，为0表示最大</span></span>
<span class="line"><span style="color:#A6ACCD;">            if ($master-&gt;slaves[$i] != $this &amp;&amp; $master-&gt;slaves[$i]-&gt;repl_offset &gt; $myoffset) {</span></span>
<span class="line"><span style="color:#A6ACCD;">            	$rank++;</span></span>
<span class="line"><span style="color:#A6ACCD;">            }</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"><span style="color:#A6ACCD;">        return $rank;</span></span>
<span class="line"><span style="color:#A6ACCD;">	}</span></span>
<span class="line"><span style="color:#A6ACCD;">    // ..</span></span>
<span class="line"><span style="color:#A6ACCD;">    // 判断节点是不是主节点</span></span>
<span class="line"><span style="color:#A6ACCD;">    public function replicationGetSlaveOffset(){}</span></span>
<span class="line"><span style="color:#A6ACCD;">    public function nodeIsSlave($node) {}</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">?&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>使用上面的方法进行优先进排名，更新选举触发时间，伪代码；</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">&lt;?php</span></span>
<span class="line"><span style="color:#A6ACCD;">class server</span></span>
<span class="line"><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    public function clusterHandleSlaveFailover()</span></span>
<span class="line"><span style="color:#A6ACCD;">    {</span></span>
<span class="line"><span style="color:#A6ACCD;">        // 前面过滤很多代码</span></span>
<span class="line"><span style="color:#A6ACCD;">        // 默认触发选举时间：发现客观下线后一秒内执行</span></span>
<span class="line"><span style="color:#A6ACCD;">        $this-&gt;cluster-&gt;failover_auth_time = time() + 500 + mt_rand(500);</span></span>
<span class="line"><span style="color:#A6ACCD;">        // 获取当前从节点排名</span></span>
<span class="line"><span style="color:#A6ACCD;">        $rank = $this-&gt;clusterGetSlaveRank();</span></span>
<span class="line"><span style="color:#A6ACCD;">        // 使用$rank * 1000时间累加</span></span>
<span class="line"><span style="color:#A6ACCD;">        $this-&gt;cluster-&gt;failover_auth_time += $rank * 1000;</span></span>
<span class="line"><span style="color:#A6ACCD;">        // 更新当前从节点排名</span></span>
<span class="line"><span style="color:#A6ACCD;">        $this-&gt;cluster-&gt;failover_auth_rank = $rank;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">?&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>所有的从节点中复制偏移量最大的将提前触发故障选举流程；</p><h5 id="_8-3-2-3、发起选举" tabindex="-1">8.3.2.3、发起选举 <a class="header-anchor" href="#_8-3-2-3、发起选举" aria-hidden="true">#</a></h5><p>配置纪元是一个 只增不减的整数， 每个主节点自身维护一个配置纪元 (clusterNode.configEpoch) 标示当前主节点的版本，所有主节点的配置纪元都不相等，从节点会复制主节点的配置纪元。整个集群又维护一个全局的配置纪元 (clusterState. currentEpoch)，用于记录集群内所有主节点配置纪元的最大版本。执行 cluster info 命令可以查看配置纪元信息：</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@localhost ~]# redis-cli -h 192.160.1.200 cluster info</span></span>
<span class="line"><span style="color:#A6ACCD;">cluster_current_epoch:7 // 整个集群最大配置纪元</span></span>
<span class="line"><span style="color:#A6ACCD;">cluster_my_epoch:1 // 当前主节点配置纪元</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>配置纪元会跟随 ping/pong 消息在集群内传播，当发送方与接收方都是主节点且配置纪元相等时代表出现了冲突，nodeld 更大的一方会递增全局配置纪元并赋值给当前节点来区分冲突。</p><h5 id="_8-3-2-4、选举投票" tabindex="-1">8.3.2.4、选举投票 <a class="header-anchor" href="#_8-3-2-4、选举投票" aria-hidden="true">#</a></h5><p>这个过程就类似于哨兵的操作，会根据拥有槽的主节点进行投票，而从节点必须要等到 N/2 + 1 的票数才可以，此过程从节点不参与投票。</p><h5 id="_8-3-2-5、替换主节点" tabindex="-1">8.3.2.5、替换主节点 <a class="header-anchor" href="#_8-3-2-5、替换主节点" aria-hidden="true">#</a></h5><p>1、取消复制变为主节点</p><p>2、通过 redis 内置方法，撤销对主节点的槽分配，并添加到自己身上</p><p>3、向集群广播自己的 pong 消息，其他节点更新配置</p><h2 id="_9、槽的个数为16384个" tabindex="-1">9、槽的个数为16384个 <a class="header-anchor" href="#_9、槽的个数为16384个" aria-hidden="true">#</a></h2><p>对于客户端请求的 key，根据公式 <code>HASH_SLOT = CRC16(key) mod 16384</code>，计算出映射到哪个分片上，然后Redis 会去相应的节点进行操作！</p><p>那为什么有16384个槽?</p><p>ps：CRC16 算法产生的 hash 值有 16bit，该算法可以产生 <code>2^16 = 65536</code>个值。换句话说，值是分布在 0~65535 之间。那作者在做 mod 运算的时候，为什么不 mod65536，而选择 mod16384？ 这个问题，作者是给出了回答的！地址如下:<a href="https://github.com/antirez/redis/issues/2576" target="_blank" rel="noreferrer">https://github.com/antirez/redis/issues/2576</a></p><p><img src="/guo-notes/redis/redis-39.png" alt="image-20210827152857245"></p><p>回忆一下 Redis Cluster 的工作原理！</p><p>这里要先将节点握手讲清楚。我们让两个redis节点之间进行通信的时候，需要在客户端执行下面一个命令</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">127.0.0.1:7000&gt;cluster meet 127.0.0.1:7001</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如图</p><p><img src="/guo-notes/redis/redis-40.png" alt="image-20210827153014549"></p><p>意思很简单，让7000节点和7001节点知道彼此存在！在握手成功后，两个节点之间会定期发送 ping/pong 消息，交换数据信息，如下图所示。</p><img src="/guo-notes/redis/redis-41.png" alt="image-20210827153100476" style="zoom:50%;"><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">#define CLUSTERMSG_TYPE_COUNT 10 /* 消息的总数量. */</span></span>
<span class="line"><span style="color:#A6ACCD;">typedef struct {</span></span>
<span class="line"><span style="color:#A6ACCD;">    /* ... */</span></span>
<span class="line"><span style="color:#A6ACCD;">    uint16_t type; /* 消息类型，用于区分meet,ping,pong */</span></span>
<span class="line"><span style="color:#A6ACCD;">    unsigned char myslots[CLUSTER_SLOTS/8]; /* 发送节点负责的槽信息 */</span></span>
<span class="line"><span style="color:#A6ACCD;">    unsigned char mflags[3]; /* 至少有3个节点信息 */</span></span>
<span class="line"><span style="color:#A6ACCD;">    /* ... */</span></span>
<span class="line"><span style="color:#A6ACCD;">} clusterMsg;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>需知：char 1个字节，字节也叫Byte，是计算机数据的基本存储单位。<code>8bit(位)=1Byte(字节) 、1024Byte(字节)=1KB、 1024KB=1MB 、1024MB=1GB、1024GB=1TB</code></p><p>在消息头中，最占空间的是 <code>myslots[CLUSTER_SLOTS/8]</code>。这块的大小是：<strong>16384÷8÷1024=2kb</strong> 那在消息体中，会携带一定数量的其他节点信息用于交换。那这个其他节点的信息，到底是几个节点的信息呢？<strong>约为集群总节点数量的1/10，至少携带3个节点的信息。</strong></p><p>这里的重点是：节点数量越多，消息体内容越大。消息体大小是 10 个节点的状态信息约1kb</p><p>redis 集群内节点，每秒都在发 ping 消息。规律如下</p><ul><li>每秒会随机选取5个节点，找出最久没有通信的节点发送ping消息</li><li>每100毫秒(1秒10次)都会扫描本地节点列表，如果发现节点最近一次接受 pong 消息的时间大于cluster-node-timeout/2 则立刻发送 ping 消息</li></ul><img src="/guo-notes/redis/redis-42.png" alt="image-20210827153352865" style="zoom:67%;"><p>因此，每秒单节点发出 ping 消息数量为</p><p>数量 = 1+10*num（node.pong_received &gt; cluster_node_timeout/2）</p><p>当槽位为65536时，这块的大小是: 65536 ÷ 8 ÷ 1024 = 8kb， 因为每秒钟，redis节点需要发送一定数量的ping消息作为心跳包，如果槽位为65536，这个ping消息的消息头太大了，浪费带宽，因此槽位大小为 16384，16384÷8÷1024 刚好等于 2kb。</p><h2 id="_10、gossip（流言）消息" tabindex="-1">10、Gossip（流言）消息 <a class="header-anchor" href="#_10、gossip（流言）消息" aria-hidden="true">#</a></h2><p>Gossip 协议的主要职责就是信息交换。信息交换的载体就是节点彼此发送的 Gossip 消息，了解这些消息有助于理解集群如何完成信息交换。</p><p>Gossip 消息可分为：<strong>ping 消息，pong 消息，meet 消息，fail 消息</strong>等；</p><ul><li>meet 消息：用于通知新节点加人。消息发送者通知接收者加入到当前集群，meet 消息通信正常完成后，接收节点会加入到集群中并进行周期性的 ping、pong 消息交换。</li><li>ping 消息：集群内交换最频繁的消息，集群内每个节点每秒向多个其他节点发送 ping 消息，用于检测节点是否在线和交换彼此状态信息。ping 消息发送封装了自身节点和部分其他节点的状态数据。</li><li>pong 消息：当接收到 ping、 meet 消息时，作为响应消息回复给发送方确认消息正常通信。pong 消息内部封装了自身状态数据。节点也可以向集群内广播自身的 pong 消息来通知整个集群对自身状态进行更新。</li><li>fail 消息：当节点判定集群内另一个节点下线时，会向集群内广播一个 fail 消息，其他节点接收到 fail 消息之后把对应节点更新为下线状态。.</li></ul><img src="/guo-notes/redis/redis-37.png" alt="image-20210827141706889" style="zoom:50%;"><p>所有消息格式划分为：消息头和消息体。消息头包含发送节点自身状态数据，接收节点根据消息头就可以获取到发送节点的相关数据，结构如下：</p><p>cluster.h</p><div class="language-bash line-numbers-mode"><button class="copy"></button><span class="lang">bash</span><pre><code><span class="line"><span style="color:#A6ACCD;">typedef struct </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    char sig</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">4</span><span style="color:#89DDFF;">];</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> 信号的标识. </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    uint32_t totlen</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> 信号的长度 </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    uint16_t ver</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> 版本. </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    uint16_t port</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> tcp端口 </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    uint16_t </span><span style="color:#82AAFF;">type</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> 消息类型，用于区分meet,ping,pong </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    uint16_t count</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> 消息体包含的节点数量meet,ping,pong. </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    uint64_t currentEpoch</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> 当前发送节点的配置纪元. </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    uint64_t configEpoch</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> 从节点的主节点配置纪元. </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    uint64_t offset</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> 复制偏移量. </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    char sender</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">CLUSTER_NAMELEN</span><span style="color:#89DDFF;">];</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> 发送节点的nodeId </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    unsigned char myslots</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">CLUSTER_SLOTS/8</span><span style="color:#89DDFF;">];</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> 发送节点负责的槽信息 </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    char slaveof</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">CLUSTER_NAMELEN</span><span style="color:#89DDFF;">];</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> 如果发送节点是从节点，记录对应主节点的nodeId </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    char myip</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">NET_IP_STR_LEN</span><span style="color:#89DDFF;">];</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> Sender IP, </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> not all zeroed. </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    char notused1</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">34</span><span style="color:#89DDFF;">];</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> 34 bytes reserved </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> future usage. </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    uint16_t cport</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> Sender TCP cluster bus port </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    uint16_t flags</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> 发送节点标识，区分主从是否下线 </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    unsigned char state</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> 发送节点所处的集群状态 </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    unsigned char mflags</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">3</span><span style="color:#89DDFF;">];</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> Message flags: CLUSTERMSG_FLAG</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">012</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">_... </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    union clusterMsgData data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">} clusterMsg</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>集群内所有的消息都采用相同的消息结构 clusterMsg，它包含了发送节点关键信息，如节点id、槽映射、节点标识（角色，是否下线）；而消息体在 Redis 内部采用 clusterMsgData 结构</p><p>cluster.h</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#A6ACCD;">union clusterMsgData </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> PING, MEET and PONG </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    struct </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> Array of N clusterMsgDataGossip structures </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">        clusterMsgDataGossip gossip</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">1</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> ping</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> 此处省略代码 </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">typedef struct </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    char nodename</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">CLUSTER_NAMELEN</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#A6ACCD;">    uint32_t ping_sent</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    uint32_t pong_received</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    char ip</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">NET_IP_STR_LEN</span><span style="color:#89DDFF;">];</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> IP address last </span><span style="color:#F78C6C;">time</span><span style="color:#A6ACCD;"> it was seen </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    uint16_t port</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> base port last </span><span style="color:#F78C6C;">time</span><span style="color:#A6ACCD;"> it was seen </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    uint16_t cport</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> cluster port last </span><span style="color:#F78C6C;">time</span><span style="color:#A6ACCD;"> it was seen </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    uint16_t flags</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> /</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> node-</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">flags copy </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">    uint32_t notused1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> clusterMsgDataGossip</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>消息体 clusterMsgData 定义发送消息的数据，其中 ping、meet、pong 都采用 clusterMsgDataGossi 作为消息体用于信息的交换</p><p>如下为 ping、meet 消息时，接收节点会解析消息内容并根据自身的识别情况作出相应处理的流程图</p><p><img src="/guo-notes/redis/redis-38.png" alt="image-20210827142042870"></p><p>接收节点收到 ping/meet 消息时，执行解析消息头和消息体流程：</p><ul><li>解析消息头过程：消息头包含了发送节点的信息，如果发送节点是新节点且消息是 meet 类型，则加入到本地节点列表；如果是已知节点，则尝试更新发送节点的状态，如槽映射关系，主从角色等状态。</li><li>解析消息体过程：如果消息体的 clusterMsgDataGossip 数组包含的节点是新节点，则尝试发起与新节点的 meet 握手流程；如果是已知节点，则根据 clusterMsgDataGossip 中的 flags 字段判断该节点是否下线，用于故障转移。</li></ul><p>消息处理完后回复 pong 消息，内容同样包含消息头和消息体，发送节点接收到回复的 pong 消息后，采用类似的流程解析处理消息并更新与接收节点最后通信时间，完成一次消息通信。</p></div></div></main><!--[--><!--]--><footer class="VPDocFooter" data-v-37ebe389 data-v-a54a85bd><div class="edit-info" data-v-a54a85bd><!----><div class="last-updated" data-v-a54a85bd><p class="VPLastUpdated" data-v-a54a85bd data-v-f7d51a9c>Last updated: <time datatime="2023-02-20T11:08:17.000Z" data-v-f7d51a9c></time></p></div></div><div class="prev-next" data-v-a54a85bd><div class="pager" data-v-a54a85bd><a class="pager-link prev" href="/guo-notes/classify/redis/redis%E5%93%A8%E5%85%B5.html" data-v-a54a85bd><span class="desc" data-v-a54a85bd>Previous page</span><span class="title" data-v-a54a85bd>十四、redis哨兵</span></a></div><div class="has-prev pager" data-v-a54a85bd><a class="pager-link next" href="/guo-notes/classify/redis/redis%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90.html" data-v-a54a85bd><span class="desc" data-v-a54a85bd>Next page</span><span class="title" data-v-a54a85bd>十六、redis配置文件解析</span></a></div></div></footer><!--[--><!--]--></div></div></div></div></div><!----><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"classify_algorithm_concept_复杂度-时间复杂度和空间复杂度.md\":\"c06f0419\",\"classify_algorithm_concept_数据结构-堆.md\":\"0e387478\",\"classify_algorithm_concept_数据结构-栈与队列.md\":\"299de0e3\",\"classify_algorithm_concept_数据结构-树.md\":\"f9816098\",\"classify_algorithm_concept_算法-排序算法.md\":\"1167f633\",\"classify_algorithm_concept_算法-查找算法.md\":\"f3c33119\",\"classify_algorithm_concept_算法-深度优先搜索和广度优先搜索.md\":\"919c4409\",\"classify_algorithm_index.md\":\"ea4ebce2\",\"classify_algorithm_title_leetcode-1.md\":\"e5e4ffeb\",\"classify_algorithm_title_leetcode-101.md\":\"225f1bfa\",\"classify_algorithm_title_leetcode-104.md\":\"f90b80bf\",\"classify_algorithm_title_leetcode-110.md\":\"5b6bcdb6\",\"classify_algorithm_title_leetcode-141.md\":\"5065dc9f\",\"classify_algorithm_title_leetcode-142.md\":\"94798116\",\"classify_algorithm_title_leetcode-144.md\":\"18f88613\",\"classify_algorithm_title_leetcode-145.md\":\"e52320ab\",\"classify_algorithm_title_leetcode-160.md\":\"cf1e8014\",\"classify_algorithm_title_leetcode-206.md\":\"addc53da\",\"classify_algorithm_title_leetcode-21.md\":\"7fcce04f\",\"classify_algorithm_title_leetcode-226.md\":\"5dc6cc0e\",\"classify_algorithm_title_leetcode-232.md\":\"6c63344a\",\"classify_algorithm_title_leetcode-234.md\":\"e9e9beb1\",\"classify_algorithm_title_leetcode-283.md\":\"57862af2\",\"classify_algorithm_title_leetcode-394.md\":\"7f659ce2\",\"classify_algorithm_title_leetcode-448.md\":\"0c595f9d\",\"classify_algorithm_title_leetcode-70.md\":\"1fe15638\",\"classify_algorithm_title_leetcode-83.md\":\"dd276bd6\",\"classify_algorithm_title_leetcode-876.md\":\"b805bcb5\",\"classify_algorithm_title_leetcode-88.md\":\"3e20211e\",\"classify_algorithm_title_leetcode-912.md\":\"318d44e4\",\"classify_algorithm_title_leetcode-94.md\":\"0af083d3\",\"classify_algorithm_title_leetcode-模板.md\":\"ac0889e7\",\"classify_algorithm_title_剑指offer-22.md\":\"b0cf4f32\",\"classify_algorithm_其他-设计.md\":\"bb91a94a\",\"classify_algorithm_基础-排序.md\":\"1c482fb8\",\"classify_algorithm_基础数据结构-哈希表.md\":\"d6f64369\",\"classify_algorithm_基础数据结构-字符串.md\":\"c4448ab5\",\"classify_algorithm_基础数据结构-数组.md\":\"a34ea6d5\",\"classify_algorithm_基础数据结构-栈.md\":\"4d9fca8b\",\"classify_algorithm_基础数据结构-树.md\":\"993ac5e5\",\"classify_algorithm_基础数据结构-链表.md\":\"22dccfc7\",\"classify_algorithm_基础数据结构-队列.md\":\"799eedbf\",\"classify_algorithm_技巧-双指针.md\":\"6d7149e6\",\"classify_algorithm_数学-斐波那契数列.md\":\"80c39f45\",\"classify_algorithm_数学-相遇问题.md\":\"87ce5666\",\"classify_algorithm_算法-动态规划.md\":\"73585b31\",\"classify_algorithm_算法-广度优先搜索.md\":\"12bf67db\",\"classify_algorithm_算法-排序.md\":\"e482c164\",\"classify_algorithm_算法-深度优先搜索.md\":\"ebede9d2\",\"classify_algorithm_算法-迭代.md\":\"bd82cb1a\",\"classify_algorithm_算法-递归.md\":\"582ef247\",\"classify_redis_redis主从.md\":\"3f665c98\",\"classify_redis_redis事务.md\":\"2395052e\",\"classify_redis_redis五大数据类型实现原理.md\":\"7b2c79bc\",\"classify_redis_redis介绍.md\":\"3caccc9e\",\"classify_redis_redis内存回收.md\":\"f6fdb411\",\"classify_redis_redis内存淘汰策略.md\":\"74b544b8\",\"classify_redis_redis内存碎片率.md\":\"f60bd720\",\"classify_redis_redis分布式锁.md\":\"2d14f047\",\"classify_redis_redis哨兵.md\":\"37a3e95e\",\"classify_redis_redis底层数据结构.md\":\"b1978ef3\",\"classify_redis_redis慢查询和管道.md\":\"06b01203\",\"classify_redis_redis持久化.md\":\"7812034d\",\"classify_redis_redis数据类型简介.md\":\"49be26ac\",\"classify_redis_redis缓存击穿、穿透、雪崩.md\":\"760045e4\",\"classify_redis_redis配置文件解析.md\":\"79813640\",\"classify_redis_redis集群.md\":\"dd33bc1b\",\"classify_sundry_tools_git_github 连接失败.md\":\"4c965bdd\",\"classify_sundry_tools_vscode_vscode 启动 debug.md\":\"3f6f9d8d\",\"classify_框架学习_laravel_artisan控制台命令.md\":\"1e609895\",\"classify_框架学习_laravel_生命周期相关核心概念.md\":\"f12d2275\",\"classify_解决方案_redis主从存在的问题和解决方案.md\":\"3a9e954f\",\"classify_解决方案_数据库与缓存一致性解决方案.md\":\"92ded5fb\",\"classify_计算机基础_计算机网络_io模型.md\":\"64f0e1b4\",\"classify_计算机基础_计算机网络_index.md\":\"5ec4106e\",\"index.md\":\"a4622366\",\"preface_install.md\":\"13380ab4\",\"preface_preface.md\":\"5c592921\",\"学习网址.md\":\"57752ab6\",\"网站常用.md\":\"7052ae2b\"}")</script>
    <script type="module" async src="/guo-notes/assets/app.6bd15930.js"></script>
    
  </body>
</html>