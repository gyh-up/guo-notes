<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pod详解 | 技术博客，知识分享，学习笔记，问题解决方案</title>
    <meta name="description" content="啊郭的博客">
    <link rel="stylesheet" href="/guo-notes/assets/style.5e0eda6f.css">
    <link rel="modulepreload" href="/guo-notes/assets/app.b8d26054.js">
    <link rel="modulepreload" href="/guo-notes/assets/classify_Kubernetes_Pod详解.md.a35a70c3.lean.js">
    
    <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance"),a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-c6a644e1><!--[--><!--]--><!--[--><span tabindex="-1" data-v-151f2593></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-151f2593> Skip to content </a><!--]--><!----><header class="VPNav" data-v-c6a644e1 data-v-a71a30f1><div class="VPNavBar has-sidebar" data-v-a71a30f1 data-v-6f1d18b5><div class="container" data-v-6f1d18b5><div class="VPNavBarTitle has-sidebar" data-v-6f1d18b5 data-v-d5925166><a class="title" href="/guo-notes/" data-v-d5925166><!--[--><!--]--><!----><!--[-->啊郭的博客<!--]--><!--[--><!--]--></a></div><div class="content" data-v-6f1d18b5><!--[--><!--]--><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-6f1d18b5 data-v-f83db6ba><span id="main-nav-aria-label" class="visually-hidden" data-v-f83db6ba>Main Navigation</span><!--[--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-f83db6ba data-v-6ffb57d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-6ffb57d3><span class="text" data-v-6ffb57d3><!----> 后端技术 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-6ffb57d3><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-6ffb57d3><div class="VPMenu" data-v-6ffb57d3 data-v-1c5d0cfc><div class="items" data-v-1c5d0cfc><!--[--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/Redis/redis%E4%BB%8B%E7%BB%8D.html" data-v-e8e0fb1d data-v-3c355974><!--[-->Redis<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/mysql/mysql%E4%BB%8B%E7%BB%8D.html" data-v-e8e0fb1d data-v-3c355974><!--[-->Mysql<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/RabbitMq/MQ%E7%9A%84%E6%A6%82%E5%BF%B5.html" data-v-e8e0fb1d data-v-3c355974><!--[-->RabbitMq<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/Docker/Docker%E4%BB%8B%E7%BB%8D.html" data-v-e8e0fb1d data-v-3c355974><!--[-->Docker<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/Kubernetes/Kubernetes%E4%BB%8B%E7%BB%8D.html" data-v-e8e0fb1d data-v-3c355974><!--[-->Kubernetes<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-f83db6ba data-v-6ffb57d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-6ffb57d3><span class="text" data-v-6ffb57d3><!----> 计算机基础 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-6ffb57d3><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-6ffb57d3><div class="VPMenu" data-v-6ffb57d3 data-v-1c5d0cfc><div class="items" data-v-1c5d0cfc><!--[--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--[--><div class="VPMenuLink" data-v-9ca52130 data-v-e8e0fb1d><a class="VPLink link" href="/guo-notes/classify/计算机基础/计算机网络/" data-v-e8e0fb1d data-v-3c355974><!--[-->计算机网络<!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/guo-notes/classify/algorithm/" data-v-f83db6ba data-v-47a2263e data-v-3c355974><!--[-->算法<!--]--><!----></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-f83db6ba data-v-6ffb57d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-6ffb57d3><span class="text" data-v-6ffb57d3><!----> 杂项 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-6ffb57d3><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-6ffb57d3><div class="VPMenu" data-v-6ffb57d3 data-v-1c5d0cfc><div class="items" data-v-1c5d0cfc><!--[--><!--[--><div class="VPMenuGroup" data-v-1c5d0cfc data-v-9ca52130><!----><!--[--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-6f1d18b5 data-v-a3e7452b><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-a3e7452b data-v-1899cd41 data-v-086e8519><span class="check" data-v-086e8519><span class="icon" data-v-086e8519><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-1899cd41><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-1899cd41><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-6f1d18b5 data-v-738bef5a data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/gyh-up?tab=repositories" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink" href="https://blog.csdn.net/weixin_42258523?spm=1000.2115.3001.5343" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><embed src="https://g.csdnimg.cn/static/logo/favicon32.ico" style="border-radius: 100%;width: 20px;height: 20px;" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-6f1d18b5 data-v-e4361c82 data-v-6ffb57d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-6ffb57d3><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-6ffb57d3><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-6ffb57d3><div class="VPMenu" data-v-6ffb57d3 data-v-1c5d0cfc><!----><!--[--><!--[--><!----><div class="group" data-v-e4361c82><div class="item appearance" data-v-e4361c82><p class="label" data-v-e4361c82>Appearance</p><div class="appearance-action" data-v-e4361c82><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-e4361c82 data-v-1899cd41 data-v-086e8519><span class="check" data-v-086e8519><span class="icon" data-v-086e8519><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-1899cd41><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-1899cd41><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-e4361c82><div class="item social-links" data-v-e4361c82><div class="VPSocialLinks social-links-list" data-v-e4361c82 data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/gyh-up?tab=repositories" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink" href="https://blog.csdn.net/weixin_42258523?spm=1000.2115.3001.5343" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><embed src="https://g.csdnimg.cn/static/logo/favicon32.ico" style="border-radius: 100%;width: 20px;height: 20px;" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6f1d18b5 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-c6a644e1 data-v-aac27d5e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-aac27d5e><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-aac27d5e><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-aac27d5e>Menu</span></button><a class="top-link" href="#" data-v-aac27d5e> Return to top </a></div><aside class="VPSidebar" data-v-c6a644e1 data-v-f332cb62><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-f332cb62><span class="visually-hidden" id="sidebar-aria-label" data-v-f332cb62> Sidebar Navigation </span><!--[--><div class="group" data-v-f332cb62><section class="VPSidebarGroup collapsible" data-v-f332cb62 data-v-35f99ef5><div class="title" role="button" data-v-35f99ef5><h2 class="title-text" data-v-35f99ef5>Kubernetes</h2><div class="action" data-v-35f99ef5><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-35f99ef5><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-35f99ef5><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-35f99ef5><!--[--><!--[--><a class="VPLink link link" href="/guo-notes/classify/Kubernetes/Kubernetes%E4%BB%8B%E7%BB%8D.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>一、Kubernetes介绍</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/Kubernetes/Kubernetes%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>二、Kubernetes集群环境搭建</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/Kubernetes/Kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>三、Kubernetes资源管理</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/Kubernetes/Kubernetes%E5%AE%9E%E6%88%98%E5%85%A5%E9%97%A8.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>四、Kubernetes实战入门</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link active" href="/guo-notes/classify/Kubernetes/Pod%E8%AF%A6%E8%A7%A3.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>五、Pod详解</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/Kubernetes/Pod%E6%8E%A7%E5%88%B6%E5%99%A8%E8%AF%A6%E8%A7%A3.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>六、Pod控制器详解</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/Kubernetes/Service%E8%AF%A6%E8%A7%A3.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>七、Service详解</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/Kubernetes/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>八、数据存储</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/Kubernetes/%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>九、安全认证</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/guo-notes/classify/Kubernetes/DashBoard.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>十、DashBoard</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-c6a644e1 data-v-c95df128><div class="VPDoc has-sidebar has-aside" data-v-c95df128 data-v-37ebe389><div class="container" data-v-37ebe389><div class="aside" data-v-37ebe389><div class="aside-curtain" data-v-37ebe389></div><div class="aside-container" data-v-37ebe389><div class="aside-content" data-v-37ebe389><div class="VPDocAside" data-v-37ebe389 data-v-afc4c1a1><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-afc4c1a1 data-v-2865c0b0><div class="content" data-v-2865c0b0><div class="outline-marker" data-v-2865c0b0></div><div class="outline-title" data-v-2865c0b0>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-2865c0b0><span class="visually-hidden" id="doc-outline-aria-label" data-v-2865c0b0> Table of Contents for current page </span><ul class="root" data-v-2865c0b0 data-v-1188541a><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-afc4c1a1></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-37ebe389><div class="content-container" data-v-37ebe389><!--[--><!--]--><main class="main" data-v-37ebe389><div style="position:relative;" class="vp-doc _guo-notes_classify_Kubernetes_Pod%E8%AF%A6%E8%A7%A3" data-v-37ebe389><div><h1 id="pod详解" tabindex="-1">Pod详解 <a class="header-anchor" href="#pod详解" aria-hidden="true">#</a></h1><h2 id="一、pod介绍" tabindex="-1">一、Pod介绍 <a class="header-anchor" href="#一、pod介绍" aria-hidden="true">#</a></h2><h2 id="_1、pod结构" tabindex="-1">1、Pod结构 <a class="header-anchor" href="#_1、pod结构" aria-hidden="true">#</a></h2><p><img src="/guo-notes/kubenetes/image-20200407121501907-1626781151898.png" alt="image-20200407121501907"></p><p>每个Pod中都可以包含一个或者多个容器，这些容器可以分为两类：</p><ul><li><p>用户程序所在的容器，数量可多可少</p></li><li><p>Pause容器，这是每个Pod都会有的一个<strong>根容器</strong>，它的作用有两个：</p><ul><li><p>可以以它为依据，评估整个Pod的健康状态</p></li><li><p>可以在根容器上设置Ip地址，其它容器都此Ip（Pod IP），以实现Pod内部的网路通信</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">这里是Pod内部的通讯，Pod的之间的通讯采用虚拟二层网络技术来实现，我们当前环境用的是Flannel</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul></li></ul><h2 id="_2、pod定义" tabindex="-1">2、Pod定义 <a class="header-anchor" href="#_2、pod定义" aria-hidden="true">#</a></h2><p>下面是Pod的资源清单：</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">#必选，版本号，例如v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span><span style="color:#A6ACCD;">       　 </span><span style="color:#676E95;">#必选，资源类型，例如 Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">       　 </span><span style="color:#676E95;">#必选，元数据</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">#必选，Pod名称</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">#Pod所属的命名空间,默认为&quot;default&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">labels</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">       　　  </span><span style="color:#676E95;">#自定义标签列表</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;">      　          </span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">#必选，Pod中容器的详细定义</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">#必选，Pod中容器列表</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">#必选，容器名称</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">#必选，容器的镜像名称</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">imagePullPolicy</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Always|Never|IfNotPresent</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">#获取镜像的策略 </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">command</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#C3E88D;">string</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">#容器的启动命令列表，如不指定，使用打包时使用的启动命令</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">args</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#C3E88D;">string</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;">#容器的启动命令参数列表</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">workingDir</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">#容器的工作目录</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">volumeMounts</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">       </span><span style="color:#676E95;">#挂载到容器内部的存储卷配置</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;">#引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">mountPath</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#存储卷在容器内mount的绝对路径，应少于512字符</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">readOnly</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#是否为只读模式</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#需要暴露的端口库号列表</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;">        </span><span style="color:#676E95;">#端口的名称</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">containerPort</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">int</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">#容器需要监听的端口号</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">hostPort</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">int</span><span style="color:#A6ACCD;">       </span><span style="color:#676E95;">#容器所在主机需要监听的端口号，默认与Container相同</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">protocol</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">#端口协议，支持TCP和UDP，默认TCP</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">env</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">#容器运行前需设置的环境变量列表</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">#环境变量名称</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#环境变量的值</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">resources</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#资源限制和请求的设置</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">limits</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">#资源限制的设置</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">cpu</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">#Cpu的限制，单位为core数，将用于docker run --cpu-shares参数</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">memory</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">#内存限制，单位可以为Mib/Gib，将用于docker run --memory参数</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">requests</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#资源请求的设置</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">cpu</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">#Cpu请求，容器启动的初始可用数量</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">memory</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#内存请求,容器启动的初始可用数量</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">lifecycle</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#生命周期钩子</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">postStart</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#容器启动后立即执行此钩子,如果执行失败,会根据重启策略进行重启</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">preStop</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#容器终止前执行此钩子,无论结果如何,容器都会终止</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">livenessProbe</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">#对Pod内各容器健康检查的设置，当探测无响应几次后将自动重启该容器</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">exec</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">       　 </span><span style="color:#676E95;">#对Pod容器内检查方式设置为exec方式</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">command</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#C3E88D;">string</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">#exec方式需要制定的命令或脚本</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">httpGet</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">       </span><span style="color:#676E95;">#对Pod内个容器健康检查方法设置为HttpGet，需要制定Path、port</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">number</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">scheme</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">HttpHeaders</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">tcpSocket</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;">#对Pod内个容器健康检查方式设置为tcpSocket方式</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#F07178;">port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">number</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">initialDelaySeconds</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">       </span><span style="color:#676E95;">#容器启动完成后首次探测的时间，单位为秒</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">timeoutSeconds</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">    　　    </span><span style="color:#676E95;">#对容器健康检查探测等待响应的超时时间，单位秒，默认1秒</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">periodSeconds</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">     　　    </span><span style="color:#676E95;">#对容器监控检查的定期探测时间设置，单位秒，默认10秒一次</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">successThreshold</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">failureThreshold</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F07178;">securityContext</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#F07178;">privileged</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">restartPolicy</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#C3E88D;">Always | Never | OnFailure</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">#Pod的重启策略</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">nodeName</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">&lt;string&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#设置NodeName表示将该Pod调度到指定到名称的node节点上</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">nodeSelector</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">obeject</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#设置NodeSelector表示将该Pod调度到包含这个label的node上</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">imagePullSecrets</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#Pull镜像时使用的secret名称，以key：secretkey格式指定</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">hostNetwork</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">#是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">volumes</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">#在该pod上定义共享存储卷列表</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">#共享存储卷名称 （volumes类型有很多种）</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">emptyDir</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span><span style="color:#A6ACCD;">       </span><span style="color:#676E95;">#类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">hostPath</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;">#类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;">      　　        </span><span style="color:#676E95;">#Pod所在宿主机的目录，将被用于同期中mount的目录</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">secret</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">       　　　#</span><span style="color:#C3E88D;">类型为secret的存储卷，挂载集群与定义的secret对象到容器内部</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">scretname</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">items</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">key</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">configMap</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">         </span><span style="color:#676E95;">#类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">items</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">key</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">string</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#676E95;">#小提示：</span></span>
<span class="line"><span style="color:#676E95;">#   在这里，可通过一个命令来查看每种资源的可配置项</span></span>
<span class="line"><span style="color:#676E95;">#   kubectl explain 资源类型         查看某种资源可以配置的一级属性</span></span>
<span class="line"><span style="color:#676E95;">#   kubectl explain 资源类型.属性     查看属性的子属性</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#C3E88D;">root@k8s-master01 ~</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"># </span><span style="color:#C3E88D;">kubectl explain pod</span></span>
<span class="line"><span style="color:#F07178;">KIND</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">VERSION</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">FIELDS</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">apiVersion   &lt;string&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">kind &lt;string&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">metadata     &lt;Object&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">spec &lt;Object&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">status       &lt;Object&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#C3E88D;">root@k8s-master01 ~</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"># </span><span style="color:#C3E88D;">kubectl explain pod.metadata</span></span>
<span class="line"><span style="color:#F07178;">KIND</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">VERSION</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">RESOURCE</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">metadata &lt;Object&gt;</span></span>
<span class="line"><span style="color:#F07178;">FIELDS</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">annotations  &lt;map[string]string&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">clusterName  &lt;string&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">creationTimestamp    &lt;string&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">deletionGracePeriodSeconds   &lt;integer&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">deletionTimestamp    &lt;string&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">finalizers   &lt;[]string&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">generateName &lt;string&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">generation   &lt;integer&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">labels       &lt;map[string]string&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">managedFields        &lt;[]Object&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">name &lt;string&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">namespace    &lt;string&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">ownerReferences      &lt;[]Object&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">resourceVersion      &lt;string&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">selfLink     &lt;string&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">uid  &lt;string&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>在kubernetes中基本所有资源的一级属性都是一样的，主要包含5部分：</p><ul><li><code>apiVersion &lt;string&gt;</code> 版本，由kubernetes内部定义，版本号必须可以用 kubectl api-versions 查询到</li><li><code>kind &lt;string&gt;</code> 类型，由kubernetes内部定义，版本号必须可以用 kubectl api-resources 查询到</li><li><code>metadata &lt;Object&gt;</code> 元数据，主要是资源标识和说明，常用的有name、namespace、labels等</li><li><code>spec &lt;Object&gt;</code> 描述，这是配置中最重要的一部分，里面是对各种资源配置的详细描述</li><li><code>status &lt;Object&gt;</code> 状态信息，里面的内容不需要定义，由kubernetes自动生成</li></ul><p>在上面的属性中，spec是接下来研究的重点，继续看下它的常见子属性:</p><ul><li><code>containers &lt;[]Object&gt;</code> 容器列表，用于定义容器的详细信息</li><li><code>nodeName &lt;String&gt;</code> 根据nodeName的值将pod调度到指定的Node节点上</li><li><code>nodeSelector &lt;map[]&gt;</code> 根据NodeSelector中定义的信息选择将该Pod调度到包含这些label的Node 上</li><li><code>hostNetwork &lt;boolean&gt;</code> 是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</li><li><code>volumes &lt;[]Object&gt;</code> 存储卷，用于定义Pod上面挂在的存储信息</li><li><code>restartPolicy &lt;string&gt;</code> 重启策略，表示Pod在遇到故障的时候的处理策略</li></ul><h2 id="二、pod配置" tabindex="-1">二、Pod配置 <a class="header-anchor" href="#二、pod配置" aria-hidden="true">#</a></h2><p>本小节主要来研究<code>pod.spec.containers</code>属性，这也是pod配置中最为关键的一项配置。</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl explain pod.spec.containers</span></span>
<span class="line"><span style="color:#A6ACCD;">KIND:     Pod</span></span>
<span class="line"><span style="color:#A6ACCD;">VERSION:  v1</span></span>
<span class="line"><span style="color:#A6ACCD;">RESOURCE: containers </span><span style="color:#89DDFF;">&lt;[]</span><span style="color:#A6ACCD;">Object</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;"># 数组，代表可以有多个容器</span></span>
<span class="line"><span style="color:#A6ACCD;">FIELDS:</span></span>
<span class="line"><span style="color:#A6ACCD;">   name  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">string</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;"># 容器名称</span></span>
<span class="line"><span style="color:#A6ACCD;">   image </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">string</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;"># 容器需要的镜像地址</span></span>
<span class="line"><span style="color:#A6ACCD;">   imagePullPolicy  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">string</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 镜像拉取策略 </span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#82AAFF;">command</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;[]</span><span style="color:#A6ACCD;">string</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 容器的启动命令列表，如不指定，使用打包时使用的启动命令</span></span>
<span class="line"><span style="color:#A6ACCD;">   args     </span><span style="color:#89DDFF;">&lt;[]</span><span style="color:#A6ACCD;">string</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 容器的启动命令需要的参数列表</span></span>
<span class="line"><span style="color:#A6ACCD;">   env      </span><span style="color:#89DDFF;">&lt;[]</span><span style="color:#A6ACCD;">Object</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 容器环境变量的配置</span></span>
<span class="line"><span style="color:#A6ACCD;">   ports    </span><span style="color:#89DDFF;">&lt;[]</span><span style="color:#A6ACCD;">Object</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">     </span><span style="color:#676E95;"># 容器需要暴露的端口号列表</span></span>
<span class="line"><span style="color:#A6ACCD;">   resources </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Object</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;"># 资源限制和资源请求的设置</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="_1、基本配置" tabindex="-1">1、基本配置 <a class="header-anchor" href="#_1、基本配置" aria-hidden="true">#</a></h2><p>创建pod-base.yaml文件，内容如下：</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-base</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">labels</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">user</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">heima</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">busybox</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">busybox:1.30</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><img src="/guo-notes/kubenetes/image-20210617223823675-1626781695411.png" alt="image-20210617223823675"></p><p>上面定义了一个比较简单Pod的配置，里面有两个容器：</p><ul><li>nginx：用1.17.1版本的nginx镜像创建，（nginx是一个轻量级web容器）</li><li>busybox：用1.30版本的busybox镜像创建，（busybox是一个小巧的linux命令集合）</li></ul><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 创建Pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 pod</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># kubectl apply -f pod-base.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-base created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看Pod状况</span></span>
<span class="line"><span style="color:#676E95;"># READY 1/2 : 表示当前Pod中有2个容器，其中1个准备就绪，1个未就绪</span></span>
<span class="line"><span style="color:#676E95;"># RESTARTS  : 重启次数，因为有1个容器故障了，Pod一直在重启试图恢复它</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 pod</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># kubectl get pod -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME       READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-base   1/2     Running   4          95s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 可以通过describe查看内部的详情</span></span>
<span class="line"><span style="color:#676E95;"># 此时已经运行起来了一个基本的Pod，虽然它暂时有问题</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 pod</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># kubectl describe pod pod-base -n dev</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="_2、镜像拉取" tabindex="-1">2、镜像拉取 <a class="header-anchor" href="#_2、镜像拉取" aria-hidden="true">#</a></h2><p>创建pod-imagepullpolicy.yaml文件，内容如下：</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-imagepullpolicy</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">imagePullPolicy</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Never</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 用于设置镜像拉取策略</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">busybox</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">busybox:1.30</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><img src="/guo-notes/kubenetes/image-20210617223923659.png" alt="image-20210617223923659"></p><p>imagePullPolicy，用于设置镜像拉取策略，kubernetes支持配置三种拉取策略：</p><ul><li>Always：总是从远程仓库拉取镜像（一直远程下载）</li><li>IfNotPresent：本地有则使用本地镜像，本地没有则从远程仓库拉取镜像（本地有就本地 本地没远程下载）</li><li>Never：只使用本地镜像，从不去远程仓库拉取，本地没有就报错 （一直使用本地）</li></ul><blockquote><p>默认值说明：</p><p>如果镜像tag为具体版本号， 默认策略是：IfNotPresent</p><p>如果镜像tag为：latest（最终版本） ，默认策略是always</p></blockquote><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 创建Pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 pod</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># kubectl create -f pod-imagepullpolicy.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-imagepullpolicy created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看Pod详情</span></span>
<span class="line"><span style="color:#676E95;"># 此时明显可以看到nginx镜像有一步Pulling image &quot;nginx:1.17.1&quot;的过程</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 pod</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># kubectl describe pod pod-imagepullpolicy -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">......</span></span>
<span class="line"><span style="color:#A6ACCD;">Events:</span></span>
<span class="line"><span style="color:#A6ACCD;">  Type     Reason     Age               From               Message</span></span>
<span class="line"><span style="color:#A6ACCD;">  ----     ------     ----              ----               -------</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Scheduled  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">unknown</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">         default-scheduler  Successfully assigned dev/pod-imagePullPolicy to node1</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Pulling    32s               kubelet, node1     Pulling image </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">nginx:1.17.1</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Pulled     26s               kubelet, node1     Successfully pulled image </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">nginx:1.17.1</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Created    26s               kubelet, node1     Created container nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Started    25s               kubelet, node1     Started container nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Pulled     7s </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x3 over 25s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  kubelet, node1     Container image </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">busybox:1.30</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> already present on machine</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Created    7s </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x3 over 25s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  kubelet, node1     Created container busybox</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Started    7s </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x3 over 25s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  kubelet, node1     Started container busybox</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="_3、启动命令" tabindex="-1">3、启动命令 <a class="header-anchor" href="#_3、启动命令" aria-hidden="true">#</a></h2><p>在前面的案例中，一直有一个问题没有解决，就是的busybox容器一直没有成功运行，那么到底是什么原因导致这个容器的故障呢？</p><p>原来busybox并不是一个程序，而是类似于一个工具类的集合，kubernetes集群启动管理后，它会自动关闭。解决方法就是让其一直在运行，这就用到了command配置。</p><p>创建pod-command.yaml文件，内容如下：</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-command</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">busybox</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">busybox:1.30</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">command</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/bin/sh</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">-c</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">touch /tmp/hello.txt;while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt; sleep 3; done;</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><img src="/guo-notes/kubenetes/image-20210617224457945.png" alt="image-20210617224457945"></p><p>command，用于在pod中的容器初始化完毕之后运行一个命令。</p><blockquote><p>稍微解释下上面命令的意思：</p><p>&quot;/bin/sh&quot;,&quot;-c&quot;, 使用sh执行命令</p><p>touch /tmp/hello.txt; 创建一个/tmp/hello.txt 文件</p><p>while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt; sleep 3; done; 每隔3秒向文件中写入当前时间</p></blockquote><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 创建Pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 pod</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># kubectl create  -f pod-command.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-command created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看Pod状态</span></span>
<span class="line"><span style="color:#676E95;"># 此时发现两个pod都正常运行了</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 pod</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># kubectl get pods pod-command -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME          READY   STATUS   RESTARTS   AGE</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-command   2/2     Runing   0          2s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 进入pod中的busybox容器，查看文件内容</span></span>
<span class="line"><span style="color:#676E95;"># 补充一个命令: kubectl exec  pod名称 -n 命名空间 -it -c 容器名称 /bin/sh  在容器内部执行命令</span></span>
<span class="line"><span style="color:#676E95;"># 使用这个命令就可以进入某个容器的内部，然后进行相关操作了</span></span>
<span class="line"><span style="color:#676E95;"># 比如，可以查看txt文件的内容</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 pod</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;"># kubectl exec pod-command -n dev -it -c busybox /bin/sh</span></span>
<span class="line"><span style="color:#A6ACCD;">/ </span><span style="color:#676E95;"># tail -f /tmp/hello.txt</span></span>
<span class="line"><span style="color:#A6ACCD;">14:44:19</span></span>
<span class="line"><span style="color:#A6ACCD;">14:44:22</span></span>
<span class="line"><span style="color:#A6ACCD;">14:44:25</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">特别说明：</span></span>
<span class="line"><span style="color:#A6ACCD;">    通过上面发现command已经可以完成启动命令和传递参数的功能，为什么这里还要提供一个args选项，用于传递参数呢?这其实跟docker有点关系，kubernetes中的command、args两项其实是实现覆盖Dockerfile中ENTRYPOINT的功能。</span></span>
<span class="line"><span style="color:#A6ACCD;"> 1 如果command和args均没有写，那么用Dockerfile的配置。</span></span>
<span class="line"><span style="color:#A6ACCD;"> 2 如果command写了，但args没有写，那么Dockerfile默认的配置会被忽略，执行输入的command</span></span>
<span class="line"><span style="color:#A6ACCD;"> 3 如果command没写，但args写了，那么Dockerfile中配置的ENTRYPOINT的命令会被执行，使用当前args的参数</span></span>
<span class="line"><span style="color:#A6ACCD;"> 4 如果command和args都写了，那么Dockerfile的配置被忽略，执行command并追加上args参数</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_4、环境变量" tabindex="-1">4、环境变量 <a class="header-anchor" href="#_4、环境变量" aria-hidden="true">#</a></h2><p>创建pod-env.yaml文件，内容如下：</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-env</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">busybox</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">busybox:1.30</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">command</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/bin/sh</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">-c</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">while true;do /bin/echo $(date +%T);sleep 60; done;</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">env</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 设置环境变量列表</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">username</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">admin</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">password</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">123456</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>env，环境变量，用于在pod中的容器设置环境变量。</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 创建Pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-env.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-env created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 进入容器，输出环境变量</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl exec pod-env -n dev -c busybox -it /bin/sh</span></span>
<span class="line"><span style="color:#A6ACCD;">/ </span><span style="color:#676E95;"># echo $username</span></span>
<span class="line"><span style="color:#A6ACCD;">admin</span></span>
<span class="line"><span style="color:#A6ACCD;">/ </span><span style="color:#676E95;"># echo $password</span></span>
<span class="line"><span style="color:#A6ACCD;">123456</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这种方式不是很推荐，推荐将这些配置单独存储在配置文件中，这种方式将在后面介绍。</p><h2 id="_5、端口设置" tabindex="-1">5、端口设置 <a class="header-anchor" href="#_5、端口设置" aria-hidden="true">#</a></h2><p>本小节来介绍容器的端口设置，也就是containers的ports选项。</p><p>首先看下ports支持的子选项：</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl explain pod.spec.containers.ports</span></span>
<span class="line"><span style="color:#A6ACCD;">KIND:     Pod</span></span>
<span class="line"><span style="color:#A6ACCD;">VERSION:  v1</span></span>
<span class="line"><span style="color:#A6ACCD;">RESOURCE: ports </span><span style="color:#89DDFF;">&lt;[]</span><span style="color:#A6ACCD;">Object</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">FIELDS:</span></span>
<span class="line"><span style="color:#A6ACCD;">   name         </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">string</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># 端口名称，如果指定，必须保证name在pod中是唯一的		</span></span>
<span class="line"><span style="color:#A6ACCD;">   containerPort</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">integer</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 容器要监听的端口(0&lt;x&lt;65536)</span></span>
<span class="line"><span style="color:#A6ACCD;">   hostPort     </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">integer</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 容器要在主机上公开的端口，如果设置，主机上只能运行容器的一个副本(一般省略) </span></span>
<span class="line"><span style="color:#A6ACCD;">   hostIP       </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">string</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># 要将外部端口绑定到的主机IP(一般省略)</span></span>
<span class="line"><span style="color:#A6ACCD;">   protocol     </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">string</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># 端口协议。必须是UDP、TCP或SCTP。默认为“TCP”。</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>接下来，编写一个测试案例，创建pod-ports.yaml</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-ports</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 设置容器暴露的端口列表</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-port</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">containerPort</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">protocol</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">TCP</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 创建Pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-ports.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-ports created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看pod</span></span>
<span class="line"><span style="color:#676E95;"># 在下面可以明显看到配置信息</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pod pod-ports -n dev -o yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">......</span></span>
<span class="line"><span style="color:#A6ACCD;">spec:</span></span>
<span class="line"><span style="color:#A6ACCD;">  containers:</span></span>
<span class="line"><span style="color:#A6ACCD;">  - image: nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">    imagePullPolicy: IfNotPresent</span></span>
<span class="line"><span style="color:#A6ACCD;">    name: nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    ports:</span></span>
<span class="line"><span style="color:#A6ACCD;">    - containerPort: 80</span></span>
<span class="line"><span style="color:#A6ACCD;">      name: nginx-port</span></span>
<span class="line"><span style="color:#A6ACCD;">      protocol: TCP</span></span>
<span class="line"><span style="color:#A6ACCD;">......</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>访问容器中的程序需要使用的是<code>Podip:containerPort</code></p><h2 id="_6、资源配额" tabindex="-1">6、资源配额 <a class="header-anchor" href="#_6、资源配额" aria-hidden="true">#</a></h2><p>容器中的程序要运行，肯定是要占用一定资源的，比如cpu和内存等，如果不对某个容器的资源做限制，那么它就可能吃掉大量资源，导致其它容器无法运行。针对这种情况，kubernetes提供了对内存和cpu的资源进行配额的机制，这种机制主要通过resources选项实现，他有两个子选项：</p><ul><li>limits：用于限制运行时容器的最大占用资源，当容器占用资源超过limits时会被终止，并进行重启</li><li>requests ：用于设置容器需要的最小资源，如果环境资源不够，容器将无法启动</li></ul><p>可以通过上面两个选项设置资源的上下限。</p><p>接下来，编写一个测试案例，创建pod-resources.yaml</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-resources</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">resources</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 资源配额</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">limits</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># 限制资源（上限）</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">cpu</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># CPU限制，单位是core数</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">memory</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">10Gi</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 内存限制</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">requests</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 请求资源（下限）</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">cpu</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># CPU限制，单位是core数</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">memory</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">10Mi</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># 内存限制</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>在这对cpu和memory的单位做一个说明：</p><ul><li>cpu：core数，可以为整数或小数</li><li>memory： 内存大小，可以使用Gi、Mi、G、M等形式</li></ul><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 运行Pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create  -f pod-resources.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-resources created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看发现pod运行正常</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pod pod-resources -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME            READY   STATUS    RESTARTS   AGE  </span></span>
<span class="line"><span style="color:#A6ACCD;">pod-resources   1/1     Running   0          39s   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 接下来，停止Pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl delete  -f pod-resources.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">pod-resources</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> deleted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 编辑pod，修改resources.requests.memory的值为10Gi</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># vim pod-resources.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 再次启动pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create  -f pod-resources.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-resources created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看Pod状态，发现Pod启动失败</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pod pod-resources -n dev -o wide</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME            READY   STATUS    RESTARTS   AGE          </span></span>
<span class="line"><span style="color:#A6ACCD;">pod-resources   0/1     Pending   0          20s    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看pod详情会发现，如下提示</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl describe pod pod-resources -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">......</span></span>
<span class="line"><span style="color:#A6ACCD;">Warning  FailedScheduling  35s   default-scheduler  0/3 nodes are available: 1 node</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> had taint {node-role.kubernetes.io/master: }, that the pod didn</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">t tolerate, 2 Insufficient memory.(内存不足)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h2 id="三、pod生命周期" tabindex="-1">三、Pod生命周期 <a class="header-anchor" href="#三、pod生命周期" aria-hidden="true">#</a></h2><p>我们一般将pod对象从创建至终的这段时间范围称为pod的生命周期，它主要包含下面的过程：</p><ul><li>pod创建过程</li><li>运行初始化容器（init container）过程</li><li>运行主容器（main container） <ul><li>容器启动后钩子（post start）、容器终止前钩子（pre stop）</li><li>容器的存活性探测（liveness probe）、就绪性探测（readiness probe）</li></ul></li><li>pod终止过程</li></ul><p><img src="/guo-notes/kubenetes/image-20200412111402706-1626782188724.png" alt="image-20200412111402706"></p><p>在整个生命周期中，Pod会出现5种<strong>状态</strong>（<strong>相位</strong>），分别如下：</p><ul><li>挂起（Pending）：apiserver已经创建了pod资源对象，但它尚未被调度完成或者仍处于下载镜像的过程中</li><li>运行中（Running）：pod已经被调度至某节点，并且所有容器都已经被kubelet创建完成</li><li>成功（Succeeded）：pod中的所有容器都已经成功终止并且不会被重启</li><li>失败（Failed）：所有容器都已经终止，但至少有一个容器终止失败，即容器返回了非0值的退出状态</li><li>未知（Unknown）：apiserver无法正常获取到pod对象的状态信息，通常由网络通信失败所导致</li></ul><h2 id="_1、创建和终止" tabindex="-1">1、创建和终止 <a class="header-anchor" href="#_1、创建和终止" aria-hidden="true">#</a></h2><p><strong>pod的创建过程</strong></p><ol><li><p>用户通过kubectl或其他api客户端提交需要创建的pod信息给apiServer</p></li><li><p>apiServer开始生成pod对象的信息，并将信息存入etcd，然后返回确认信息至客户端</p></li><li><p>apiServer开始反映etcd中的pod对象的变化，其它组件使用watch机制来跟踪检查apiServer上的变动</p></li><li><p>scheduler发现有新的pod对象要创建，开始为Pod分配主机并将结果信息更新至apiServer</p></li><li><p>node节点上的kubelet发现有pod调度过来，尝试调用docker启动容器，并将结果回送至apiServer</p></li><li><p>apiServer将接收到的pod状态信息存入etcd中</p><p><img src="/guo-notes/kubenetes/image-20200406184656917-1626782168787.png" alt="image-20200406184656917"></p></li></ol><p><strong>pod的终止过程</strong></p><ol><li>用户向apiServer发送删除pod对象的命令</li><li>apiServcer中的pod对象信息会随着时间的推移而更新，在宽限期内（默认30s），pod被视为dead</li><li>将pod标记为terminating状态</li><li>kubelet在监控到pod对象转为terminating状态的同时启动pod关闭过程</li><li>端点控制器监控到pod对象的关闭行为时将其从所有匹配到此端点的service资源的端点列表中移除</li><li>如果当前pod对象定义了preStop钩子处理器，则在其标记为terminating后即会以同步的方式启动执行</li><li>pod对象中的容器进程收到停止信号</li><li>宽限期结束后，若pod中还存在仍在运行的进程，那么pod对象会收到立即终止的信号</li><li>kubelet请求apiServer将此pod资源的宽限期设置为0从而完成删除操作，此时pod对于用户已不可见</li></ol><h2 id="_2、初始化容器" tabindex="-1">2、初始化容器 <a class="header-anchor" href="#_2、初始化容器" aria-hidden="true">#</a></h2><p>初始化容器是在pod的主容器启动之前要运行的容器，主要是做一些主容器的前置工作，它具有两大特征：</p><ol><li>初始化容器必须运行完成直至结束，若某初始化容器运行失败，那么kubernetes需要重启它直到成功完成</li><li>初始化容器必须按照定义的顺序执行，当且仅当前一个成功之后，后面的一个才能运行</li></ol><p>初始化容器有很多的应用场景，下面列出的是最常见的几个：</p><ul><li>提供主容器镜像中不具备的工具程序或自定义代码</li><li>初始化容器要先于应用容器串行启动并运行完成，因此可用于延后应用容器的启动直至其依赖的条件得到满足</li></ul><p>接下来做一个案例，模拟下面这个需求：</p><p>假设要以主容器来运行nginx，但是要求在运行nginx之前先要能够连接上mysql和redis所在服务器</p><p>为了简化测试，事先规定好mysql<code>(192.168.5.4)</code>和redis<code>(192.168.5.5)</code>服务器的地址</p><p>创建pod-initcontainer.yaml，内容如下：</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-initcontainer</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">main-container</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-port</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">containerPort</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">initContainers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test-mysql</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">busybox:1.30</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">command</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">sh</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">-c</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">until ping 192.168.5.14 -c 1 ; do echo waiting for mysql...; sleep 2; done;</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test-redis</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">busybox:1.30</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">command</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">sh</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">-c</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">until ping 192.168.5.15 -c 1 ; do echo waiting for reids...; sleep 2; done;</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 创建pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-initcontainer.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-initcontainer created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看pod状态</span></span>
<span class="line"><span style="color:#676E95;"># 发现pod卡在启动第一个初始化容器过程中，后面的容器不会运行</span></span>
<span class="line"><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">]</span><span style="color:#676E95;"># kubectl describe pod  pod-initcontainer -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">........</span></span>
<span class="line"><span style="color:#A6ACCD;">Events:</span></span>
<span class="line"><span style="color:#A6ACCD;">  Type    Reason     Age   From               Message</span></span>
<span class="line"><span style="color:#A6ACCD;">  ----    ------     ----  ----               -------</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal  Scheduled  49s   default-scheduler  Successfully assigned dev/pod-initcontainer to node1</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal  Pulled     48s   kubelet, node1     Container image </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">busybox:1.30</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> already present on machine</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal  Created    48s   kubelet, node1     Created container test-mysql</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal  Started    48s   kubelet, node1     Started container test-mysql</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 动态查看pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods pod-initcontainer -n dev -w</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME                             READY   STATUS     RESTARTS   AGE</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-initcontainer                0/1     Init:0/2   0          15s</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-initcontainer                0/1     Init:1/2   0          52s</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-initcontainer                0/1     Init:1/2   0          53s</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-initcontainer                0/1     PodInitializing   0          89s</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-initcontainer                1/1     Running           0          90s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 接下来新开一个shell，为当前服务器新增两个ip，观察pod的变化</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># ifconfig ens33:1 192.168.5.14 netmask 255.255.255.0 up</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># ifconfig ens33:2 192.168.5.15 netmask 255.255.255.0 up</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="_3、钩子函数" tabindex="-1">3、钩子函数 <a class="header-anchor" href="#_3、钩子函数" aria-hidden="true">#</a></h2><p>钩子函数能够感知自身生命周期中的事件，并在相应的时刻到来时运行用户指定的程序代码。</p><p>kubernetes在主容器的启动之后和停止之前提供了两个钩子函数：</p><ul><li>post start：容器创建之后执行，如果失败了会重启容器</li><li>pre stop ：容器终止之前执行，执行完成之后容器将成功终止，在其完成之前会阻塞删除容器的操作</li></ul><p>钩子处理器支持使用下面三种方式定义动作：</p><ul><li><p>Exec命令：在容器内执行一次命令</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#C3E88D;">……</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">lifecycle</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">postStart</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">exec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">command</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">cat</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/tmp/healthy</span></span>
<span class="line"><span style="color:#C3E88D;">……</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li><li><p>TCPSocket：在当前容器尝试访问指定的socket</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#C3E88D;">……</span><span style="color:#A6ACCD;">      </span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">lifecycle</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">postStart</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">tcpSocket</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">8080</span></span>
<span class="line"><span style="color:#C3E88D;">……</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li><li><p>HTTPGet：在当前容器中向某url发起http请求</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#C3E88D;">……</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">lifecycle</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">postStart</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">httpGet</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#URI地址</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#端口号</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">192.168.5.3</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#主机地址</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">scheme</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HTTP</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#支持的协议，http或者https</span></span>
<span class="line"><span style="color:#C3E88D;">……</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li></ul><p>接下来，以exec方式为例，演示下钩子函数的使用，创建pod-hook-exec.yaml文件，内容如下：</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-hook-exec</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">main-container</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-port</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">containerPort</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">lifecycle</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">postStart</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">exec</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 在容器启动的时候执行一个命令，修改掉nginx的默认首页内容</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">command</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/bin/sh</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">-c</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">echo postStart... &gt; /usr/share/nginx/html/index.html</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">preStop</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">exec</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 在容器停止之前停止nginx服务</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">command</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/usr/sbin/nginx</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">-s</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">quit</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 创建pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-hook-exec.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-hook-exec created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods  pod-hook-exec -n dev -o wide</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME           READY   STATUS     RESTARTS   AGE    IP            NODE    </span></span>
<span class="line"><span style="color:#A6ACCD;">pod-hook-exec  1/1     Running    0          29s    10.244.2.48   node2   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 访问pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># curl 10.244.2.48</span></span>
<span class="line"><span style="color:#A6ACCD;">postStart...</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="_4、容器探测" tabindex="-1">4、容器探测 <a class="header-anchor" href="#_4、容器探测" aria-hidden="true">#</a></h2><p>容器探测用于检测容器中的应用实例是否正常工作，是保障业务可用性的一种传统机制。如果经过探测，实例的状态不符合预期，那么kubernetes就会把该问题实例&quot; 摘除 &quot;，不承担业务流量。kubernetes提供了两种探针来实现容器探测，分别是：</p><ul><li>liveness probes：存活性探针，用于检测应用实例当前是否处于正常运行状态，如果不是，k8s会重启容器</li><li>readiness probes：就绪性探针，用于检测应用实例当前是否可以接收请求，如果不能，k8s不会转发流量</li></ul><blockquote><p>livenessProbe 决定是否重启容器，readinessProbe 决定是否将请求转发给容器。</p></blockquote><p>上面两种探针目前均支持三种探测方式：</p><ul><li><p>Exec命令：在容器内执行一次命令，如果命令执行的退出码为0，则认为程序正常，否则不正常</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#C3E88D;">……</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">livenessProbe</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">exec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">command</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">cat</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/tmp/healthy</span></span>
<span class="line"><span style="color:#C3E88D;">……</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li><li><p>TCPSocket：将会尝试访问一个用户容器的端口，如果能够建立这条连接，则认为程序正常，否则不正常</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#C3E88D;">……</span><span style="color:#A6ACCD;">      </span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">livenessProbe</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">tcpSocket</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">8080</span></span>
<span class="line"><span style="color:#C3E88D;">……</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li><li><p>HTTPGet：调用容器内Web应用的URL，如果返回的状态码在200和399之间，则认为程序正常，否则不正常</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#C3E88D;">……</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">livenessProbe</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">httpGet</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#URI地址</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#端口号</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">127.0.0.1</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#主机地址</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">scheme</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HTTP</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#支持的协议，http或者https</span></span>
<span class="line"><span style="color:#C3E88D;">……</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li></ul><p>下面以liveness probes为例，做几个演示：</p><p><strong>方式一：Exec</strong></p><p>创建pod-liveness-exec.yaml</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-liveness-exec</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-port</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">containerPort</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">livenessProbe</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">exec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">command</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/bin/cat</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/tmp/hello.txt</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 执行一个查看文件的命令</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>创建pod，观察效果</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 创建Pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-liveness-exec.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-liveness-exec created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看Pod详情</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl describe pods pod-liveness-exec -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">......</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Created    20s </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x2 over 50s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  kubelet, node1     Created container nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Started    20s </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x2 over 50s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  kubelet, node1     Started container nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Killing    20s                kubelet, node1     Container nginx failed liveness probe, will be restarted</span></span>
<span class="line"><span style="color:#A6ACCD;">  Warning  Unhealthy  0s </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x5 over 40s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">   kubelet, node1     Liveness probe failed: cat: can</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">t open </span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">/tmp/hello11.txt</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">: No such file or directory</span></span>
<span class="line"><span style="color:#C3E88D;">  </span></span>
<span class="line"><span style="color:#C3E88D;"># 观察上面的信息就会发现nginx容器启动之后就进行了健康检查</span></span>
<span class="line"><span style="color:#C3E88D;"># 检查失败之后，容器被kill掉，然后尝试进行重启（这是重启策略的作用，后面讲解）</span></span>
<span class="line"><span style="color:#C3E88D;"># 稍等一会之后，再观察pod信息，就可以看到RESTARTS不再是0，而是一直增长</span></span>
<span class="line"><span style="color:#C3E88D;">[root@k8s-master01 ~]# kubectl get pods pod-liveness-exec -n dev</span></span>
<span class="line"><span style="color:#C3E88D;">NAME                READY   STATUS             RESTARTS   AGE</span></span>
<span class="line"><span style="color:#C3E88D;">pod-liveness-exec   0/1     CrashLoopBackOff   2          3m19s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C3E88D;"># 当然接下来，可以修改成一个存在的文件，比如/tmp/hello.txt，再试，结果就正常了......</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>方式二：TCPSocket</strong></p><p>创建pod-liveness-tcpsocket.yaml</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-liveness-tcpsocket</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-port</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">containerPort</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">livenessProbe</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">tcpSocket</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">8080</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 尝试访问8080端口</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>创建pod，观察效果</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 创建Pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-liveness-tcpsocket.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-liveness-tcpsocket created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看Pod详情</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl describe pods pod-liveness-tcpsocket -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">......</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Scheduled  31s                            default-scheduler  Successfully assigned dev/pod-liveness-tcpsocket to node2</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Pulled     </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">invalid</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">                      kubelet, node2     Container image </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">nginx:1.17.1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> already present on machine</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Created    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">invalid</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">                      kubelet, node2     Created container nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Started    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">invalid</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">                      kubelet, node2     Started container nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">  Warning  Unhealthy  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">invalid</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x2 over </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">invalid</span><span style="color:#89DDFF;">&gt;)</span><span style="color:#A6ACCD;">  kubelet, node2     Liveness probe failed: dial tcp 10.244.2.44:8080: connect: connection refused</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#676E95;"># 观察上面的信息，发现尝试访问8080端口,但是失败了</span></span>
<span class="line"><span style="color:#676E95;"># 稍等一会之后，再观察pod信息，就可以看到RESTARTS不再是0，而是一直增长</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods pod-liveness-tcpsocket  -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME                     READY   STATUS             RESTARTS   AGE</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-liveness-tcpsocket   0/1     CrashLoopBackOff   2          3m19s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 当然接下来，可以修改成一个可以访问的端口，比如80，再试，结果就正常了......</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>方式三：HTTPGet</strong></p><p>创建pod-liveness-httpget.yaml</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-liveness-httpget</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-port</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">containerPort</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">livenessProbe</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">httpGet</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># 其实就是访问http://127.0.0.1:80/hello  </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">scheme</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HTTP</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#支持的协议，http或者https</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#端口号</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/hello</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#URI地址</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>创建pod，观察效果</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 创建Pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-liveness-httpget.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-liveness-httpget created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看Pod详情</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl describe pod pod-liveness-httpget -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">.......</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Pulled     6s </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x3 over 64s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  kubelet, node1     Container image </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">nginx:1.17.1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> already present on machine</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Created    6s </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x3 over 64s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  kubelet, node1     Created container nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Started    6s </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x3 over 63s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  kubelet, node1     Started container nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">  Warning  Unhealthy  6s </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x6 over 56s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  kubelet, node1     Liveness probe failed: HTTP probe failed with statuscode: 404</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Killing    6s </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x2 over 36s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  kubelet, node1     Container nginx failed liveness probe, will be restarted</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#676E95;"># 观察上面信息，尝试访问路径，但是未找到,出现404错误</span></span>
<span class="line"><span style="color:#676E95;"># 稍等一会之后，再观察pod信息，就可以看到RESTARTS不再是0，而是一直增长</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pod pod-liveness-httpget -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME                   READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-liveness-httpget   1/1     Running   5          3m17s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 当然接下来，可以修改成一个可以访问的路径path，比如/，再试，结果就正常了......</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>至此，已经使用liveness Probe演示了三种探测方式，但是查看livenessProbe的子属性，会发现除了这三种方式，还有一些其他的配置，在这里一并解释下：</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl explain pod.spec.containers.livenessProbe</span></span>
<span class="line"><span style="color:#A6ACCD;">FIELDS:</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#82AAFF;">exec</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Object</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">   tcpSocket    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Object</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   httpGet      </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">Object</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   initialDelaySeconds  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">integer</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># 容器启动后等待多少秒执行第一次探测</span></span>
<span class="line"><span style="color:#A6ACCD;">   timeoutSeconds       </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">integer</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># 探测超时时间。默认1秒，最小1秒</span></span>
<span class="line"><span style="color:#A6ACCD;">   periodSeconds        </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">integer</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># 执行探测的频率。默认是10秒，最小1秒</span></span>
<span class="line"><span style="color:#A6ACCD;">   failureThreshold     </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">integer</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># 连续探测失败多少次才被认定为失败。默认是3。最小值是1</span></span>
<span class="line"><span style="color:#A6ACCD;">   successThreshold     </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">integer</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># 连续探测成功多少次才被认定为成功。默认是1</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>下面稍微配置两个，演示下效果即可：</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#C3E88D;">root@k8s-master01 ~</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"># </span><span style="color:#C3E88D;">more pod-liveness-httpget.yaml</span></span>
<span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-liveness-httpget</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-port</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">containerPort</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">livenessProbe</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">httpGet</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">scheme</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HTTP</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">initialDelaySeconds</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">30</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 容器启动后30s开始探测</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">timeoutSeconds</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 探测超时时间为5s</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="_5、重启策略" tabindex="-1">5、重启策略 <a class="header-anchor" href="#_5、重启策略" aria-hidden="true">#</a></h2><p>在上一节中，一旦容器探测出现了问题，kubernetes就会对容器所在的Pod进行重启，其实这是由pod的重启策略决定的，pod的重启策略有 3 种，分别如下：</p><ul><li>Always ：容器失效时，自动重启该容器，这也是默认值。</li><li>OnFailure ： 容器终止运行且退出码不为0时重启</li><li>Never ： 不论状态为何，都不重启该容器</li></ul><p>重启策略适用于pod对象中的所有容器，首次需要重启的容器，将在其需要时立即进行重启，随后再次需要重启的操作将由kubelet延迟一段时间后进行，且反复的重启操作的延迟时长以此为10s、20s、40s、80s、160s和300s，300s是最大延迟时长。</p><p>创建pod-restartpolicy.yaml：</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-restartpolicy</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-port</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">containerPort</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">livenessProbe</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">httpGet</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">scheme</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HTTP</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/hello</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">restartPolicy</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Never</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 设置重启策略为Never</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>运行Pod测试</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 创建Pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-restartpolicy.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-restartpolicy created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看Pod详情，发现nginx容器失败</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl  describe pods pod-restartpolicy  -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">......</span></span>
<span class="line"><span style="color:#A6ACCD;">  Warning  Unhealthy  15s </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x3 over 35s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  kubelet, node1     Liveness probe failed: HTTP probe failed with statuscode: 404</span></span>
<span class="line"><span style="color:#A6ACCD;">  Normal   Killing    15s                kubelet, node1     Container nginx failed liveness probe</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#676E95;"># 多等一会，再观察pod的重启次数，发现一直是0，并未重启   </span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl  get pods pod-restartpolicy -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME                   READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-restartpolicy      0/1     Running   0          5min42s</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="四、pod调度" tabindex="-1">四、Pod调度 <a class="header-anchor" href="#四、pod调度" aria-hidden="true">#</a></h2><p>在默认情况下，一个Pod在哪个Node节点上运行，是由Scheduler组件采用相应的算法计算出来的，这个过程是不受人工控制的。但是在实际使用中，这并不满足的需求，因为很多情况下，我们想控制某些Pod到达某些节点上，那么应该怎么做呢？这就要求了解kubernetes对Pod的调度规则，kubernetes提供了四大类调度方式：</p><ul><li>自动调度：运行在哪个节点上完全由Scheduler经过一系列的算法计算得出</li><li>定向调度：NodeName、NodeSelector</li><li>亲和性调度：NodeAffinity、PodAffinity、PodAntiAffinity</li><li>污点（容忍）调度：Taints、Toleration</li></ul><h2 id="_1、定向调度" tabindex="-1">1、定向调度 <a class="header-anchor" href="#_1、定向调度" aria-hidden="true">#</a></h2><p>定向调度，指的是利用在pod上声明nodeName或者nodeSelector，以此将Pod调度到期望的node节点上。注意，这里的调度是强制的，这就意味着即使要调度的目标Node不存在，也会向上面进行调度，只不过pod运行失败而已。</p><p><strong>NodeName</strong></p><p>NodeName用于强制约束将Pod调度到指定的Name的Node节点上。这种方式，其实是直接跳过Scheduler的调度逻辑，直接将Pod调度到指定名称的节点。</p><p>接下来，实验一下：创建一个pod-nodename.yaml文件</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-nodename</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">nodeName</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node1</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 指定调度到node1节点上</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;">#创建Pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-nodename.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-nodename created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">#查看Pod调度到NODE属性，确实是调度到了node1节点上</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods pod-nodename -n dev -o wide</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME           READY   STATUS    RESTARTS   AGE   IP            NODE      ......</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-nodename   1/1     Running   0          56s   10.244.1.87   node1     ......   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 接下来，删除pod，修改nodeName的值为node3（并没有node3节点）</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl delete -f pod-nodename.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">pod-nodename</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> deleted</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># vim pod-nodename.yaml</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-nodename.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-nodename created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">#再次查看，发现已经向Node3节点调度，但是由于不存在node3节点，所以pod无法正常运行</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods pod-nodename -n dev -o wide</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME           READY   STATUS    RESTARTS   AGE   IP       NODE    ......</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-nodename   0/1     Pending   0          6s    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   node3   ......           </span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>NodeSelector</strong></p><p>NodeSelector用于将pod调度到添加了指定标签的node节点上。它是通过kubernetes的label-selector机制实现的，也就是说，在pod创建之前，会由scheduler使用MatchNodeSelector调度策略进行label匹配，找出目标node，然后将pod调度到目标节点，该匹配规则是强制约束。</p><p>接下来，实验一下：</p><p>1 首先分别为node节点添加标签</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl label nodes node1 nodeenv=pro</span></span>
<span class="line"><span style="color:#A6ACCD;">node/node2 labeled</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl label nodes node2 nodeenv=test</span></span>
<span class="line"><span style="color:#A6ACCD;">node/node2 labeled</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>2 创建一个pod-nodeselector.yaml文件，并使用它创建Pod</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-nodeselector</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">nodeSelector</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">nodeenv</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pro</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 指定调度到具有nodeenv=pro标签的节点上</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;">#创建Pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-nodeselector.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-nodeselector created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">#查看Pod调度到NODE属性，确实是调度到了node1节点上</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods pod-nodeselector -n dev -o wide</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME               READY   STATUS    RESTARTS   AGE     IP          NODE    ......</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-nodeselector   1/1     Running   0          47s   10.244.1.87   node1   ......</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 接下来，删除pod，修改nodeSelector的值为nodeenv: xxxx（不存在打有此标签的节点）</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl delete -f pod-nodeselector.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">pod-nodeselector</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> deleted</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># vim pod-nodeselector.yaml</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-nodeselector.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-nodeselector created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">#再次查看，发现pod无法正常运行,Node的值为none</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods -n dev -o wide</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME               READY   STATUS    RESTARTS   AGE     IP       NODE    </span></span>
<span class="line"><span style="color:#A6ACCD;">pod-nodeselector   0/1     Pending   0          2m20s   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看详情,发现node selector匹配失败的提示</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl describe pods pod-nodeselector -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">.......</span></span>
<span class="line"><span style="color:#A6ACCD;">Events:</span></span>
<span class="line"><span style="color:#A6ACCD;">  Type     Reason            Age        From               Message</span></span>
<span class="line"><span style="color:#A6ACCD;">  ----     ------            ----       ----               -------</span></span>
<span class="line"><span style="color:#A6ACCD;">  Warning  FailedScheduling  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">unknown</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">  default-scheduler  0/3 nodes are available: 3 node</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> didn</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">t match node selector.</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="_2、亲和性调度" tabindex="-1">2、亲和性调度 <a class="header-anchor" href="#_2、亲和性调度" aria-hidden="true">#</a></h2><p>上一节，介绍了两种定向调度的方式，使用起来非常方便，但是也有一定的问题，那就是如果没有满足条件的Node，那么Pod将不会被运行，即使在集群中还有可用Node列表也不行，这就限制了它的使用场景。</p><p>基于上面的问题，kubernetes还提供了一种亲和性调度（Affinity）。它在NodeSelector的基础之上的进行了扩展，可以通过配置的形式，实现优先选择满足条件的Node进行调度，如果没有，也可以调度到不满足条件的节点上，使调度更加灵活。</p><p>Affinity主要分为三类：</p><ul><li>nodeAffinity(node亲和性）: 以node为目标，解决pod可以调度到哪些node的问题</li><li>podAffinity(pod亲和性) : 以pod为目标，解决pod可以和哪些已存在的pod部署在同一个拓扑域中的问题</li><li>podAntiAffinity(pod反亲和性) : 以pod为目标，解决pod不能和哪些已存在pod部署在同一个拓扑域中的问题</li></ul><blockquote><p>关于亲和性(反亲和性)使用场景的说明：</p><p><strong>亲和性</strong>：如果两个应用频繁交互，那就有必要利用亲和性让两个应用的尽可能的靠近，这样可以减少因网络通信而带来的性能损耗。</p><p><strong>反亲和性</strong>：当应用的采用多副本部署时，有必要采用反亲和性让各个应用实例打散分布在各个node上，这样可以提高服务的高可用性。</p></blockquote><p><strong>NodeAffinity</strong></p><p>首先来看一下<code>NodeAffinity</code>的可配置项：</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#A6ACCD;">pod.spec.affinity.nodeAffinity</span></span>
<span class="line"><span style="color:#A6ACCD;">  requiredDuringSchedulingIgnoredDuringExecution  Node节点必须满足指定的所有规则才可以，相当于硬限制</span></span>
<span class="line"><span style="color:#A6ACCD;">    nodeSelectorTerms  节点选择列表</span></span>
<span class="line"><span style="color:#A6ACCD;">      matchFields   按节点字段列出的节点选择器要求列表</span></span>
<span class="line"><span style="color:#A6ACCD;">      matchExpressions   按节点标签列出的节点选择器要求列表</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">推荐</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        key    键</span></span>
<span class="line"><span style="color:#A6ACCD;">        values 值</span></span>
<span class="line"><span style="color:#A6ACCD;">        operator 关系符 支持Exists, DoesNotExist, In, NotIn, Gt, Lt</span></span>
<span class="line"><span style="color:#A6ACCD;">  preferredDuringSchedulingIgnoredDuringExecution 优先调度到满足指定的规则的Node，相当于软限制 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">倾向</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    preference   一个节点选择器项，与相应的权重相关联</span></span>
<span class="line"><span style="color:#A6ACCD;">      matchFields   按节点字段列出的节点选择器要求列表</span></span>
<span class="line"><span style="color:#A6ACCD;">      matchExpressions   按节点标签列出的节点选择器要求列表</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">推荐</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        key    键</span></span>
<span class="line"><span style="color:#A6ACCD;">        values 值</span></span>
<span class="line"><span style="color:#A6ACCD;">        operator 关系符 支持In, NotIn, Exists, DoesNotExist, Gt, Lt</span></span>
<span class="line"><span style="color:#A6ACCD;">	weight 倾向权重，在范围1-100。</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#A6ACCD;">关系符的使用说明:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">- matchExpressions:</span></span>
<span class="line"><span style="color:#A6ACCD;">  - key: nodeenv              </span><span style="color:#676E95;"># 匹配存在标签的key为nodeenv的节点</span></span>
<span class="line"><span style="color:#A6ACCD;">    operator: Exists</span></span>
<span class="line"><span style="color:#A6ACCD;">  - key: nodeenv              </span><span style="color:#676E95;"># 匹配标签的key为nodeenv,且value是&quot;xxx&quot;或&quot;yyy&quot;的节点</span></span>
<span class="line"><span style="color:#A6ACCD;">    operator: In</span></span>
<span class="line"><span style="color:#A6ACCD;">    values: </span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xxx</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">yyy</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">  - key: nodeenv              </span><span style="color:#676E95;"># 匹配标签的key为nodeenv,且value大于&quot;xxx&quot;的节点</span></span>
<span class="line"><span style="color:#A6ACCD;">    operator: Gt</span></span>
<span class="line"><span style="color:#A6ACCD;">    values: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xxx</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>接下来首先演示一下<code>requiredDuringSchedulingIgnoredDuringExecution</code> ,</p><p>创建pod-nodeaffinity-required.yaml</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-nodeaffinity-required</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">affinity</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">#亲和性设置</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">nodeAffinity</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#设置node亲和性</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 硬限制</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">nodeSelectorTerms</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">matchExpressions</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">key</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nodeenv</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F07178;">operator</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">In</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F07178;">values</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xxx</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">yyy</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 创建pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-nodeaffinity-required.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-nodeaffinity-required created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看pod状态 （运行失败）</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods pod-nodeaffinity-required -n dev -o wide</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME                        READY   STATUS    RESTARTS   AGE   IP       NODE    ...... </span></span>
<span class="line"><span style="color:#A6ACCD;">pod-nodeaffinity-required   0/1     Pending   0          16s   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">  ......</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看Pod的详情</span></span>
<span class="line"><span style="color:#676E95;"># 发现调度失败，提示node选择失败</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl describe pod pod-nodeaffinity-required -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">......</span></span>
<span class="line"><span style="color:#A6ACCD;">  Warning  FailedScheduling  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">unknown</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">  default-scheduler  0/3 nodes are available: 3 node</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> didn</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">t match node selector.</span></span>
<span class="line"><span style="color:#C3E88D;">  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available: 3 node(s) didn</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">t match node selector.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">#接下来，停止pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl delete -f pod-nodeaffinity-required.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">pod-nodeaffinity-required</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> deleted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 修改文件，将values: [&quot;xxx&quot;,&quot;yyy&quot;]------&gt; [&quot;pro&quot;,&quot;yyy&quot;]</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># vim pod-nodeaffinity-required.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 再次启动</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-nodeaffinity-required.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-nodeaffinity-required created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 此时查看，发现调度成功，已经将pod调度到了node1上</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods pod-nodeaffinity-required -n dev -o wide</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME                        READY   STATUS    RESTARTS   AGE   IP            NODE  ...... </span></span>
<span class="line"><span style="color:#A6ACCD;">pod-nodeaffinity-required   1/1     Running   0          11s   10.244.1.89   node1 ......</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>接下来再演示一下<code>requiredDuringSchedulingIgnoredDuringExecution</code> ,</p><p>创建pod-nodeaffinity-preferred.yaml</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-nodeaffinity-preferred</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">affinity</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">#亲和性设置</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">nodeAffinity</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#设置node亲和性</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">preferredDuringSchedulingIgnoredDuringExecution</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 软限制</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">weight</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">preference</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">matchExpressions</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签(当前环境没有)</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">key</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nodeenv</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F07178;">operator</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">In</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F07178;">values</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xxx</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">yyy</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 创建pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-nodeaffinity-preferred.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-nodeaffinity-preferred created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看pod状态 （运行成功）</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pod pod-nodeaffinity-preferred -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME                         READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-nodeaffinity-preferred   1/1     Running   0          40s</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">NodeAffinity规则设置的注意事项：</span></span>
<span class="line"><span style="color:#A6ACCD;">    1 如果同时定义了nodeSelector和nodeAffinity，那么必须两个条件都得到满足，Pod才能运行在指定的Node上</span></span>
<span class="line"><span style="color:#A6ACCD;">    2 如果nodeAffinity指定了多个nodeSelectorTerms，那么只需要其中一个能够匹配成功即可</span></span>
<span class="line"><span style="color:#A6ACCD;">    3 如果一个nodeSelectorTerms中有多个matchExpressions ，则一个节点必须满足所有的才能匹配成功</span></span>
<span class="line"><span style="color:#A6ACCD;">    4 如果一个pod所在的Node在Pod运行期间其标签发生了改变，不再符合该Pod的节点亲和性需求，则系统将忽略此变化</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>PodAffinity</strong></p><p>PodAffinity主要实现以运行的Pod为参照，实现让新创建的Pod跟参照pod在一个区域的功能。</p><p>首先来看一下<code>PodAffinity</code>的可配置项：</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#A6ACCD;">pod.spec.affinity.podAffinity</span></span>
<span class="line"><span style="color:#A6ACCD;">  requiredDuringSchedulingIgnoredDuringExecution  硬限制</span></span>
<span class="line"><span style="color:#A6ACCD;">    namespaces       指定参照pod的namespace</span></span>
<span class="line"><span style="color:#A6ACCD;">    topologyKey      指定调度作用域</span></span>
<span class="line"><span style="color:#A6ACCD;">    labelSelector    标签选择器</span></span>
<span class="line"><span style="color:#A6ACCD;">      matchExpressions  按节点标签列出的节点选择器要求列表</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">推荐</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        key    键</span></span>
<span class="line"><span style="color:#A6ACCD;">        values 值</span></span>
<span class="line"><span style="color:#A6ACCD;">        operator 关系符 支持In, NotIn, Exists, DoesNotExist.</span></span>
<span class="line"><span style="color:#A6ACCD;">      matchLabels    指多个matchExpressions映射的内容</span></span>
<span class="line"><span style="color:#A6ACCD;">  preferredDuringSchedulingIgnoredDuringExecution 软限制</span></span>
<span class="line"><span style="color:#A6ACCD;">    podAffinityTerm  选项</span></span>
<span class="line"><span style="color:#A6ACCD;">      namespaces      </span></span>
<span class="line"><span style="color:#A6ACCD;">      topologyKey</span></span>
<span class="line"><span style="color:#A6ACCD;">      labelSelector</span></span>
<span class="line"><span style="color:#A6ACCD;">        matchExpressions  </span></span>
<span class="line"><span style="color:#A6ACCD;">          key    键</span></span>
<span class="line"><span style="color:#A6ACCD;">          values 值</span></span>
<span class="line"><span style="color:#A6ACCD;">          operator</span></span>
<span class="line"><span style="color:#A6ACCD;">        matchLabels </span></span>
<span class="line"><span style="color:#A6ACCD;">    weight 倾向权重，在范围1-100</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">topologyKey用于指定调度时作用域,例如:</span></span>
<span class="line"><span style="color:#A6ACCD;">    如果指定为kubernetes.io/hostname，那就是以Node节点为区分范围</span></span>
<span class="line"><span style="color:#A6ACCD;">	如果指定为beta.kubernetes.io/os,则以Node节点的操作系统类型来区分</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接下来，演示下<code>requiredDuringSchedulingIgnoredDuringExecution</code>,</p><p>1）首先创建一个参照Pod，pod-podaffinity-target.yaml：</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-podaffinity-target</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">labels</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">podenv</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pro</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#设置标签</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">nodeName</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node1</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 将目标pod名确指定到node1上</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 启动目标pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-podaffinity-target.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-podaffinity-target created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看pod状况</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods  pod-podaffinity-target -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME                     READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-podaffinity-target   1/1     Running   0          4s</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>2）创建pod-podaffinity-required.yaml，内容如下：</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-podaffinity-required</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">affinity</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">#亲和性设置</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">podAffinity</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#设置pod亲和性</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 硬限制</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">labelSelector</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">matchExpressions</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">key</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">podenv</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F07178;">operator</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">In</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F07178;">values</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xxx</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">yyy</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">topologyKey</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubernetes.io/hostname</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>上面配置表达的意思是：新Pod必须要与拥有标签nodeenv=xxx或者nodeenv=yyy的pod在同一Node上，显然现在没有这样pod，接下来，运行测试一下。</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 启动pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-podaffinity-required.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-podaffinity-required created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看pod状态，发现未运行</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods pod-podaffinity-required -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME                       READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-podaffinity-required   0/1     Pending   0          9s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看详细信息</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl describe pods pod-podaffinity-required  -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">......</span></span>
<span class="line"><span style="color:#A6ACCD;">Events:</span></span>
<span class="line"><span style="color:#A6ACCD;">  Type     Reason            Age        From               Message</span></span>
<span class="line"><span style="color:#A6ACCD;">  ----     ------            ----       ----               -------</span></span>
<span class="line"><span style="color:#A6ACCD;">  Warning  FailedScheduling  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">unknown</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">  default-scheduler  0/3 nodes are available: 2 node</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> didn</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">t match pod affinity rules, 1 node(s) had taints that the pod didn</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">t tolerate.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 接下来修改  values: [&quot;xxx&quot;,&quot;yyy&quot;]-----&gt;values:[&quot;pro&quot;,&quot;yyy&quot;]</span></span>
<span class="line"><span style="color:#676E95;"># 意思是：新Pod必须要与拥有标签nodeenv=xxx或者nodeenv=yyy的pod在同一Node上</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># vim pod-podaffinity-required.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 然后重新创建pod，查看效果</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl delete -f  pod-podaffinity-required.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">pod-podaffinity-required</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> deleted</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-podaffinity-required.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-podaffinity-required created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 发现此时Pod运行正常</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods pod-podaffinity-required -n dev</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME                       READY   STATUS    RESTARTS   AGE   LABELS</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-podaffinity-required   1/1     Running   0          6s    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>关于<code>PodAffinity</code>的 <code>preferredDuringSchedulingIgnoredDuringExecution</code>，这里不再演示。</p><p><strong>PodAntiAffinity</strong></p><p>PodAntiAffinity主要实现以运行的Pod为参照，让新创建的Pod跟参照pod不在一个区域中的功能。</p><p>它的配置方式和选项跟PodAffinty是一样的，这里不再做详细解释，直接做一个测试案例。</p><p>1）继续使用上个案例中目标pod</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods -n dev -o wide --show-labels</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME                     READY   STATUS    RESTARTS   AGE     IP            NODE    LABELS</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-podaffinity-required 1/1     Running   0          3m29s   10.244.1.38   node1   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">pod-podaffinity-target   1/1     Running   0          9m25s   10.244.1.37   node1   podenv=pro</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>2）创建pod-podantiaffinity-required.yaml，内容如下：</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-podantiaffinity-required</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">affinity</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">#亲和性设置</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">podAntiAffinity</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;">#设置pod亲和性</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 硬限制</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">labelSelector</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F07178;">matchExpressions</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 匹配podenv的值在[&quot;pro&quot;]中的标签</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">key</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">podenv</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F07178;">operator</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">In</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F07178;">values</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">pro</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">topologyKey</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubernetes.io/hostname</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>上面配置表达的意思是：新Pod必须要与拥有标签nodeenv=pro的pod不在同一Node上，运行测试一下。</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 创建pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl create -f pod-podantiaffinity-required.yaml</span></span>
<span class="line"><span style="color:#A6ACCD;">pod/pod-podantiaffinity-required created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查看pod</span></span>
<span class="line"><span style="color:#676E95;"># 发现调度到了node2上</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods pod-podantiaffinity-required -n dev -o wide</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME                           READY   STATUS    RESTARTS   AGE   IP            NODE   .. </span></span>
<span class="line"><span style="color:#A6ACCD;">pod-podantiaffinity-required   1/1     Running   0          30s   10.244.1.96   node2  ..</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="_3、污点和容忍" tabindex="-1">3、污点和容忍 <a class="header-anchor" href="#_3、污点和容忍" aria-hidden="true">#</a></h2><p><strong>污点（Taints）</strong></p><p>前面的调度方式都是站在Pod的角度上，通过在Pod上添加属性，来确定Pod是否要调度到指定的Node上，其实我们也可以站在Node的角度上，通过在Node上添加<strong>污点</strong>属性，来决定是否允许Pod调度过来。</p><p>Node被设置上污点之后就和Pod之间存在了一种相斥的关系，进而拒绝Pod调度进来，甚至可以将已经存在的Pod驱逐出去。</p><p>污点的格式为：<code>key=value:effect</code>, key和value是污点的标签，effect描述污点的作用，支持如下三个选项：</p><ul><li>PreferNoSchedule：kubernetes将尽量避免把Pod调度到具有该污点的Node上，除非没有其他节点可调度</li><li>NoSchedule：kubernetes将不会把Pod调度到具有该污点的Node上，但不会影响当前Node上已存在的Pod</li><li>NoExecute：kubernetes将不会把Pod调度到具有该污点的Node上，同时也会将Node上已存在的Pod驱离</li></ul><p><img src="/guo-notes/kubenetes/image-20200605021831545.png" alt="image-20200605021606508"></p><p>使用kubectl设置和去除污点的命令示例如下：</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 设置污点</span></span>
<span class="line"><span style="color:#A6ACCD;">kubectl taint nodes node1 key=value:effect</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 去除污点</span></span>
<span class="line"><span style="color:#A6ACCD;">kubectl taint nodes node1 key:effect-</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 去除所有污点</span></span>
<span class="line"><span style="color:#A6ACCD;">kubectl taint nodes node1 key-</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>接下来，演示下污点的效果：</p><ol><li>准备节点node1（为了演示效果更加明显，暂时停止node2节点）</li><li>为node1节点设置一个污点: <code>tag=heima:PreferNoSchedule</code>；然后创建pod1( pod1 可以 )</li><li>修改为node1节点设置一个污点: <code>tag=heima:NoSchedule</code>；然后创建pod2( pod1 正常 pod2 失败 )</li><li>修改为node1节点设置一个污点: <code>tag=heima:NoExecute</code>；然后创建pod3 ( 3个pod都失败 )</li></ol><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 为node1设置污点(PreferNoSchedule)</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl taint nodes node1 tag=heima:PreferNoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 创建pod1</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl run taint1 --image=nginx:1.17.1 -n dev</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods -n dev -o wide</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME                      READY   STATUS    RESTARTS   AGE     IP           NODE   </span></span>
<span class="line"><span style="color:#A6ACCD;">taint1-7665f7fd85-574h4   1/1     Running   0          2m24s   10.244.1.59   node1    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 为node1设置污点(取消PreferNoSchedule，设置NoSchedule)</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl taint nodes node1 tag:PreferNoSchedule-</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl taint nodes node1 tag=heima:NoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 创建pod2</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl run taint2 --image=nginx:1.17.1 -n dev</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods taint2 -n dev -o wide</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME                      READY   STATUS    RESTARTS   AGE     IP            NODE</span></span>
<span class="line"><span style="color:#A6ACCD;">taint1-7665f7fd85-574h4   1/1     Running   0          2m24s   10.244.1.59   node1 </span></span>
<span class="line"><span style="color:#A6ACCD;">taint2-544694789-6zmlf    0/1     Pending   0          21s     </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 为node1设置污点(取消NoSchedule，设置NoExecute)</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl taint nodes node1 tag:NoSchedule-</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl taint nodes node1 tag=heima:NoExecute</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 创建pod3</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl run taint3 --image=nginx:1.17.1 -n dev</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods -n dev -o wide</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME                      READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED </span></span>
<span class="line"><span style="color:#A6ACCD;">taint1-7665f7fd85-htkmp   0/1     Pending   0          35s   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">taint2-544694789-bn7wb    0/1     Pending   0          35s   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">taint3-6d78dbd749-tktkq   0/1     Pending   0          6s    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">     </span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">小提示：</span></span>
<span class="line"><span style="color:#A6ACCD;">    使用kubeadm搭建的集群，默认就会给master节点添加一个污点标记,所以pod就不会调度到master节点上.</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>容忍（Toleration）</strong></p><p>上面介绍了污点的作用，我们可以在node上添加污点用于拒绝pod调度上来，但是如果就是想将一个pod调度到一个有污点的node上去，这时候应该怎么做呢？这就要使用到<strong>容忍</strong>。</p><p><img src="/guo-notes/kubenetes/image-20200514095913741.png" alt="image-20200514095913741"></p><blockquote><p>污点就是拒绝，容忍就是忽略，Node通过污点拒绝pod调度上去，Pod通过容忍忽略拒绝</p></blockquote><p>下面先通过一个案例看下效果：</p><ol><li>上一小节，已经在node1节点上打上了<code>NoExecute</code>的污点，此时pod是调度不上去的</li><li>本小节，可以通过给pod添加容忍，然后将其调度上去</li></ol><p>创建pod-toleration.yaml,内容如下</p><div class="language-yaml line-numbers-mode"><button class="copy"></button><span class="lang">yaml</span><pre><code><span class="line"><span style="color:#F07178;">apiVersion</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1</span></span>
<span class="line"><span style="color:#F07178;">kind</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Pod</span></span>
<span class="line"><span style="color:#F07178;">metadata</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod-toleration</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">namespace</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dev</span></span>
<span class="line"><span style="color:#F07178;">spec</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">containers</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">tolerations</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;"># 添加容忍</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">key</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">tag</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">        </span><span style="color:#676E95;"># 要容忍的污点的key</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">operator</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Equal</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;"># 操作符</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">heima</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;"># 容忍的污点的value</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">effect</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">NoExecute</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;"># 添加容忍的规则，这里必须和标记的污点规则相同</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#676E95;"># 添加容忍之前的pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods -n dev -o wide</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME             READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED </span></span>
<span class="line"><span style="color:#A6ACCD;">pod-toleration   0/1     Pending   0          3s    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">           </span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 添加容忍之后的pod</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl get pods -n dev -o wide</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME             READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED</span></span>
<span class="line"><span style="color:#A6ACCD;">pod-toleration   1/1     Running   0          3s    10.244.1.62   node1   </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">none</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">        </span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>下面看一下容忍的详细配置:</p><div class="language-shell line-numbers-mode"><button class="copy"></button><span class="lang">shell</span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@k8s-master01 </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;"># kubectl explain pod.spec.tolerations</span></span>
<span class="line"><span style="color:#A6ACCD;">......</span></span>
<span class="line"><span style="color:#A6ACCD;">FIELDS:</span></span>
<span class="line"><span style="color:#A6ACCD;">   key       </span><span style="color:#676E95;"># 对应着要容忍的污点的键，空意味着匹配所有的键</span></span>
<span class="line"><span style="color:#A6ACCD;">   value     </span><span style="color:#676E95;"># 对应着要容忍的污点的值</span></span>
<span class="line"><span style="color:#A6ACCD;">   operator  </span><span style="color:#676E95;"># key-value的运算符，支持Equal和Exists（默认）</span></span>
<span class="line"><span style="color:#A6ACCD;">   effect    </span><span style="color:#676E95;"># 对应污点的effect，空意味着匹配所有影响</span></span>
<span class="line"><span style="color:#A6ACCD;">   tolerationSeconds   </span><span style="color:#676E95;"># 容忍时间, 当effect为NoExecute时生效，表示pod在Node上的停留时间</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></div></div></main><!--[--><!--]--><footer class="VPDocFooter" data-v-37ebe389 data-v-a54a85bd><div class="edit-info" data-v-a54a85bd><!----><div class="last-updated" data-v-a54a85bd><p class="VPLastUpdated" data-v-a54a85bd data-v-f7d51a9c>Last updated: <time datatime="2023-03-31T09:47:16.000Z" data-v-f7d51a9c></time></p></div></div><div class="prev-next" data-v-a54a85bd><div class="pager" data-v-a54a85bd><a class="pager-link prev" href="/guo-notes/classify/Kubernetes/Kubernetes%E5%AE%9E%E6%88%98%E5%85%A5%E9%97%A8.html" data-v-a54a85bd><span class="desc" data-v-a54a85bd>Previous page</span><span class="title" data-v-a54a85bd>四、Kubernetes实战入门</span></a></div><div class="has-prev pager" data-v-a54a85bd><a class="pager-link next" href="/guo-notes/classify/Kubernetes/Pod%E6%8E%A7%E5%88%B6%E5%99%A8%E8%AF%A6%E8%A7%A3.html" data-v-a54a85bd><span class="desc" data-v-a54a85bd>Next page</span><span class="title" data-v-a54a85bd>六、Pod控制器详解</span></a></div></div></footer><!--[--><!--]--></div></div></div></div></div><!----><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"classify_docker_docker compose服务编排.md\":\"e445a5cb\",\"classify_docker_dockerhub和私人仓库.md\":\"4e1c698b\",\"classify_docker_dockerfile.md\":\"77b91fc2\",\"classify_docker_docker介绍.md\":\"68fa130a\",\"classify_docker_docker命令.md\":\"9821f05f\",\"classify_docker_docker安装和启动.md\":\"4e231a99\",\"classify_docker_docker架构.md\":\"487b7aee\",\"classify_elasticsearch_elasticsearch介绍.md\":\"6f188e9a\",\"classify_elasticsearch_elasticsearch.md\":\"6dfcc0f5\",\"classify_kafka_kafka.md\":\"e45d2643\",\"classify_kubernetes_dashboard.md\":\"21f37a32\",\"classify_kubernetes_kubernetes介绍.md\":\"4937df2e\",\"classify_kubernetes_kubernetes实战入门.md\":\"5d54467f\",\"classify_kubernetes_kubernetes资源管理.md\":\"20b87e6d\",\"classify_kubernetes_kubernetes集群环境搭建.md\":\"11741ee9\",\"classify_kubernetes_pod控制器详解.md\":\"046d3063\",\"classify_kubernetes_pod详解.md\":\"a35a70c3\",\"classify_kubernetes_service详解.md\":\"2ffe9e36\",\"classify_kubernetes_安全认证.md\":\"bd3b0ef2\",\"classify_kubernetes_数据存储.md\":\"4fac1ffc\",\"classify_nginx_nginx.md\":\"95bae19d\",\"classify_rabbitmq_exchange核心概念.md\":\"4c25f3d1\",\"classify_rabbitmq_mq的概念.md\":\"aeadd502\",\"classify_rabbitmq_mq的种类和对比.md\":\"0b480ff9\",\"classify_rabbitmq_rabbitmq命令行.md\":\"387fdad6\",\"classify_rabbitmq_rabbitmq工作模式.md\":\"66f6d278\",\"classify_rabbitmq_rabbitmq应用方案.md\":\"0e7e9403\",\"classify_rabbitmq_rabbitmq的安装和启动.md\":\"4d75289f\",\"classify_rabbitmq_rabbitmq简介.md\":\"6f0b1a47\",\"classify_rabbitmq_rabbitmq管控台介绍.md\":\"58a5e31f\",\"classify_rabbitmq_rabbitmq集群搭建.md\":\"6a2895ef\",\"classify_rabbitmq_rabbitmq高级特性.md\":\"e6a2f97d\",\"classify_rabbitmq_rabbitmq高级特性1.md\":\"92fddb1b\",\"classify_redis_redis主从.md\":\"f137d510\",\"classify_redis_redis事务.md\":\"ec6ed2bb\",\"classify_redis_redis五大数据类型实现原理.md\":\"d0f84cf4\",\"classify_redis_redis介绍.md\":\"6984ad4d\",\"classify_redis_redis内存回收.md\":\"3853aa69\",\"classify_redis_redis内存淘汰策略.md\":\"45dbbdda\",\"classify_redis_redis内存碎片率.md\":\"0ade7f9a\",\"classify_redis_redis分布式锁.md\":\"94cb62f5\",\"classify_redis_redis哨兵.md\":\"f06c79ab\",\"classify_redis_redis底层数据结构.md\":\"be5dbb03\",\"classify_redis_redis慢查询和管道.md\":\"f475e99c\",\"classify_redis_redis持久化.md\":\"97f9cab7\",\"classify_redis_redis数据类型简介.md\":\"66aa81f3\",\"classify_redis_redis缓存击穿、穿透、雪崩.md\":\"58f74a8c\",\"classify_redis_redis配置文件解析.md\":\"711d175c\",\"classify_redis_redis集群.md\":\"fe44173c\",\"classify_algorithm_concept_复杂度-时间复杂度和空间复杂度.md\":\"43c21803\",\"classify_algorithm_concept_数据结构-堆.md\":\"1c7e86bc\",\"classify_algorithm_concept_数据结构-栈与队列.md\":\"9c2a5bfe\",\"classify_algorithm_concept_数据结构-树.md\":\"b7e27013\",\"classify_algorithm_concept_算法-排序算法.md\":\"f169d178\",\"classify_algorithm_concept_算法-查找算法.md\":\"ef252f2a\",\"classify_algorithm_concept_算法-深度优先搜索和广度优先搜索.md\":\"50c84be1\",\"classify_algorithm_index.md\":\"4d1a32c2\",\"classify_algorithm_title_leetcode-1.md\":\"153930d6\",\"classify_algorithm_title_leetcode-101.md\":\"1600583d\",\"classify_algorithm_title_leetcode-104.md\":\"71de9eee\",\"classify_algorithm_title_leetcode-110.md\":\"dd07c78f\",\"classify_algorithm_title_leetcode-141.md\":\"252e7829\",\"classify_algorithm_title_leetcode-142.md\":\"d3109add\",\"classify_algorithm_title_leetcode-144.md\":\"625b6d88\",\"classify_algorithm_title_leetcode-145.md\":\"bfc4487e\",\"classify_algorithm_title_leetcode-160.md\":\"94c8b1f5\",\"classify_algorithm_title_leetcode-206.md\":\"adfbb92d\",\"classify_algorithm_title_leetcode-21.md\":\"c7bf95a0\",\"classify_algorithm_title_leetcode-226.md\":\"292c659f\",\"classify_algorithm_title_leetcode-232.md\":\"fa8b3795\",\"classify_algorithm_title_leetcode-234.md\":\"9f5c9a8f\",\"classify_algorithm_title_leetcode-283.md\":\"196d90f5\",\"classify_algorithm_title_leetcode-394.md\":\"4700c24f\",\"classify_algorithm_title_leetcode-448.md\":\"41b4a2b7\",\"classify_algorithm_title_leetcode-70.md\":\"99263d85\",\"classify_algorithm_title_leetcode-83.md\":\"fb1d0c51\",\"classify_algorithm_title_leetcode-876.md\":\"b883f7ae\",\"classify_algorithm_title_leetcode-88.md\":\"5c1a20bb\",\"classify_algorithm_title_leetcode-912.md\":\"4e747625\",\"classify_algorithm_title_leetcode-94.md\":\"6638717d\",\"classify_algorithm_title_leetcode-模板.md\":\"62999d58\",\"classify_algorithm_title_剑指offer-22.md\":\"72157685\",\"classify_algorithm_其他-设计.md\":\"6b4dc8ad\",\"classify_algorithm_基础-排序.md\":\"30ccb915\",\"classify_algorithm_基础数据结构-哈希表.md\":\"83f0355e\",\"classify_algorithm_基础数据结构-字符串.md\":\"f596e5b2\",\"classify_algorithm_基础数据结构-数组.md\":\"efd2dd99\",\"classify_algorithm_基础数据结构-栈.md\":\"4470caee\",\"classify_algorithm_基础数据结构-树.md\":\"1924d507\",\"classify_algorithm_基础数据结构-链表.md\":\"6cc4e66f\",\"classify_algorithm_基础数据结构-队列.md\":\"d74da469\",\"classify_algorithm_技巧-双指针.md\":\"dc5dce83\",\"classify_algorithm_数学-斐波那契数列.md\":\"e9a865f0\",\"classify_algorithm_数学-相遇问题.md\":\"8ad92af4\",\"classify_algorithm_算法-动态规划.md\":\"385c3e37\",\"classify_algorithm_算法-广度优先搜索.md\":\"a317fb96\",\"classify_algorithm_算法-排序.md\":\"2d367fde\",\"classify_algorithm_算法-深度优先搜索.md\":\"2173630c\",\"classify_algorithm_算法-迭代.md\":\"b82fbeed\",\"classify_algorithm_算法-递归.md\":\"14258e25\",\"classify_mysql_mvcc多版本并发控制.md\":\"a6839cd7\",\"classify_mysql_mysql三大日志.md\":\"6fc271c6\",\"classify_mysql_mysql主从复制.md\":\"e23989cb\",\"classify_mysql_mysql事务.md\":\"74144553\",\"classify_mysql_mysql介绍.md\":\"16c0829c\",\"classify_mysql_mysql分区.md\":\"519fe261\",\"classify_mysql_mysql分库分表.md\":\"67a908ab\",\"classify_mysql_mysql索引.md\":\"aa5a5b98\",\"classify_mysql_mysql语法.md\":\"2cefde38\",\"classify_mysql_mysql读写分离.md\":\"6aaef7b1\",\"classify_mysql_mysql负载均衡和高可用.md\":\"a0d2d5e6\",\"classify_mysql_mysql锁.md\":\"faa5477c\",\"classify_mysql_sql语句优化.md\":\"9ed841f6\",\"classify_mysql_sql语句执行流程.md\":\"a2eb6fb7\",\"classify_mysql_存储引擎.md\":\"7126bd1f\",\"classify_mysql_性能分析.md\":\"7d45fd8e\",\"classify_mysql_物理文件.md\":\"7b86530c\",\"classify_mysql_管理常用工具.md\":\"3b8e8232\",\"classify_sundry_concept_存储单位与速率单位.md\":\"fcdd3a31\",\"classify_sundry_concept_性能指标.md\":\"736df057\",\"classify_sundry_tools_git_github 连接失败.md\":\"b364ad14\",\"classify_sundry_tools_vscode_vscode 启动 debug.md\":\"4415f68d\",\"classify_框架学习_laravel_artisan控制台命令.md\":\"3f027568\",\"classify_框架学习_laravel_生命周期相关核心概念.md\":\"e3a473a1\",\"classify_解决方案_redis主从存在的问题和解决方案.md\":\"10de02be\",\"classify_解决方案_数据库与缓存一致性解决方案.md\":\"86aaa18b\",\"classify_计算机基础_计算机网络_io模型.md\":\"f949c0d4\",\"classify_计算机基础_计算机网络_index.md\":\"70d7ba4a\",\"classify_设计模式.md\":\"85ec7b0a\",\"classify_面试常问_web安全.md\":\"0b3c474c\",\"classify_面试常问_一次网络请求的完整过程.md\":\"6e452cf1\",\"index.md\":\"24330e17\",\"preface_install.md\":\"907ef5ac\",\"preface_preface.md\":\"c3eeeef9\"}")</script>
    <script type="module" async src="/guo-notes/assets/app.b8d26054.js"></script>
    
  </body>
</html>